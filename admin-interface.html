<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Finder Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Checkbox styling */
        .form-group.checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group.checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            cursor: pointer;
        }

        .form-group.checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-row {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-full {
            width: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #333;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1em;
            opacity: 0.9;
        }

        /* Cards */
        .card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .card h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card p {
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .card a {
            color: #667eea;
            text-decoration: none;
        }

        .card a:hover {
            text-decoration: underline;
        }

        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-pending-review {
            background: #e2e3e5;
            color: #383d41;
        }

        .badge-mission-approved {
            background: #cce5ff;
            color: #004085;
        }

        .badge-mission-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-permission-requested {
            background: #fff3cd;
            color: #856404;
        }

        .badge-permission-granted {
            background: #d4edda;
            color: #155724;
        }

        .badge-permission-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-scraping-active {
            background: #28a745;
            color: white;
        }

        .badge-tou-flag {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .badge-scraping-enabled {
            background: #d4edda;
            color: #155724;
        }

        .badge-scraping-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Messages */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px 0;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.3em;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
        }

        .modal-body {
            padding: 25px;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.4em;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filters select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2>üîê Admin Login</h2>
            <div id="loginMessage" class="message hidden"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-full">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <h1>üîê Event Finder Admin</h1>
                <p>National Security Events Database Management</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="switchTab('pending')">üÜï Pending Review</button>
                <button class="tab" onclick="switchTab('organizations')">üèõÔ∏è Organizations</button>
                <button class="tab" onclick="switchTab('contacts')">üë§ Contacts</button>
                <button class="tab" onclick="switchTab('events')">üìÖ Events</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="statOrgs">-</h3>
                        <p>Total Organizations</p>
                    </div>
                    <div class="stat-card info">
                        <h3 id="statEvents">-</h3>
                        <p>Events</p>
                    </div>
                    <div class="stat-card warning">
                        <h3 id="statPending">-</h3>
                        <p>Pending Review</p>
                    </div>
                    <div class="stat-card success">
                        <h3 id="statScrapingActive">-</h3>
                        <p>Scraping Active</p>
                    </div>
                </div>

                <div class="section-header">
                    <h2>üìã Status Breakdown</h2>
                </div>

                <div id="dashboardContent">
                    <div class="loading">Loading dashboard...</div>
                </div>
            </div>

            <!-- Pending Review Tab -->
            <div id="pending" class="tab-content">
                <div class="section-header">
                    <h2>üÜï Pending Mission Review</h2>
                    <button class="btn" onclick="runAISuggestions()">ü§ñ Run AI Suggestions</button>
                </div>

                <div id="pendingMessage" class="message info hidden"></div>

                <div id="pendingList">
                    <div class="loading">Loading pending organizations...</div>
                </div>
            </div>

            <!-- Organizations Tab -->
            <div id="organizations" class="tab-content">
                <div class="section-header">
                    <h2>üèõÔ∏è All Organizations</h2>
                    <button class="btn" onclick="openAddOrgModal()">‚ûï Add Organization</button>
                </div>

                <div class="filters">
                    <select id="filterStatus" onchange="loadOrganizations()">
                        <option value="">All Statuses</option>
                        <option value="Pending Mission Review">üü£ Pending Mission Review</option>
                        <option value="Mission Approved Pending Permission">üü¢ Mission Approved</option>
                        <option value="Mission Rejected">‚ö´ Mission Rejected</option>
                        <option value="Permission Requested (Self)">üîµ Permission Requested (Self)</option>
                        <option value="Permission Requested (Lawyer)">üîµ Permission Requested (Lawyer)</option>
                        <option value="Permission Granted">üü¢ Permission Granted</option>
                        <option value="Permission Rejected">üî¥ Permission Rejected</option>
                        <option value="Scraping Active">‚úÖ Scraping Active</option>
                    </select>
                    <select id="filterScraping" onchange="loadOrganizations()">
                        <option value="">All Scraping Status</option>
                        <option value="true">‚úÖ Scraping Enabled</option>
                        <option value="false">‚ùå Scraping Disabled</option>
                    </select>
                </div>

                <div id="organizationsList">
                    <div class="loading">Loading organizations...</div>
                </div>
            </div>

            <!-- Contacts Tab -->
            <div id="contacts" class="tab-content">
                <div class="section-header">
                    <h2>üë§ Contacts</h2>
                    <button class="btn" onclick="openAddContactModal()">‚ûï Add Contact</button>
                </div>

                <div id="contactsList">
                    <div class="loading">Loading contacts...</div>
                </div>
            </div>

            <!-- Events Tab -->
            <div id="events" class="tab-content">
                <div class="section-header">
                    <h2>üìÖ Events</h2>
                </div>

                <div class="filters">
                    <select id="filterEventOrg" onchange="loadEvents()">
                        <option value="">All Organizations</option>
                    </select>
                </div>

                <div id="eventsList">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Organization Modal -->
    <div id="editOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editOrgModalTitle">Edit Organization</h2>
                <button class="modal-close" onclick="closeModal('editOrgModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editOrgForm">
                    <input type="hidden" id="editOrgId">

                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="editOrgName" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <input type="text" id="editOrgType" placeholder="e.g., Government, Nonprofit">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="editOrgWebsite">
                        </div>
                        <div class="form-group">
                            <label>Source ID (Domain)</label>
                            <input type="text" id="editOrgSourceId" placeholder="e.g., csis.org">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Events URL</label>
                            <input type="url" id="editOrgEventsUrl">
                        </div>
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="editOrgStatus" required>
                                <option value="Pending Mission Review">üü£ Pending Mission Review</option>
                                <option value="Mission Approved Pending Permission">üü¢ Mission Approved Pending Permission</option>
                                <option value="Mission Rejected">‚ö´ Mission Rejected</option>
                                <option value="Permission Requested (Self)">üîµ Permission Requested (Self)</option>
                                <option value="Permission Requested (Lawyer)">üîµ Permission Requested (Lawyer)</option>
                                <option value="Permission Granted">üü¢ Permission Granted</option>
                                <option value="Permission Rejected">üî¥ Permission Rejected</option>
                                <option value="Scraping Active">‚úÖ Scraping Active</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editOrgDescription"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Permission Requested Date</label>
                            <input type="date" id="editOrgPermissionRequestedDate">
                        </div>
                        <div class="form-group">
                            <label>Permission Response Date</label>
                            <input type="date" id="editOrgPermissionResponseDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Last Scraped</label>
                            <input type="text" id="editOrgLastScraped" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="form-group checkbox-group" style="align-self: end; padding-bottom: 12px;">
                            <label>
                                <input type="checkbox" id="editOrgScrapingEnabled">
                                Scraping Enabled
                            </label>
                        </div>
                    </div>

                    <div class="checkbox-row">
                        <div class="form-group checkbox-group">
                            <label>
                                <input type="checkbox" id="editOrgTouFlag">
                                ‚ö†Ô∏è TOU Flag (May prohibit scraping)
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>TOU Notes</label>
                        <textarea id="editOrgTouNotes" placeholder="Notes about Terms of Use..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>AI Reasoning</label>
                        <textarea id="editOrgAiReasoning" placeholder="Why AI suggested this org..." readonly style="background: #f0f0f0;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Permission Request Draft</label>
                        <textarea id="editOrgPermissionDraft" placeholder="Auto-generated permission request email..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Permission Correspondence</label>
                        <textarea id="editOrgPermissionCorrespondence" placeholder="Paste approval email here..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editOrgNotes"></textarea>
                    </div>

                    <div class="card-actions">
                        <button type="submit" class="btn btn-success">üíæ Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editOrgModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Contact</h2>
                <button class="modal-close" onclick="closeModal('addContactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addContactForm">
                    <div class="form-group">
                        <label>Organization *</label>
                        <select id="contactOrg" required>
                            <option value="">-- Select Organization --</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="contactName" required>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="contactTitle">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="contactEmail">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="contactPhone">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Contact Type</label>
                        <select id="contactType">
                            <option value="">-- Select --</option>
                            <option value="Leadership">Leadership</option>
                            <option value="Events">Events</option>
                            <option value="Legal/Permissions">Legal/Permissions</option>
                            <option value="Media/PR">Media/PR</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Source URL</label>
                        <input type="url" id="contactSourceUrl" placeholder="Where you found this contact info">
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="contactNotes"></textarea>
                    </div>

                    <div class="card-actions">
                        <button type="submit" class="btn btn-success">‚ûï Add Contact</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const POCKETBASE_URL = 'https://event-discovery-backend-production.up.railway.app';
        let authToken = '';

        // Status configuration
        const STATUS_CONFIG = {
            'Pending Mission Review': { badge: 'badge-pending-review', icon: 'üü£' },
            'Mission Approved Pending Permission': { badge: 'badge-mission-approved', icon: 'üü¢' },
            'Mission Rejected': { badge: 'badge-mission-rejected', icon: '‚ö´' },
            'Permission Requested (Self)': { badge: 'badge-permission-requested', icon: 'üîµ' },
            'Permission Requested (Lawyer)': { badge: 'badge-permission-requested', icon: 'üîµ' },
            'Permission Granted': { badge: 'badge-permission-granted', icon: 'üü¢' },
            'Permission Rejected': { badge: 'badge-permission-rejected', icon: 'üî¥' },
            'Scraping Active': { badge: 'badge-scraping-active', icon: '‚úÖ' }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTHENTICATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/admins/auth-with-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identity: email, password: password })
                });

                if (!response.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await response.json();
                authToken = data.token;

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                loadDashboard();

            } catch (error) {
                messageDiv.textContent = '‚ùå ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.classList.remove('hidden');
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TAB NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Load data for the tab
            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'pending': loadPending(); break;
                case 'organizations': loadOrganizations(); break;
                case 'contacts': loadContacts(); break;
                case 'events': loadEvents(); break;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DASHBOARD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadDashboard() {
            try {
                const [orgsRes, eventsRes] = await Promise.all([
                    fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500`, {
                        headers: { 'Authorization': authToken }
                    }),
                    fetch(`${POCKETBASE_URL}/api/collections/events/records?perPage=1`, {
                        headers: { 'Authorization': authToken }
                    })
                ]);

                const orgs = (await orgsRes.json()).items || [];
                const eventsData = await eventsRes.json();

                // Count by status
                const statusCounts = {};
                orgs.forEach(org => {
                    const status = org.status || 'Unknown';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });

                const pendingCount = statusCounts['Pending Mission Review'] || 0;
                const scrapingActive = orgs.filter(o => o.status === 'Scraping Active').length;

                document.getElementById('statOrgs').textContent = orgs.length;
                document.getElementById('statEvents').textContent = eventsData.totalItems || 0;
                document.getElementById('statPending').textContent = pendingCount;
                document.getElementById('statScrapingActive').textContent = scrapingActive;

                // Build dashboard content
                let html = '<div class="card"><h3>üìã Status Breakdown</h3>';
                
                Object.entries(STATUS_CONFIG).forEach(([status, config]) => {
                    const count = statusCounts[status] || 0;
                    html += `<p>${config.icon} ${status}: <strong>${count}</strong></p>`;
                });
                
                html += '</div>';

                // Pending alert
                if (pendingCount > 0) {
                    html += `
                        <div class="message warning">
                            ‚ö†Ô∏è You have <strong>${pendingCount}</strong> organization(s) pending mission review.
                            <button class="btn btn-small btn-warning" onclick="switchTab('pending')" style="margin-left: 15px;">Review Now</button>
                        </div>
                    `;
                }

                // Recently scraped
                const recentlyScraped = orgs.filter(o => o.last_scraped).sort((a, b) =>
                    new Date(b.last_scraped) - new Date(a.last_scraped)
                ).slice(0, 5);

                if (recentlyScraped.length > 0) {
                    html += `<div class="card"><h3>üïê Recently Scraped</h3>`;
                    recentlyScraped.forEach(org => {
                        const date = new Date(org.last_scraped).toLocaleDateString();
                        html += `<p>${org.name} ‚Äî ${date}</p>`;
                    });
                    html += `</div>`;
                }

                document.getElementById('dashboardContent').innerHTML = html;

            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="message error">‚ùå Error loading dashboard: ${error.message}</div>
                `;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PENDING REVIEW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadPending() {
            const container = document.getElementById('pendingList');

            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records?filter=(status='Pending Mission Review')&sort=-discovered_date&perPage=500`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const pending = data.items || [];

                if (pending.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üî≠</div>
                            <h3>No Pending Organizations</h3>
                            <p>Click "Run AI Suggestions" to discover new organizations.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = pending.map(org => `
                    <div class="card" id="pending-${org.id}" style="border-left-color: ${org.tou_flag ? '#ffc107' : '#667eea'};">
                        <h3>
                            ${escapeHtml(org.name)}
                            ${org.tou_flag ? '<span class="badge badge-tou-flag">‚ö†Ô∏è TOU Flag</span>' : ''}
                        </h3>
                        <p><strong>Website:</strong> <a href="${escapeHtml(org.website)}" target="_blank">${escapeHtml(org.website)}</a></p>
                        <p><strong>Type:</strong> ${escapeHtml(org.org_type) || 'Not specified'}</p>
                        <p><strong>Description:</strong> ${escapeHtml(org.description) || 'No description'}</p>
                        ${org.ai_reasoning ? `<p><strong>AI Reasoning:</strong> ${escapeHtml(org.ai_reasoning)}</p>` : ''}
                        ${org.tou_notes ? `<p><strong>TOU Notes:</strong> <span style="color: #856404;">${escapeHtml(org.tou_notes)}</span></p>` : ''}
                        ${org.discovered_date ? `<p><strong>Discovered:</strong> ${new Date(org.discovered_date).toLocaleDateString()}</p>` : ''}
                        <div class="card-actions">
                            <button class="btn btn-success btn-small" onclick="approveMission('${org.id}')">‚úÖ Approve Mission</button>
                            <button class="btn btn-danger btn-small" onclick="rejectMission('${org.id}')">‚ùå Reject Mission</button>
                            <button class="btn btn-small" onclick="editOrganization('${org.id}')">‚úèÔ∏è Edit</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                container.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function approveMission(id) {
            if (!confirm('Approve this organization for the mission? This will change status to "Mission Approved Pending Permission".')) return;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ status: 'Mission Approved Pending Permission' })
                });

                if (!response.ok) throw new Error('Failed to update');

                document.getElementById(`pending-${id}`).remove();
                showMessage('pendingMessage', '‚úÖ Organization approved! Ready for permission request.', 'success');
                loadDashboard();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function rejectMission(id) {
            const reason = prompt('Rejection reason (optional):');
            if (reason === null) return;

            try {
                const updateData = { 
                    status: 'Mission Rejected',
                    notes: reason ? `Rejection reason: ${reason}` : ''
                };

                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(updateData)
                });

                if (!response.ok) throw new Error('Failed to update');

                document.getElementById(`pending-${id}`).remove();
                showMessage('pendingMessage', '‚ùå Organization rejected.', 'info');

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function runAISuggestions() {
            alert('To run AI suggestions:\n\n1. Open PowerShell\n2. Load environment variables from .env\n3. Navigate to your Event Finder folder\n4. Run: node suggest-organizations.js\n\nNew suggestions will appear here with status "Pending Mission Review".');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ORGANIZATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadOrganizations() {
            const container = document.getElementById('organizationsList');
            const statusFilter = document.getElementById('filterStatus').value;
            const scrapingFilter = document.getElementById('filterScraping').value;

            try {
                const filters = [];

                if (statusFilter) {
                    filters.push(`status='${statusFilter}'`);
                }
                if (scrapingFilter) {
                    filters.push(`scraping_enabled=${scrapingFilter}`);
                }

                let filterParam = '';
                if (filters.length > 0) {
                    filterParam = `&filter=(${filters.join('&&')})`;
                }

                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records?sort=name&perPage=500${filterParam}`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const orgs = data.items || [];

                if (orgs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üèõÔ∏è</div>
                            <h3>No Organizations Found</h3>
                            <p>Add organizations or adjust your filters.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = orgs.map(org => {
                    const statusBadge = getStatusBadge(org.status);
                    const scrapeBadge = org.scraping_enabled
                        ? '<span class="badge badge-scraping-enabled">‚úÖ Scraping ON</span>'
                        : '<span class="badge badge-scraping-disabled">‚ùå Scraping OFF</span>';

                    return `
                        <div class="card">
                            <h3>${escapeHtml(org.name)} ${statusBadge} ${scrapeBadge}</h3>
                            <p><strong>Website:</strong> <a href="${escapeHtml(org.website)}" target="_blank">${escapeHtml(org.website) || 'N/A'}</a></p>
                            <p><strong>Type:</strong> ${escapeHtml(org.org_type) || 'Not specified'}</p>
                            <p><strong>Source ID:</strong> ${escapeHtml(org.source_id) || 'N/A'}</p>
                            ${org.events_url ? `<p><strong>Events URL:</strong> <a href="${escapeHtml(org.events_url)}" target="_blank">${escapeHtml(org.events_url)}</a></p>` : ''}
                            ${org.last_scraped ? `<p><strong>Last Scraped:</strong> ${new Date(org.last_scraped).toLocaleString()}</p>` : ''}
                            ${org.description ? `<p><strong>Description:</strong> ${escapeHtml(org.description).substring(0, 200)}...</p>` : ''}
                            <div class="card-actions">
                                <button class="btn btn-small" onclick="editOrganization('${org.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-small btn-secondary" onclick="viewContacts('${org.id}')">üë§ Contacts</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function getStatusBadge(status) {
            const config = STATUS_CONFIG[status];
            if (!config) return `<span class="badge">${status || 'Unknown'}</span>`;
            return `<span class="badge ${config.badge}">${config.icon} ${status}</span>`;
        }

        async function editOrganization(id) {
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${id}`, {
                    headers: { 'Authorization': authToken }
                });
                const org = await response.json();

                document.getElementById('editOrgId').value = org.id;
                document.getElementById('editOrgName').value = org.name || '';
                document.getElementById('editOrgType').value = org.org_type || '';
                document.getElementById('editOrgWebsite').value = org.website || '';
                document.getElementById('editOrgSourceId').value = org.source_id || '';
                document.getElementById('editOrgEventsUrl').value = org.events_url || '';
                document.getElementById('editOrgStatus').value = org.status || 'Pending Mission Review';
                document.getElementById('editOrgDescription').value = org.description || '';
                document.getElementById('editOrgPermissionRequestedDate').value = org.permission_requested_date ? org.permission_requested_date.split(' ')[0] : '';
                document.getElementById('editOrgPermissionResponseDate').value = org.permission_response_date ? org.permission_response_date.split(' ')[0] : '';
                document.getElementById('editOrgLastScraped').value = org.last_scraped ? new Date(org.last_scraped).toLocaleString() : 'Never';
                document.getElementById('editOrgScrapingEnabled').checked = org.scraping_enabled || false;
                document.getElementById('editOrgTouFlag').checked = org.tou_flag || false;
                document.getElementById('editOrgTouNotes').value = org.tou_notes || '';
                document.getElementById('editOrgAiReasoning').value = org.ai_reasoning || '';
                document.getElementById('editOrgPermissionDraft').value = org.permission_request_draft || '';
                document.getElementById('editOrgPermissionCorrespondence').value = org.permission_correspondence || '';
                document.getElementById('editOrgNotes').value = org.notes || '';

                document.getElementById('editOrgModalTitle').textContent = `Edit: ${org.name}`;
                openModal('editOrgModal');

            } catch (error) {
                alert('Error loading organization: ' + error.message);
            }
        }

        document.getElementById('editOrgForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editOrgId').value;
            const data = {
                name: document.getElementById('editOrgName').value,
                org_type: document.getElementById('editOrgType').value,
                website: document.getElementById('editOrgWebsite').value,
                source_id: document.getElementById('editOrgSourceId').value,
                events_url: document.getElementById('editOrgEventsUrl').value,
                status: document.getElementById('editOrgStatus').value,
                description: document.getElementById('editOrgDescription').value,
                permission_requested_date: document.getElementById('editOrgPermissionRequestedDate').value || null,
                permission_response_date: document.getElementById('editOrgPermissionResponseDate').value || null,
                scraping_enabled: document.getElementById('editOrgScrapingEnabled').checked,
                tou_flag: document.getElementById('editOrgTouFlag').checked,
                tou_notes: document.getElementById('editOrgTouNotes').value,
                permission_request_draft: document.getElementById('editOrgPermissionDraft').value,
                permission_correspondence: document.getElementById('editOrgPermissionCorrespondence').value,
                notes: document.getElementById('editOrgNotes').value
            };

            try {
                const method = id ? 'PATCH' : 'POST';
                const url = id 
                    ? `${POCKETBASE_URL}/api/collections/organizations/records/${id}`
                    : `${POCKETBASE_URL}/api/collections/organizations/records`;

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }

                closeModal('editOrgModal');
                loadOrganizations();
                alert('‚úÖ Organization saved!');

            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        function openAddOrgModal() {
            document.getElementById('editOrgId').value = '';
            document.getElementById('editOrgForm').reset();
            document.getElementById('editOrgModalTitle').textContent = 'Add Organization';
            document.getElementById('editOrgLastScraped').value = 'N/A';
            document.getElementById('editOrgStatus').value = 'Pending Mission Review';
            openModal('editOrgModal');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONTACTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadContacts() {
            const container = document.getElementById('contactsList');

            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?sort=name&expand=organization&perPage=500`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const contacts = data.items || [];

                if (contacts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üë§</div>
                            <h3>No Contacts Yet</h3>
                            <p>Add contacts for your organizations.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = contacts.map(c => {
                    const orgName = c.expand?.organization?.name || 'Unknown Org';
                    return `
                        <div class="card">
                            <h3>${escapeHtml(c.name)}</h3>
                            <p><strong>Organization:</strong> ${escapeHtml(orgName)}</p>
                            ${c.title ? `<p><strong>Title:</strong> ${escapeHtml(c.title)}</p>` : ''}
                            ${c.email ? `<p><strong>Email:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></p>` : ''}
                            ${c.phone ? `<p><strong>Phone:</strong> ${escapeHtml(c.phone)}</p>` : ''}
                            ${c.contact_type ? `<p><strong>Type:</strong> ${escapeHtml(c.contact_type)}</p>` : ''}
                            ${c.notes ? `<p><strong>Notes:</strong> ${escapeHtml(c.notes)}</p>` : ''}
                            <div class="card-actions">
                                <button class="btn btn-small btn-danger" onclick="deleteContact('${c.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function openAddContactModal() {
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records?sort=name&perPage=500`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const orgs = data.items || [];

                const select = document.getElementById('contactOrg');
                select.innerHTML = '<option value="">-- Select Organization --</option>' +
                    orgs.map(o => `<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');

                document.getElementById('addContactForm').reset();
                openModal('addContactModal');

            } catch (error) {
                alert('Error loading organizations: ' + error.message);
            }
        }

        document.getElementById('addContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('contactName').value,
                organization: document.getElementById('contactOrg').value,
                title: document.getElementById('contactTitle').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                contact_type: document.getElementById('contactType').value,
                source_url: document.getElementById('contactSourceUrl').value,
                notes: document.getElementById('contactNotes').value,
                last_verified: new Date().toISOString()
            };

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/contacts/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to create contact');

                closeModal('addContactModal');
                loadContacts();
                alert('‚úÖ Contact added!');

            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        async function deleteContact(id) {
            if (!confirm('Delete this contact?')) return;

            try {
                await fetch(`${POCKETBASE_URL}/api/collections/contacts/records/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authToken }
                });
                loadContacts();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function viewContacts(orgId) {
            switchTab('contacts');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadEvents() {
            const container = document.getElementById('eventsList');
            const orgFilter = document.getElementById('filterEventOrg').value;

            try {
                if (document.getElementById('filterEventOrg').options.length <= 1) {
                    const orgsRes = await fetch(
                        `${POCKETBASE_URL}/api/collections/organizations/records?sort=name&perPage=500`,
                        { headers: { 'Authorization': authToken } }
                    );
                    const orgsData = await orgsRes.json();
                    const select = document.getElementById('filterEventOrg');
                    select.innerHTML = '<option value="">All Organizations</option>' +
                        (orgsData.items || []).map(o => `<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');
                }

                let filter = '';
                if (orgFilter) {
                    filter = `&filter=(organization='${orgFilter}')`;
                }

                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records?sort=-start_date&expand=organization&perPage=100${filter}`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const events = data.items || [];

                if (events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìÖ</div>
                            <h3>No Events Found</h3>
                            <p>Events will appear here after scraping.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = events.map(e => {
                    const orgName = e.expand?.organization?.name || 'Unknown';
                    const startDate = e.start_date ? new Date(e.start_date).toLocaleDateString() : 'TBD';
                    return `
                        <div class="card">
                            <h3>${escapeHtml(e.title)}</h3>
                            <p><strong>Organization:</strong> ${escapeHtml(orgName)}</p>
                            <p><strong>Date:</strong> ${startDate} ${e.start_time || ''}</p>
                            ${e.location ? `<p><strong>Location:</strong> ${escapeHtml(e.location)}</p>` : ''}
                            ${e.url ? `<p><strong>URL:</strong> <a href="${escapeHtml(e.url)}" target="_blank">View Event</a></p>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<div class="message error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message ${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
