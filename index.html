<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Finder - National Security Events</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --accent: #0891b2;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --dark: #1e293b;
            --darker: #0f172a;
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --sidebar-width: 250px;
            --header-height: 46px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-100);
            color: var(--dark);
            min-height: 100vh;
        }

        /* ============================================
           HEADER - With search bar beside title
           ============================================ */
        .header {
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 0 16px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .header-brand:hover {
            background: var(--gray-100);
        }

        .header-brand h1 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark);
        }

        .header-brand-icon {
            font-size: 1.1rem;
        }

        .header-brand-logo {
            height: 32px;
            width: auto;
        }

        .header-search {
            width: 500px;
            flex-shrink: 0;
        }

        .header-search-box {
            position: relative;
            width: 100%;
        }

        .header-search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--gray-50);
            transition: all 0.2s;
        }

        .header-search-box input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .header-search-box input::placeholder {
            color: var(--gray-400);
        }

        .header-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: var(--gray-400);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            color: var(--dark);
            border-radius: 6px;
            transition: background 0.2s;
        }

        .mobile-menu-btn:hover {
            background: var(--gray-100);
        }

        /* Mobile sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ============================================
           MAIN LAYOUT
           ============================================ */
        .main-layout {
            display: flex;
            min-height: calc(100vh - var(--header-height));
        }

        /* ============================================
           LEFT SIDEBAR
           ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            padding: 20px 16px;
            position: sticky;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            flex-shrink: 0;
        }

        /* Mobile close button - hidden on desktop */
        .sidebar-close-btn {
            display: none;
        }

        .filter-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .filter-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .filter-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        /* Event Format Filter */
        .format-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .format-option input[type="checkbox"] {
            width: 15px;
            height: 15px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .format-option label {
            font-size: 0.85rem;
            color: var(--gray-700);
            cursor: pointer;
        }

        /* Location Filter - Indented under In-Person */
        .location-filter {
            margin-top: 8px;
            margin-left: 23px;
            padding: 10px;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .location-row {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .location-row span {
            color: var(--gray-600);
        }

        .radius-select {
            padding: 4px 6px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.8rem;
            background: var(--white);
            cursor: pointer;
        }

        .radius-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .zip-input {
            padding: 4px 6px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.8rem;
            width: 60px;
        }

        .zip-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .use-location {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            color: var(--gray-600);
            cursor: pointer;
        }

        .use-location input {
            cursor: pointer;
            width: 13px;
            height: 13px;
        }

        /* Date Range */
        .date-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .date-row:last-child {
            margin-bottom: 0;
        }

        .date-row label {
            font-size: 0.8rem;
            color: var(--gray-600);
            min-width: 38px;
        }

        .date-input {
            padding: 6px 8px;
            border: 1px solid var(--gray-300);
            border-radius: 5px;
            font-size: 0.8rem;
            flex: 1;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Sidebar Buttons - All identical styling */
        .sidebar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: var(--white);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .sidebar-btn:first-child {
            margin-top: 0;
        }

        .sidebar-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .sidebar-btn.has-filters {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }

        .sidebar-btn-icon {
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .filter-count-badge {
            background: var(--primary);
            color: var(--white);
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: auto;
        }

        /* ============================================
           MAIN CONTENT AREA
           ============================================ */
        .main-content {
            flex: 1;
            padding: 16px 20px;
            max-width: 900px;
        }

        /* Search Box styles removed - now in header */

        /* Active Filters Display - Each filter on own line */
        .active-filters-bar {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .active-filters-bar.visible {
            display: flex;
        }

        .active-filter-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-700);
            padding: 3px 0;
        }

        .active-filter-label {
            flex: 1;
        }

        .active-filter-remove {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            line-height: 1;
            padding: 0 4px;
            margin-left: 8px;
        }

        .active-filter-remove:hover {
            color: var(--danger);
        }

        /* Results Info */
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .results-count {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        .results-count strong {
            color: var(--dark);
        }

        .view-toggle {
            display: flex;
            gap: 2px;
        }

        .view-toggle button {
            padding: 5px 10px;
            border: 1px solid var(--gray-300);
            background: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .view-toggle button:first-child {
            border-radius: 5px 0 0 5px;
        }

        .view-toggle button:last-child {
            border-radius: 0 5px 5px 0;
            border-left: none;
        }

        .view-toggle button.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        /* ============================================
           EVENT CARDS
           ============================================ */
        .events-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .event-card {
            display: flex;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .event-card:hover {
            border-color: var(--gray-300);
            box-shadow: var(--shadow-md);
        }

        .event-card-image {
            width: 80px;
            min-height: 130px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border-right: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        /* Topic-based backgrounds */
        .event-card-image.cybersecurity { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .event-card-image.defense-policy { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .event-card-image.intelligence { background: linear-gradient(135deg, #1e293b 0%, #475569 100%); }
        .event-card-image.nuclear-wmd { background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%); }
        .event-card-image.space-satellites { background: linear-gradient(135deg, #0f172a 0%, #6366f1 100%); }
        .event-card-image.ai-emerging-tech { background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%); }
        .event-card-image.counterterrorism { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .event-card-image.military-operations { background: linear-gradient(135deg, #065f46 0%, #047857 100%); }
        .event-card-image.homeland-security { background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%); }
        .event-card-image.climate-security { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .event-card-image.economic-security { background: linear-gradient(135deg, #ca8a04 0%, #eab308 100%); }
        .event-card-image.diplomacy-statecraft { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
        .event-card-image.careers { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); }
        .event-card-image.default { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }

        .event-card-content {
            flex: 1;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1.3;
            margin-bottom: 2px;
        }

        .event-detail {
            display: flex;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .event-detail-label {
            font-weight: 600;
            color: var(--gray-500);
            min-width: 85px;
            flex-shrink: 0;
        }

        .event-detail-value {
            color: var(--gray-700);
        }

        .event-detail-value.description {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-detail-value a {
            color: var(--primary);
            text-decoration: none;
        }

        .event-detail-value a:hover {
            text-decoration: underline;
        }

        .event-register-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 4px;
        }

        .event-register-link:hover {
            text-decoration: underline;
        }

        /* ============================================
           PAGINATION - At bottom with page numbers
           ============================================ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 20px;
            padding: 12px 0;
        }

        .pagination-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            background: var(--white);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--white);
        }

        .pagination-info {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin: 0 4px;
        }

        /* ============================================
           CALENDAR VIEW
           ============================================ */
        .calendar-container {
            display: none;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
        }

        .calendar-container.active {
            display: block;
        }

        .events-list.hidden {
            display: none;
        }

        .pagination.hidden {
            display: none;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-nav {
            display: flex;
            gap: 5px;
        }

        .calendar-nav-btn {
            background: var(--white);
            border: 1px solid var(--gray-300);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: var(--gray-100);
        }

        .calendar-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--gray-500);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .calendar-day {
            min-height: 70px;
            padding: 4px;
            border-right: 1px solid var(--gray-100);
            border-bottom: 1px solid var(--gray-100);
            background: var(--white);
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.other-month {
            background: var(--gray-50);
        }

        .calendar-day.today {
            background: var(--primary-light);
        }

        .calendar-date {
            font-weight: 600;
            font-size: 0.7rem;
            color: var(--gray-400);
            margin-bottom: 2px;
        }

        .calendar-day.today .calendar-date {
            background: var(--primary);
            color: var(--white);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-event {
            padding: 1px 3px;
            margin-bottom: 1px;
            border-radius: 2px;
            font-size: 0.6rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .calendar-event:hover {
            background: var(--primary);
            color: var(--white);
        }

        .calendar-more {
            font-size: 0.6rem;
            color: var(--gray-500);
            padding: 1px 3px;
        }

        /* ============================================
           FILTER MODAL
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 75vh;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .modal-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--gray-400);
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--gray-600);
        }

        .modal-body {
            padding: 16px;
            max-height: calc(75vh - 110px);
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 18px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: var(--gray-100);
        }

        .checkbox-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--gray-700);
        }

        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 7px 16px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--white);
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-100);
        }

        .btn-primary {
            background: var(--primary);
            border: 1px solid var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-400);
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .empty-state h3 {
            font-size: 0.95rem;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .empty-state p {
            font-size: 0.8rem;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 850px) {
            .mobile-menu-btn {
                display: block;
            }

            .main-layout {
                flex-direction: column;
            }

            .sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 280px;
                height: 100vh;
                z-index: 200;
                border-right: 1px solid var(--gray-200);
                border-bottom: none;
                padding: 14px;
                overflow-y: auto;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.mobile-open {
                display: block;
                transform: translateX(0);
            }

            .sidebar-close-btn {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 10px;
            }

            .sidebar-close-btn button {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 5px 10px;
                color: var(--gray-500);
                border-radius: 6px;
            }

            .sidebar-close-btn button:hover {
                background: var(--gray-100);
            }

            .filter-section {
                margin-bottom: 14px;
                padding-bottom: 14px;
            }

            .main-content {
                max-width: 100%;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .header-search {
                width: 280px;
                flex: 1;
            }

            .header-brand-logo {
                height: 28px;
            }
        }

        @media (max-width: 550px) {
            .header {
                padding: 8px 10px;
                gap: 8px;
            }

            .header-brand h1 {
                font-size: 0.9rem;
            }

            .header-brand-logo {
                height: 24px;
            }

            .header-search {
                flex: 1;
                width: auto;
                min-width: 0;
            }

            .header-search-box input {
                font-size: 0.85rem;
                padding: 8px 10px 8px 32px;
            }

            .header-search-box input::placeholder {
                font-size: 0.8rem;
            }

            .event-card {
                flex-direction: column;
            }

            .event-card-image {
                width: 100%;
                min-height: 50px;
                border-right: none;
                border-bottom: 1px solid var(--gray-200);
            }

            .event-detail {
                flex-direction: column;
                gap: 0;
            }

            .event-detail-label {
                min-width: auto;
            }

            .calendar-day {
                min-height: 50px;
                padding: 2px;
            }

            .calendar-day-header {
                padding: 4px 2px;
                font-size: 0.55rem;
            }

            .pagination {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         HEADER - With search bar beside title
         ============================================ -->
    <header class="header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Open filters">‚ò∞</button>
        <div class="header-brand" onclick="goHome()" title="Home - Clear all filters">
            <img src="logo.png" alt="Event Finder Logo" class="header-brand-logo">
            <h1>Event Finder</h1>
        </div>
        <div class="header-search">
            <div class="header-search-box">
                <span class="header-search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search events by title or description...">
            </div>
        </div>
    </header>

    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

    <!-- ============================================
         MAIN LAYOUT
         ============================================ -->
    <div class="main-layout">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <!-- Mobile close button -->
            <div class="sidebar-close-btn">
                <button onclick="closeMobileMenu()" title="Close filters">‚úï</button>
            </div>
            <!-- Event Format Filter -->
            <div class="filter-section">
                <div class="filter-section-title">Event Format</div>
                <div class="format-options">
                    <div class="format-option">
                        <input type="checkbox" id="format-virtual" checked onchange="applyFilters()">
                        <label for="format-virtual">Virtual Events</label>
                    </div>
                    <div class="format-option">
                        <input type="checkbox" id="format-inperson" checked onchange="toggleLocationFilter()">
                        <label for="format-inperson">In-Person Events</label>
                    </div>
                    
                    <!-- Location Filter - Indented under In-Person -->
                    <div class="location-filter" id="locationFilter">
                        <div class="location-row">
                            <span>Within</span>
                            <select class="radius-select" id="radiusSelect" onchange="applyFilters()">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="us">US</option>
                                <option value="worldwide" selected>Any</option>
                            </select>
                            <span>mi of</span>
                            <input type="text" class="zip-input" id="zipInput" placeholder="zip">
                        </div>
                        <label class="use-location">
                            <input type="checkbox" id="useMyLocation">
                            Use my location
                        </label>
                    </div>
                </div>
            </div>

            <!-- Date Range -->
            <div class="filter-section">
                <div class="filter-section-title">Date Range</div>
                <div class="date-row">
                    <label>Start:</label>
                    <input type="date" class="date-input" id="dateFrom" onchange="applyFilters()">
                </div>
                <div class="date-row">
                    <label>End:</label>
                    <input type="date" class="date-input" id="dateTo" onchange="applyFilters()">
                </div>
            </div>

            <!-- Buttons Section - All identical styling -->
            <div class="filter-section">
                <button class="sidebar-btn" onclick="applyFilters()">
                    <span class="sidebar-btn-icon">üîç</span>
                    <span>View Results</span>
                </button>
                <button class="sidebar-btn" id="moreFiltersBtn" onclick="openFilterModal()">
                    <svg class="sidebar-btn-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    <span>More Filters</span>
                    <span class="filter-count-badge" id="filterCountBadge" style="display: none;">0</span>
                </button>
                <button class="sidebar-btn" onclick="clearAllFilters()">
                    <span class="sidebar-btn-icon">üö´</span>
                    <span>Clear Filters</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- Active Filters Display - Each on own line with √ó remove button -->
            <div class="active-filters-bar" id="activeFiltersBar">
                <!-- Filter rows inserted here -->
            </div>

            <!-- Results Info -->
            <div class="results-info">
                <span class="results-count">Showing <strong id="showingCount">0</strong> of <strong id="totalCount">0</strong> events</span>
                <div class="view-toggle">
                    <button id="listViewBtn" class="active" onclick="setView('list')">üìã List</button>
                    <button id="calendarViewBtn" onclick="setView('calendar')">üìÖ Calendar</button>
                </div>
            </div>

            <!-- Events List -->
            <div class="events-list" id="eventsList">
                <!-- Event cards inserted here -->
            </div>

            <!-- Pagination - At bottom with page numbers -->
            <div class="pagination" id="pagination">
                <!-- Pagination controls inserted here -->
            </div>

            <!-- Calendar View -->
            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚óÄ Prev</button>
                        <button class="calendar-nav-btn" onclick="goToToday()">Today</button>
                        <button class="calendar-nav-btn" onclick="changeMonth(1)">Next ‚ñ∂</button>
                    </div>
                    <div class="calendar-title" id="calendarTitle">December 2025</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </main>
    </div>

    <!-- ============================================
         MORE FILTERS MODAL
         ============================================ -->
    <div class="modal-overlay" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>More Filters</h2>
                <button class="modal-close" onclick="closeFilterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Organizations -->
                <div class="modal-section">
                    <div class="modal-section-title">Organizations</div>
                    <div class="checkbox-grid" id="orgOptions">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Topics -->
                <div class="modal-section">
                    <div class="modal-section-title">Topics</div>
                    <div class="checkbox-grid" id="topicOptions">
                        <!-- Dynamically populated -->
                    </div>
                </div>

                <!-- Regions -->
                <div class="modal-section">
                    <div class="modal-section-title">Regions</div>
                    <div class="checkbox-grid" id="regionOptions">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="resetModalFilters()">Reset</button>
                <button class="btn btn-primary" onclick="applyAndClose()">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- ============================================
         JAVASCRIPT
         ============================================ -->
    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        
        const POCKETBASE_URL = 'https://event-discovery-backend-production.up.railway.app';
        const EVENTS_PER_PAGE = 15;
        
        // US State abbreviations for location extraction
        const US_STATES = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
        
        // ============================================================================
        // MOBILE MENU FUNCTIONS
        // ============================================================================
        
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('mobile-open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // Topics
        const TOPICS = [
            { value: 'AI & Emerging Tech', label: 'AI & Emerging Tech', emoji: 'ü§ñ', class: 'ai-emerging-tech' },
            { value: 'Careers & Professional Development', label: 'Careers', emoji: 'üíº', class: 'careers' },
            { value: 'Climate & Security', label: 'Climate & Security', emoji: 'üåç', class: 'climate-security' },
            { value: 'Counterterrorism', label: 'Counterterrorism', emoji: 'üéØ', class: 'counterterrorism' },
            { value: 'Cybersecurity', label: 'Cybersecurity', emoji: 'üîí', class: 'cybersecurity' },
            { value: 'Defense Policy', label: 'Defense Policy', emoji: 'üõ°Ô∏è', class: 'defense-policy' },
            { value: 'Diplomacy & Statecraft', label: 'Diplomacy', emoji: 'ü§ù', class: 'diplomacy-statecraft' },
            { value: 'Economic Security', label: 'Economic Security', emoji: 'üí∞', class: 'economic-security' },
            { value: 'Homeland Security', label: 'Homeland Security', emoji: 'üè†', class: 'homeland-security' },
            { value: 'Intelligence', label: 'Intelligence', emoji: 'üïµÔ∏è', class: 'intelligence' },
            { value: 'Military Operations', label: 'Military Ops', emoji: '‚öîÔ∏è', class: 'military-operations' },
            { value: 'Nuclear/WMD', label: 'Nuclear/WMD', emoji: '‚ò¢Ô∏è', class: 'nuclear-wmd' },
            { value: 'Space & Satellites', label: 'Space', emoji: 'üõ∞Ô∏è', class: 'space-satellites' }
        ];

        // Regions
        const REGIONS = [
            { value: 'Africa', label: 'Africa' },
            { value: 'Arctic', label: 'Arctic' },
            { value: 'China', label: 'China' },
            { value: 'Domestic US', label: 'Domestic US' },
            { value: 'Europe/NATO', label: 'Europe/NATO' },
            { value: 'Global/Multilateral', label: 'Global' },
            { value: 'Indo-Pacific', label: 'Indo-Pacific' },
            { value: 'Latin America', label: 'Latin America' },
            { value: 'Middle East', label: 'Middle East' },
            { value: 'Russia', label: 'Russia' }
        ];

        // ============================================================================
        // STATE
        // ============================================================================
        
        let allEvents = [];
        let filteredEvents = [];
        let organizations = {};
        let orgsWithEvents = new Set();
        let selectedTopics = [];
        let selectedRegions = [];
        let selectedOrgs = [];
        let dateFrom = null;
        let dateTo = null;
        let currentView = 'list';
        let currentPage = 1;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            setDefaultDates();
            await loadOrganizations();
            await loadEvents();
            initializeFilterOptions();
            
            // Add event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(() => {
                currentPage = 1;
                applyFilters();
            }, 300));
            document.getElementById('zipInput').addEventListener('input', debounce(applyFilters, 500));
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function setDefaultDates() {
            const today = new Date();
            document.getElementById('dateFrom').value = today.toISOString().split('T')[0];
            document.getElementById('dateTo').value = '';
            dateFrom = today;
            dateTo = null;
        }

        function initializeFilterOptions() {
            // Topics
            const topicContainer = document.getElementById('topicOptions');
            topicContainer.innerHTML = TOPICS.map(t => `
                <div class="checkbox-item">
                    <input type="checkbox" id="topic-${t.value.replace(/[^a-z]/gi, '')}" value="${t.value}" onchange="updateTopicSelection()">
                    <label for="topic-${t.value.replace(/[^a-z]/gi, '')}">${t.label}</label>
                </div>
            `).join('');

            // Regions
            const regionContainer = document.getElementById('regionOptions');
            regionContainer.innerHTML = REGIONS.map(r => `
                <div class="checkbox-item">
                    <input type="checkbox" id="region-${r.value.replace(/[^a-z]/gi, '')}" value="${r.value}" onchange="updateRegionSelection()">
                    <label for="region-${r.value.replace(/[^a-z]/gi, '')}">${r.label}</label>
                </div>
            `).join('');
        }

        async function loadOrganizations() {
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500`);
                const data = await response.json();
                
                if (data && data.items && Array.isArray(data.items)) {
                    data.items.forEach(org => {
                        organizations[org.id] = org;
                    });
                }
            } catch (error) {
                console.error('Error loading organizations:', error);
            }
        }

        async function loadEvents() {
            try {
                // FIXED: Only fetch approved events + expand icon relation for images
                const response = await fetch(`${POCKETBASE_URL}/api/collections/events/records?perPage=500&sort=start_date&filter=(event_status='approved')&expand=icon`);
                const data = await response.json();
                
                allEvents = (data.items || []).map(event => ({
                    ...event,
                    startDate: event.start_date ? new Date(event.start_date) : null,
                    endDate: event.end_date ? new Date(event.end_date) : null
                }));

                // Track which orgs have events
                allEvents.forEach(e => {
                    if (e.organization) orgsWithEvents.add(e.organization);
                });

                // Populate org filter
                populateOrgFilter();
                
                applyFilters();
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        function populateOrgFilter() {
            const orgContainer = document.getElementById('orgOptions');
            const orgsArray = Array.from(orgsWithEvents)
                .map(id => organizations[id])
                .filter(org => org)
                .sort((a, b) => a.name.localeCompare(b.name));

            orgContainer.innerHTML = orgsArray.map(org => `
                <div class="checkbox-item">
                    <input type="checkbox" id="org-${org.id}" value="${org.id}" onchange="updateOrgSelection()">
                    <label for="org-${org.id}">${org.name}</label>
                </div>
            `).join('');
        }

        // ============================================================================
        // FILTER SELECTION HANDLERS
        // ============================================================================

        function updateTopicSelection() {
            selectedTopics = [];
            document.querySelectorAll('#topicOptions input[type="checkbox"]:checked').forEach(cb => {
                selectedTopics.push(cb.value);
            });
        }

        function updateRegionSelection() {
            selectedRegions = [];
            document.querySelectorAll('#regionOptions input[type="checkbox"]:checked').forEach(cb => {
                selectedRegions.push(cb.value);
            });
        }

        function updateOrgSelection() {
            selectedOrgs = [];
            document.querySelectorAll('#orgOptions input[type="checkbox"]:checked').forEach(cb => {
                selectedOrgs.push(cb.value);
            });
        }

        function toggleLocationFilter() {
            const inPersonChecked = document.getElementById('format-inperson').checked;
            const locationFilter = document.getElementById('locationFilter');
            locationFilter.style.display = inPersonChecked ? 'block' : 'none';
            applyFilters();
        }

        // ============================================================================
        // FILTERING - SEARCH FIXED FOR "AI"
        // ============================================================================
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const searchLower = searchTerm.toLowerCase();
            
            // Get date values
            const dateFromValue = document.getElementById('dateFrom').value;
            const dateToValue = document.getElementById('dateTo').value;
            dateFrom = dateFromValue ? new Date(dateFromValue) : null;
            dateTo = dateToValue ? new Date(dateToValue + 'T23:59:59') : null;

            // Get format filters
            const showVirtual = document.getElementById('format-virtual').checked;
            const showInPerson = document.getElementById('format-inperson').checked;

            filteredEvents = allEvents.filter(event => {
                
                // SEARCH - only search title and description (not org, topics, regions, location)
                if (searchTerm.length > 0) {
                    // Only search title and description for relevance
                    const searchableText = [
                        event.title || '',
                        event.description || ''
                    ].join(' ').toLowerCase();
                    
                    // Handle multi-word search - ANY word can match (OR logic)
                    const searchWords = searchLower.split(/\s+/).filter(w => w.length > 0);
                    
                    let anyWordMatched = false;
                    for (const word of searchWords) {
                        // For short words (3 chars or less), use word boundary matching
                        // This prevents "ai" from matching "training", "maintain", etc.
                        if (word.length <= 3) {
                            // Create regex with word boundaries
                            const wordRegex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
                            if (wordRegex.test(searchableText)) {
                                anyWordMatched = true;
                                break;
                            }
                        } else {
                            // For longer words, simple substring match is fine
                            if (searchableText.indexOf(word) !== -1) {
                                anyWordMatched = true;
                                break;
                            }
                        }
                    }
                    
                    // If no words matched, exclude this event
                    if (!anyWordMatched) {
                        return false;
                    }
                }

                // Date range filter
                if (dateFrom && event.startDate && event.startDate < dateFrom) return false;
                if (dateTo && event.startDate && event.startDate > dateTo) return false;

                // Format filter (Virtual / In-Person)
                const eventType = (event.event_type || '').toLowerCase();
                const isVirtual = eventType.indexOf('virtual') !== -1 || eventType.indexOf('webinar') !== -1 || eventType.indexOf('online') !== -1;
                const isInPerson = eventType.indexOf('in-person') !== -1 || eventType.indexOf('in person') !== -1 || eventType.indexOf('onsite') !== -1;
                const isHybrid = eventType.indexOf('hybrid') !== -1;
                
                if (!showVirtual && !showInPerson) {
                    return false;
                } else if (showVirtual && !showInPerson) {
                    if (!isVirtual && !isHybrid) return false;
                } else if (!showVirtual && showInPerson) {
                    if (!isInPerson && !isHybrid) return false;
                }

                // Topic filter
                if (selectedTopics.length > 0) {
                    const eventTopics = event.topics || [];
                    const hasMatchingTopic = selectedTopics.some(t => eventTopics.indexOf(t) !== -1);
                    if (!hasMatchingTopic) return false;
                }

                // Region filter
                if (selectedRegions.length > 0) {
                    const eventRegions = event.regions || [];
                    const hasMatchingRegion = selectedRegions.some(r => eventRegions.indexOf(r) !== -1);
                    if (!hasMatchingRegion) return false;
                }

                // Organization filter
                if (selectedOrgs.length > 0) {
                    if (selectedOrgs.indexOf(event.organization) === -1) return false;
                }

                return true;
            });

            document.getElementById('totalCount').textContent = filteredEvents.length;
            
            renderEvents();
            renderPagination();
            updateActiveFiltersDisplay();
            updateFilterBadge();
            
            if (currentView === 'calendar') {
                renderCalendar();
            }
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFiltersBar');
            const rows = [];

            // Search term
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                rows.push(`<div class="active-filter-row">
                    <span class="active-filter-label">Search: "${escapeHtml(searchTerm)}"</span>
                    <button class="active-filter-remove" onclick="clearSearch()" title="Remove">√ó</button>
                </div>`);
            }

            // Topics
            selectedTopics.forEach(t => {
                const topic = TOPICS.find(tp => tp.value === t);
                rows.push(`<div class="active-filter-row">
                    <span class="active-filter-label">Topic: ${topic?.label || t}</span>
                    <button class="active-filter-remove" onclick="removeFilter('topic', '${escapeAttr(t)}')" title="Remove">√ó</button>
                </div>`);
            });

            // Regions
            selectedRegions.forEach(r => {
                const region = REGIONS.find(rg => rg.value === r);
                rows.push(`<div class="active-filter-row">
                    <span class="active-filter-label">Region: ${region?.label || r}</span>
                    <button class="active-filter-remove" onclick="removeFilter('region', '${escapeAttr(r)}')" title="Remove">√ó</button>
                </div>`);
            });

            // Organizations
            selectedOrgs.forEach(o => {
                const org = organizations[o];
                rows.push(`<div class="active-filter-row">
                    <span class="active-filter-label">Org: ${org?.name || o}</span>
                    <button class="active-filter-remove" onclick="removeFilter('org', '${escapeAttr(o)}')" title="Remove">√ó</button>
                </div>`);
            });

            if (rows.length > 0) {
                container.innerHTML = rows.join('');
                container.classList.add('visible');
            } else {
                container.classList.remove('visible');
            }
        }

        function updateFilterBadge() {
            const count = selectedTopics.length + selectedRegions.length + selectedOrgs.length;
            const badge = document.getElementById('filterCountBadge');
            const btn = document.getElementById('moreFiltersBtn');
            
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
                btn.classList.add('has-filters');
            } else {
                badge.style.display = 'none';
                btn.classList.remove('has-filters');
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentPage = 1;
            applyFilters();
        }

        function removeFilter(type, value) {
            if (type === 'topic') {
                selectedTopics = selectedTopics.filter(t => t !== value);
                const cb = document.querySelector(`#topicOptions input[value="${value}"]`);
                if (cb) cb.checked = false;
            } else if (type === 'region') {
                selectedRegions = selectedRegions.filter(r => r !== value);
                const cb = document.querySelector(`#regionOptions input[value="${value}"]`);
                if (cb) cb.checked = false;
            } else if (type === 'org') {
                selectedOrgs = selectedOrgs.filter(o => o !== value);
                const cb = document.querySelector(`#orgOptions input[value="${value}"]`);
                if (cb) cb.checked = false;
            }
            currentPage = 1;
            applyFilters();
        }

        function clearAllFilters() {
            selectedTopics = [];
            selectedRegions = [];
            selectedOrgs = [];
            
            document.querySelectorAll('#filterModal input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('searchInput').value = '';
            document.getElementById('zipInput').value = '';
            document.getElementById('radiusSelect').value = 'worldwide';
            document.getElementById('format-virtual').checked = true;
            document.getElementById('format-inperson').checked = true;
            document.getElementById('locationFilter').style.display = 'block';
            
            setDefaultDates();
            currentPage = 1;
            applyFilters();
        }

        function goHome() {
            clearAllFilters();
            setView('list');
        }

        function resetModalFilters() {
            selectedTopics = [];
            selectedRegions = [];
            selectedOrgs = [];
            document.querySelectorAll('#filterModal input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        // ============================================================================
        // RENDERING
        // ============================================================================
        
        function renderEvents() {
            const container = document.getElementById('eventsList');
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No events found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                document.getElementById('showingCount').textContent = '0';
                return;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * EVENTS_PER_PAGE;
            const endIndex = startIndex + EVENTS_PER_PAGE;
            const pageEvents = filteredEvents.slice(startIndex, endIndex);
            
            document.getElementById('showingCount').textContent = `${startIndex + 1}-${Math.min(endIndex, filteredEvents.length)}`;

            container.innerHTML = pageEvents.map(event => {
                const topicInfo = getTopicInfo(event.topics);
                const org = organizations[event.organization];
                const orgName = org?.name || 'Unknown Organization';
                const orgWebsite = org?.website || '#';
                
                // Build date display - handles multi-day events
                let dateDisplay = buildDateDisplay(event);
                
                // Build location display - FIXED: extracts from title if location field is bad
                let locationDisplay = buildLocationDisplay(event);

                // Get description - strip HTML
                const description = stripHtml(event.description || '');

                // Get registration URL
                const registerUrl = event.registration_url || event.url || '';

                // Build image display - use actual DALL-E icon if available
                const iconHtml = buildIconDisplay(event, topicInfo);

                return `
                    <div class="event-card">
                        ${iconHtml}
                        <div class="event-card-content">
                            <div class="event-title">${escapeHtml(event.title)}</div>
                            ${description ? `
                            <div class="event-detail">
                                <span class="event-detail-label">Description:</span>
                                <span class="event-detail-value description">${escapeHtml(description)}</span>
                            </div>` : ''}
                            <div class="event-detail">
                                <span class="event-detail-label">Dates:</span>
                                <span class="event-detail-value">${dateDisplay}</span>
                            </div>
                            <div class="event-detail">
                                <span class="event-detail-label">Organization:</span>
                                <span class="event-detail-value"><a href="${orgWebsite}" target="_blank">${escapeHtml(orgName)}</a></span>
                            </div>
                            <div class="event-detail">
                                <span class="event-detail-label">Location:</span>
                                <span class="event-detail-value">${escapeHtml(locationDisplay)}</span>
                            </div>
                            ${registerUrl ? `<a href="${registerUrl}" target="_blank" class="event-register-link">More details and registration</a>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================================================
        // DATE DISPLAY - DATES ONLY (no times)
        // ============================================================================
        
        function buildDateDisplay(event) {
            const startDate = event.start_date ? new Date(event.start_date) : null;
            const endDate = event.end_date ? new Date(event.end_date) : null;
            
            if (!startDate) {
                return 'Date TBD';
            }
            
            // Check if multi-day event
            if (endDate) {
                const startDay = startDate.toDateString();
                const endDay = endDate.toDateString();
                
                if (startDay !== endDay) {
                    // Multi-day event
                    if (startDate.getMonth() === endDate.getMonth() && startDate.getFullYear() === endDate.getFullYear()) {
                        // Same month: "December 9-10, 2025"
                        return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDate.getDate()}-${endDate.getDate()}, ${startDate.getFullYear()}`;
                    } else if (startDate.getFullYear() === endDate.getFullYear()) {
                        // Same year, different months: "December 30, 2025 to January 2, 2025"
                        return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDate.getDate()}, ${startDate.getFullYear()} to ${endDate.toLocaleDateString('en-US', { month: 'long' })} ${endDate.getDate()}, ${endDate.getFullYear()}`;
                    } else {
                        // Different years: "December 30, 2025 to January 2, 2026"
                        return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDate.getDate()}, ${startDate.getFullYear()} to ${endDate.toLocaleDateString('en-US', { month: 'long' })} ${endDate.getDate()}, ${endDate.getFullYear()}`;
                    }
                }
            }
            
            // Single day event - "December 18, 2025"
            return startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        // ============================================================================
        // LOCATION DISPLAY - FIXED: Extracts City, ST from title if location field is bad
        // ============================================================================
        
        function buildLocationDisplay(event) {
            const rawLocation = (event.location || '').trim();
            const eventType = (event.event_type || '').toLowerCase();
            const title = event.title || '';
            
            // Check if virtual
            if (eventType.indexOf('virtual') !== -1 || eventType.indexOf('webinar') !== -1 || eventType.indexOf('online') !== -1) {
                return 'Virtual';
            }
            
            // First try to get location from the location field
            const fromField = extractCityStateFromText(rawLocation);
            if (fromField) {
                if (eventType.indexOf('hybrid') !== -1) {
                    return `Hybrid - ${fromField}`;
                }
                return fromField;
            }
            
            // If location field is bad (in-person, tbd, etc.), try to extract from title
            const fromTitle = extractCityStateFromTitle(title);
            if (fromTitle) {
                if (eventType.indexOf('hybrid') !== -1) {
                    return `Hybrid - ${fromTitle}`;
                }
                return fromTitle;
            }
            
            // If hybrid with no location
            if (eventType.indexOf('hybrid') !== -1) {
                return 'Hybrid';
            }
            
            return 'Location TBD';
        }

        // ============================================================================
        // ICON DISPLAY - Uses DALL-E images from topic_icons if available
        // ============================================================================
        
        function buildIconDisplay(event, topicInfo) {
            // Check if event has an expanded icon with an actual image file
            if (event.expand && event.expand.icon && event.expand.icon.icon_file) {
                const icon = event.expand.icon;
                const imageUrl = `${POCKETBASE_URL}/api/files/topic_icons/${icon.id}/${icon.icon_file}`;
                return `
                    <div class="event-card-image" style="padding: 0; overflow: hidden;">
                        <img src="${imageUrl}" alt="Event icon" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div class=\\'event-card-image ${topicInfo.class}\\'><span>${topicInfo.emoji}</span></div>'">
                    </div>
                `;
            }
            
            // Fallback to gradient placeholder with emoji
            return `
                <div class="event-card-image ${topicInfo.class}">
                    <span>${topicInfo.emoji}</span>
                </div>
            `;
        }

        // Check if text is a valid City, ST location
        function extractCityStateFromText(text) {
            if (!text) return null;
            
            const lower = text.toLowerCase().trim();
            
            // List of non-location values to reject
            const badValues = [
                'tbd', 'to be determined', 'n/a', 'na', 'none', 'online',
                'in-person', 'in person', 'inperson', 'in-person event',
                'virtual', 'webinar', 'remote', 'zoom',
                'hybrid', 'location tbd', 'see website', 'see details',
                'various', 'multiple locations', 'united states', 'usa', 'us'
            ];
            
            // Check exact match with bad values
            if (badValues.indexOf(lower) !== -1) {
                return null;
            }
            
            // Also check if it STARTS with "in-person" or similar
            if (lower.indexOf('in-person') === 0 || lower.indexOf('in person') === 0) {
                // But might be "In-person - Arlington, VA" - try to extract the location part
                const afterDash = text.match(/[-‚Äì]\s*(.+)$/);
                if (afterDash) {
                    return extractCityStateFromText(afterDash[1]);
                }
                return null;
            }
            
            // Clean up text
            let cleaned = text
                .replace(/^in-person\s*[-‚Äì:]\s*/i, '')
                .replace(/^hybrid\s*[-‚Äì:]\s*/i, '')
                .replace(/^location\s*[-‚Äì:]\s*/i, '')
                .replace(/^at\s+/i, '')
                .trim();
            
            // Look for "City, ST" pattern (2-letter state code)
            const cityStateMatch = cleaned.match(/^(.+?),\s*([A-Z]{2})$/i);
            if (cityStateMatch) {
                const state = cityStateMatch[2].toUpperCase();
                if (US_STATES.indexOf(state) !== -1) {
                    return `${cityStateMatch[1].trim()}, ${state}`;
                }
            }
            
            // Look for state abbreviation at the end (without comma)
            const stateAtEnd = cleaned.match(/\s([A-Z]{2})$/);
            if (stateAtEnd && US_STATES.indexOf(stateAtEnd[1]) !== -1) {
                return cleaned;
            }
            
            // If it has a comma and reasonable length, might be a location
            if (cleaned.indexOf(',') !== -1 && cleaned.length >= 5 && cleaned.length <= 60) {
                // Double-check it's not a bad value
                if (badValues.indexOf(cleaned.toLowerCase()) === -1) {
                    return cleaned;
                }
            }
            
            return null;
        }

        // Extract "City, ST" from event title
        function extractCityStateFromTitle(title) {
            if (!title) return null;
            
            // Pattern 1: "Event Name - City, ST" (with various dash types)
            // Match: " - Arlington, VA" or " ‚Äì Arlington, VA"
            const dashMatch = title.match(/\s[-‚Äì‚Äî]\s*([A-Za-z\s\.]+),\s*([A-Z]{2})\s*$/);
            if (dashMatch) {
                const city = dashMatch[1].trim();
                const state = dashMatch[2].toUpperCase();
                if (US_STATES.indexOf(state) !== -1 && city.length >= 2 && city.length <= 30) {
                    return `${city}, ${state}`;
                }
            }
            
            // Pattern 2: Look for "City, ST" anywhere in title
            // Be more careful here to avoid false matches
            for (let i = 0; i < US_STATES.length; i++) {
                const state = US_STATES[i];
                // Match "City, ST" where City is 2-25 chars, starts with capital
                const pattern = new RegExp(`([A-Z][a-zA-Z\\.\\s]{1,24}),\\s*${state}(?:\\s|$|,|\\)|-)`, 'g');
                const matches = title.match(pattern);
                if (matches && matches.length > 0) {
                    // Get the last match (most likely to be at end of title)
                    const lastMatch = matches[matches.length - 1];
                    // Clean up the match
                    const cleanMatch = lastMatch.replace(/[,\)\-\s]+$/, '').trim();
                    const parts = cleanMatch.split(',');
                    if (parts.length >= 2) {
                        const city = parts[0].trim();
                        if (city.length >= 2 && city.length <= 25) {
                            return `${city}, ${state}`;
                        }
                    }
                }
            }
            
            return null;
        }

        function formatDateShort(date) {
            if (!date) return '';
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function getTopicInfo(topics) {
            if (!topics || topics.length === 0) {
                return { emoji: 'üìÖ', class: 'default' };
            }
            const topic = TOPICS.find(t => t.value === topics[0]);
            return topic ? { emoji: topic.emoji, class: topic.class } : { emoji: 'üìÖ', class: 'default' };
        }

        function stripHtml(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        // ============================================================================
        // PAGINATION - At bottom with page numbers
        // ============================================================================
        
        function renderPagination() {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-info">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="pagination-info">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;
            
            container.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderEvents();
            renderPagination();
            
            // Scroll to top of events
            document.getElementById('eventsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ============================================================================
        // VIEW TOGGLE
        // ============================================================================
        
        function setView(view) {
            currentView = view;
            const listBtn = document.getElementById('listViewBtn');
            const calBtn = document.getElementById('calendarViewBtn');
            const listView = document.getElementById('eventsList');
            const calView = document.getElementById('calendarContainer');
            const pagination = document.getElementById('pagination');

            if (view === 'list') {
                listBtn.classList.add('active');
                calBtn.classList.remove('active');
                listView.classList.remove('hidden');
                pagination.classList.remove('hidden');
                calView.classList.remove('active');
            } else {
                listBtn.classList.remove('active');
                calBtn.classList.add('active');
                listView.classList.add('hidden');
                pagination.classList.add('hidden');
                calView.classList.add('active');
                renderCalendar();
            }
        }

        // ============================================================================
        // CALENDAR VIEW
        // ============================================================================
        
        function renderCalendar() {
            const title = document.getElementById('calendarTitle');
            const grid = document.getElementById('calendarGrid');
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            title.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const totalDays = lastDay.getDate();

            // Get events for this month
            const monthEvents = filteredEvents.filter(e => {
                if (!e.startDate) return false;
                return e.startDate.getMonth() === currentMonth && 
                       e.startDate.getFullYear() === currentYear;
            });

            // Group events by date
            const eventsByDate = {};
            monthEvents.forEach(e => {
                const dateKey = e.startDate.getDate();
                if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
                eventsByDate[dateKey].push(e);
            });

            let html = `
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            `;

            // Previous month days
            const prevMonth = new Date(currentYear, currentMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-date">${prevMonth.getDate() - i}</div>
                </div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= totalDays; day++) {
                const isToday = day === today.getDate() && 
                               currentMonth === today.getMonth() && 
                               currentYear === today.getFullYear();
                
                const dayEvents = eventsByDate[day] || [];
                const displayEvents = dayEvents.slice(0, 2);
                const moreCount = dayEvents.length - 2;

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <div class="calendar-date">${day}</div>
                        ${displayEvents.map(e => 
                            `<div class="calendar-event" title="${escapeHtml(e.title)}">${escapeHtml(e.title.substring(0, 10))}${e.title.length > 10 ? '...' : ''}</div>`
                        ).join('')}
                        ${moreCount > 0 ? `<div class="calendar-more">+${moreCount} more</div>` : ''}
                    </div>
                `;
            }

            // Next month days
            const remainingCells = 42 - (startDayOfWeek + totalDays);
            for (let day = 1; day <= remainingCells && remainingCells < 7; day++) {
                html += `<div class="calendar-day other-month">
                    <div class="calendar-date">${day}</div>
                </div>`;
            }

            grid.innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function goToToday() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderCalendar();
        }

        // ============================================================================
        // MODALS
        // ============================================================================
        
        function openFilterModal() {
            document.getElementById('filterModal').classList.add('active');
        }

        function closeFilterModal() {
            document.getElementById('filterModal').classList.remove('active');
        }

        function applyAndClose() {
            currentPage = 1;
            applyFilters();
            closeFilterModal();
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        // Close modals on escape or backdrop click
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFilterModal();
            }
        });

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
