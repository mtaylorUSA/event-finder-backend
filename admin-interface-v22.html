<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Finder Admin v23</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; cursor: pointer; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .header:hover { opacity: 0.9; }
        .header-logo { height: 70px; width: auto; }
        .header-text { text-align: left; }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 0.95em; }

        /* Login */
        .login-container { max-width: 400px; margin: 50px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-container h2 { text-align: center; margin-bottom: 30px; color: #333; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group.checkbox-group { display: flex; align-items: center; gap: 10px; }
        .form-group.checkbox-group label { display: flex; align-items: center; gap: 8px; margin-bottom: 0; cursor: pointer; }
        .form-group.checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin: 0; cursor: pointer; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* Buttons */
        .btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-full { width: 100%; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #333; }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        .btn-action { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }

        /* Tabs */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 100px; padding: 18px 10px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; font-size: 13px; font-weight: 600; color: #666; transition: all 0.3s; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }

        /* Profile Sub-Tabs */
        .profile-tabs { display: flex; background: #e9ecef; border-bottom: 2px solid #dee2e6; flex-wrap: wrap; margin: 0 0 20px 0; }
        .profile-tab { padding: 15px 25px; text-align: center; cursor: pointer; background: transparent; border: none; font-size: 14px; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .profile-tab:hover { background: #f8f9fa; }
        .profile-tab.active { background: white; color: #667eea; border-bottom-color: #667eea; }
        .profile-tab-content { display: none; }
        .profile-tab-content.active { display: block; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .stat-card.warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .stat-card.success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .stat-card.info { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .stat-card.danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .stat-card h3 { font-size: 2.5em; margin-bottom: 5px; }
        .stat-card p { font-size: 1em; opacity: 0.9; }

        /* Cards */
        .card { background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea; }
        .card h3 { color: #333; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .card p { color: #666; margin-bottom: 8px; font-size: 14px; }
        .card a { color: #667eea; text-decoration: none; }
        .card a:hover { text-decoration: underline; }
        .card-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }

        .card.status-nominated { border-left-color: #6f42c1; }
        .card.status-restrictions { border-left-color: #e67e22; background: #fff8f0; }
        .card.status-approved { border-left-color: #17a2b8; }
        .card.status-requested { border-left-color: #ffc107; }
        .card.status-granted { border-left-color: #28a745; }
        .card.status-rejected { border-left-color: #dc3545; }
        .card.status-live { border-left-color: #20c997; background: #f0fff4; }
        .card.status-tech-blocked { border-left-color: #721c24; background: #fff5f5; }

        /* Section box */
        .section-box { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .section-box h4 { color: #495057; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }

        /* Contact/Event cards */
        .contact-card, .event-card { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .contact-card h5, .event-card h5 { color: #333; margin-bottom: 8px; }
        .contact-card p, .event-card p { margin: 4px 0; font-size: 13px; color: #666; }
        .contact-card .contact-actions { margin-top: 10px; }

        /* Profile header */
        .profile-header { background: #f8f9fa; color: #333; padding: 20px 30px; margin: 0 0 20px 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-bottom: 3px solid #667eea; }
        .profile-header h2 { font-size: 1.5em; color: #333; }
        .profile-header .org-status { color: #666; font-size: 0.95em; }

        /* Info boxes */
        .info-box { background: #e7f3ff; border: 1px solid #b6d4fe; border-radius: 8px; padding: 12px; margin: 10px 0; }
        .info-box.warning { background: #fff3cd; border-color: #ffc107; }
        .info-box.success { background: #d1e7dd; border-color: #198754; }
        .info-box.danger { background: #f8d7da; border-color: #dc3545; }
        .info-box p { margin: 4px 0; font-size: 13px; }

        /* Inline selects */
        .inline-status-select { padding: 6px 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 13px; background: white; cursor: pointer; }
        .inline-status-select:focus { border-color: #667eea; outline: none; }

        /* Badges */
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-nominated { background: #e2d4f0; color: #6f42c1; }
        .badge-restrictions { background: #ffe5cc; color: #d35400; border: 1px solid #e67e22; }
        .badge-approved { background: #cce5ff; color: #004085; }
        .badge-requested { background: #fff3cd; color: #856404; }
        .badge-granted { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .badge-live { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #333; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-tou-flag { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .badge-tech-block { background: #dc3545; color: white; border: 1px solid #721c24; }
        .badge-js-render { background: #e2e3f3; color: #3d4070; border: 1px solid #6c757d; }
        .badge-permission-denied { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .badge-duplicate { background: #e2d4f0; color: #6f42c1; border: 1px solid #6f42c1; }
        .badge-explicit { background: #d4edda; color: #155724; }

        /* Icon Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding: 10px 0; }
        .icon-card { background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 15px; text-align: center; transition: transform 0.2s, box-shadow 0.2s; }
        .icon-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .icon-card img { width: 80px; height: 130px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .icon-card .icon-topics { font-size: 12px; color: #555; line-height: 1.4; min-height: 50px; }
        .icon-card .icon-status { font-size: 11px; margin-top: 8px; padding: 4px 8px; border-radius: 12px; display: inline-block; }
        .icon-card .icon-status.has-icon { background: #d4edda; color: #155724; }
        .icon-card .icon-status.no-icon { background: #f8d7da; color: #721c24; }
        .icon-stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .icon-stat { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 25px; border-radius: 10px; }
        .icon-stat.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .icon-stat.warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); }
        .icon-stat h4 { font-size: 1.8em; margin-bottom: 3px; }
        .icon-stat p { font-size: 0.9em; opacity: 0.9; }

        /* Event cards with icons */
        .event-with-icon { display: flex; gap: 15px; align-items: flex-start; }
        .event-icon { flex-shrink: 0; text-align: center; }
        .event-icon img { width: 80px; height: 130px; object-fit: cover; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.15); }
        .event-icon .no-icon { width: 80px; height: 130px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px; }
        .event-details { flex: 1; min-width: 0; }
        .event-topics { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .event-topic-badge { background: #e7f3ff; color: #0066cc; padding: 3px 8px; border-radius: 12px; font-size: 11px; }
        .event-region-badge { background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 12px; font-size: 11px; }
        .event-country-badge { background: #d4edda; color: #155724; padding: 3px 8px; border-radius: 12px; font-size: 11px; }
        .event-org-badge { background: #e2d4f0; color: #6f42c1; padding: 3px 8px; border-radius: 12px; font-size: 11px; }
        .event-metadata { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .event-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .event-meta-row { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .event-meta-row strong { color: #666; margin-right: 5px; }
        .icon-status-indicator { margin-top: 5px; font-size: 10px; }
        .icon-found { color: #28a745; }
        .icon-missing { color: #dc3545; }
        .icon-key-debug { margin-top: 8px; padding: 5px 8px; background: #f8f9fa; border-radius: 4px; font-family: monospace; color: #666; word-break: break-all; }
        .badge-implied { background: #e2e3e5; color: #383d41; }

        /* Messages */
        .message { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; padding: 20px; }
        .modal.active { display: flex; align-items: flex-start; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; margin: 20px 0; }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.3em; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; padding: 5px 10px; }
        .modal-body { padding: 25px; }

        /* Section Headers */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .section-header h2 { color: #333; font-size: 1.4em; }

        /* Filters */
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filters select, .filters input[type="text"] { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .filters select { min-width: 180px; }

        /* Loading & Empty */
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #667eea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; }

        .hidden { display: none !important; }
        .draft-textarea { font-family: monospace; font-size: 12px; line-height: 1.5; min-height: 200px; }
        .btn-copy { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); font-size: 12px; padding: 6px 12px; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: auto; }
            .profile-header { flex-direction: column; align-items: flex-start; }
            .header { flex-direction: column; gap: 10px; padding: 15px; }
            .header-logo { height: 50px; }
            .header-text { text-align: center; }
            .header h1 { font-size: 1.5em; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* v23: CORRESPONDENCE ACCORDION STYLES                                    */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Correspondence Type Accordion */
        .corr-accordion { margin-bottom: 20px; }
        .corr-accordion-header {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .corr-type-btn {
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .corr-type-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .corr-type-btn.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .corr-panel {
            display: none;
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            animation: slideDown 0.3s ease;
        }
        .corr-panel.active { display: block; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .corr-panel h5 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #d0d9ff;
        }
        
        /* Recommended Contact Box */
        .recommended-contact {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        .recommended-contact label {
            font-size: 12px;
            color: #004085;
            margin-bottom: 5px;
            display: block;
        }
        .recommended-contact .contact-info {
            font-weight: 600;
            color: #0056b3;
        }
        
        /* Correspondence Timeline Entries */
        .corr-entry {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
        }
        .corr-entry.type-phone { background: #f0fff4; border-left: 4px solid #28a745; }
        .corr-entry.type-email-out { background: #fff8e6; border-left: 4px solid #ffc107; }
        .corr-entry.type-email-in { background: #e8f4fd; border-left: 4px solid #17a2b8; }
        .corr-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .corr-entry-type {
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .corr-entry-date { color: #666; font-size: 13px; }
        .corr-entry-contact { color: #555; font-size: 13px; margin-bottom: 8px; }
        .corr-entry-subject { font-weight: 600; color: #333; margin-bottom: 5px; }
        .corr-entry-text {
            background: white;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 12px;
            font-size: 13px;
            color: #555;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .corr-entry-actions {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        .corr-followup-badge {
            display: inline-block;
            background: #fff3cd;
            color: #856404;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        /* Summary Cards for Status & History */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 18px;
        }
        .summary-card h5 {
            color: #495057;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .summary-card p {
            margin: 6px 0;
            font-size: 13px;
            color: #555;
        }
        .summary-card p strong { color: #333; }
        
        /* Flag Dashboard */
        .flag-dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
        }
        .flag-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }
        .flag-item.flag-off { background: #e9ecef; color: #6c757d; }
        .flag-item.flag-on-tou { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .flag-item.flag-on-block { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }
        .flag-item.flag-on-js { background: #cce5ff; color: #004085; border: 2px solid #17a2b8; }
        .flag-item.flag-on-denied { background: #f5c6cb; color: #721c24; border: 2px solid #c82333; }
        
        /* Restriction Details Box */
        .restriction-details {
            background: #fff8e6;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .restriction-details h6 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .restriction-details .restriction-item {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .restriction-details .restriction-item:last-child { margin-bottom: 0; }
        
        /* Draft Generator Box */
        .draft-generator-box {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .draft-generator-box h6 {
            margin-bottom: 12px;
            color: #495057;
        }

        /* Multi-Recipient Checkbox Styles */
        .contact-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .contact-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .contact-checkbox-item:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }
        .contact-checkbox-item.selected {
            background: #e7f3ff;
            border-color: #667eea;
        }
        .contact-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .contact-checkbox-item .contact-info-text {
            flex: 1;
            font-size: 13px;
        }
        .contact-checkbox-item .contact-type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e9ecef;
            color: #666;
        }
        .recipient-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* v25: STREAMLINED STATUS & HISTORY TAB STYLES                            */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Two-column grid for Status + Contacts */
        .status-contacts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        @media (max-width: 900px) {
            .status-contacts-grid { grid-template-columns: 1fr; }
        }
        
        /* Read-only flags display */
        .flags-readonly {
            margin-top: 15px;
        }
        .flag-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            font-size: 14px;
            color: #495057;
        }
        .flag-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            pointer-events: none;
        }
        .flag-row.flag-active {
            color: #856404;
            font-weight: 600;
        }
        .flag-row.flag-active.tou { background: #fff3cd; padding: 8px 12px; border-radius: 6px; margin: 4px 0; }
        .flag-row.flag-active.tech-block { background: #f8d7da; color: #721c24; padding: 8px 12px; border-radius: 6px; margin: 4px 0; }
        .flag-row.flag-active.js-render { background: #cce5ff; color: #004085; padding: 8px 12px; border-radius: 6px; margin: 4px 0; }
        
        /* Relevant contacts list */
        .relevant-contact-item {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        .relevant-contact-item:last-child { border-bottom: none; }
        .relevant-contact-item a {
            color: #667eea;
            text-decoration: none;
        }
        .relevant-contact-item a:hover { text-decoration: underline; }
        .relevant-contact-type {
            font-size: 12px;
            color: #666;
        }
        .no-contacts-message {
            color: #999;
            font-style: italic;
            padding: 15px;
            text-align: center;
        }
        
        /* Section header with button */
        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .section-header-row h4 {
            margin: 0;
            border: none;
            padding: 0;
        }
        
        /* Scan History Section */
        .scan-history-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .scan-history-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        .scan-history-date {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        /* v24: SCAN & SCRAPE STATUS STYLES (kept for alert cards)                 */
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        /* Status Summary Box */
        .scan-status-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .scan-status-box h4 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
            color: #495057;
        }
        .scan-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .scan-stat {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .scan-stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: #333;
        }
        .scan-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        /* Alert Boxes - Keep prominent yellow for TOU! */
        .scan-alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .scan-alert-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }
        .scan-alert-content {
            flex: 1;
        }
        .scan-alert-title {
            font-weight: 700;
            margin-bottom: 5px;
        }
        .scan-alert-detail {
            font-size: 13px;
            color: #555;
        }
        .scan-alert.alert-tou {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        .scan-alert.alert-tou .scan-alert-title { color: #856404; }
        
        /* v25: Detailed TOU Alert Card Styles */
        .scan-alert.alert-tou.tou-detailed {
            display: block;
            padding: 0;
        }
        .tou-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            border-bottom: 1px solid #f0d78c;
            background: #fff8e1;
            border-radius: 8px 8px 0 0;
        }
        .tou-title {
            font-weight: 700;
            font-size: 16px;
            color: #856404;
        }
        .tou-date {
            font-size: 13px;
            color: #997a00;
            font-weight: 500;
        }
        .tou-section-label {
            font-size: 11px;
            font-weight: 700;
            color: #6c5a00;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .tou-pages-section {
            padding: 15px 18px;
            border-bottom: 1px solid #f0d78c;
        }
        .tou-page-item {
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 13px;
        }
        .tou-page-item.clear {
            background: #d4edda;
            color: #155724;
        }
        .tou-page-item.restriction {
            background: #fff;
            color: #856404;
            border: 1px solid #ffc107;
            font-weight: 600;
        }
        .tou-prohibitions-section {
            padding: 15px 18px;
            border-bottom: 1px solid #f0d78c;
        }
        .tou-prohibitions {
            margin: 0;
            padding-left: 20px;
        }
        .tou-prohibitions li {
            font-size: 13px;
            color: #664d00;
            margin: 5px 0;
        }
        .tou-quote-section {
            padding: 15px 18px;
            border-bottom: 1px solid #f0d78c;
        }
        .tou-quote {
            background: #fff;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin: 8px 0;
            font-style: italic;
            font-size: 13px;
            color: #5a4a00;
            border-radius: 0 6px 6px 0;
        }
        .tou-quote-source {
            font-size: 12px;
            color: #997a00;
            text-align: right;
        }
        .tou-source-link {
            padding: 12px 18px;
            background: #fff8e1;
            border-radius: 0 0 8px 8px;
        }
        .tou-source-link a {
            color: #856404;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }
        .tou-source-link a:hover {
            text-decoration: underline;
        }
        
        .scan-alert.alert-block {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        .scan-alert.alert-block .scan-alert-title { color: #721c24; }
        .scan-alert.alert-js {
            background: #cce5ff;
            border: 2px solid #17a2b8;
        }
        .scan-alert.alert-js .scan-alert-title { color: #004085; }
        .scan-alert.alert-denied {
            background: #f5c6cb;
            border: 2px solid #c82333;
        }
        .scan-alert.alert-denied .scan-alert-title { color: #721c24; }
        .scan-alert.alert-success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .scan-alert.alert-success .scan-alert-title { color: #155724; }
        
        /* Scan History Accordion */
        .scan-history-accordion {
            margin-top: 15px;
        }
        .scan-history-toggle {
            background: #e9ecef;
            border: none;
            padding: 12px 20px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .scan-history-toggle:hover {
            background: #dee2e6;
        }
        .scan-history-toggle .arrow {
            transition: transform 0.2s;
        }
        .scan-history-toggle.expanded .arrow {
            transform: rotate(180deg);
        }
        .scan-history-content {
            display: none;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        .scan-history-content.show {
            display: block;
        }
        
        /* Individual Scan Log Entry */
        /* Scan History Entry - Card Design (2026-01-26) */
        .scan-log-entry {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .scan-log-entry:last-child {
            margin-bottom: 0;
        }
        
        /* Header with date and scan type */
        .scan-entry-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #555;
        }
        .scan-entry-header strong {
            color: #333;
        }
        
        /* Flag section with checkbox and quote */
        .scan-flag-section {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .scan-flag-section:last-child {
            border-bottom: none;
        }
        .scan-flag-section.has-restriction {
            background: #fffbf0;
        }
        .scan-flag-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .scan-flag-header input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .scan-flag-header label {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }
        .scan-flag-header.flag-tou label { color: #856404; }
        .scan-flag-header.flag-block label { color: #721c24; }
        .scan-flag-header.flag-js label { color: #0056b3; }
        
        /* Quote box for restriction text */
        .scan-quote-box {
            background: #fff8e1;
            border: 1px solid #ffe082;
            border-left: 4px solid #f57c00;
            border-radius: 4px;
            padding: 10px 12px;
            margin: 8px 0 8px 24px;
            font-size: 12px;
            line-height: 1.5;
        }
        .scan-quote-box .quote-text {
            color: #333;
            font-style: italic;
        }
        .scan-quote-box .quote-source {
            margin-top: 6px;
            font-size: 11px;
        }
        .scan-quote-box .quote-source a {
            color: #0066cc;
            text-decoration: none;
        }
        .scan-quote-box .quote-source a:hover {
            text-decoration: underline;
        }
        
        /* Pages scanned list */
        .scan-pages-list {
            margin-left: 24px;
            margin-top: 8px;
        }
        .scan-page-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            margin-bottom: 3px;
        }
        .scan-page-item.page-clear {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .scan-page-item.page-restrictions {
            background: #fff3e0;
            color: #e65100;
        }
        .scan-page-item.page-blocked {
            background: #ffebee;
            color: #c62828;
        }
        .scan-page-item.page-error {
            background: #f5f5f5;
            color: #757575;
        }
        
        /* JS Rendering alert box */
        .scan-js-alert {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 10px 12px;
            margin: 8px 0 8px 24px;
        }
        .scan-js-alert-title {
            font-weight: 600;
            color: #1565c0;
            font-size: 13px;
        }
        .scan-js-alert-detail {
            font-size: 12px;
            color: #1976d2;
            margin-top: 4px;
        }
        
        /* Empty state for scan history */
        .scan-history-empty {
            text-align: center;
            padding: 30px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2>ğŸ” Admin Login</h2>
            <div id="loginMessage" class="message hidden"></div>
            <form id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPassword" required></div>
                <button type="submit" class="btn btn-full">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header" onclick="goHome()">
                <img src="logo.png" alt="Event Finder Logo" class="header-logo">
                <div class="header-text">
                    <h1>Event Finder Admin</h1>
                    <p>National Security Events Database Management</p>
                </div>
            </div>

            <div id="mainTabs" class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š Dashboard</button>
                <button class="tab" onclick="switchTab('byStatus')">ğŸ“‹ Org By Status</button>
                <button class="tab" onclick="switchTab('organizations')">ğŸ›ï¸ Organizations</button>
                <button class="tab" onclick="switchTab('contacts')">ğŸ‘¤ Contacts</button>
                <button class="tab" onclick="switchTab('events')">ğŸ“… Events</button>
                <button class="tab" onclick="switchTab('icons')">ğŸ–¼ï¸ Icons</button>
            </div>

            <div id="mainContent">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card"><h3 id="statOrgs">-</h3><p>Total Organizations</p></div>
                        <div class="stat-card info"><h3 id="statEvents">-</h3><p>Events</p></div>
                        <div class="stat-card success"><h3 id="statContacts">-</h3><p>ğŸ‘¤ Contacts</p></div>
                        <div class="stat-card warning"><h3 id="statPending">-</h3><p>ğŸŸ£ Nominated</p></div>
                        <div class="stat-card success"><h3 id="statLive">-</h3><p>âœ… Live (Scraping)</p></div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);"><h3 id="statRestrictions">-</h3><p>ğŸŸ  Has Restrictions</p></div>
                        <div class="stat-card danger"><h3 id="statTechBlocked">-</h3><p>â›” Tech Blocked</p></div>
                        <div class="stat-card danger"><h3 id="statPermissionDenied">-</h3><p>ğŸš« Declined</p></div>
                        <div class="stat-card danger"><h3 id="statNoContacts">-</h3><p>âŒ No Contacts</p></div>
                        <div class="stat-card warning"><h3 id="statDuplicates">-</h3><p>ğŸ” Duplicates</p></div>
                    </div>
                    <div id="dashboardContent"><div class="loading">Loading dashboard...</div></div>
                </div>

                <!-- Organization By Status Tab -->
                <div id="byStatus" class="tab-content">
                    <div class="section-header">
                        <h2>ğŸ“‹ Organizations By Status</h2>
                        <button class="btn btn-small btn-secondary" onclick="loadByStatus()">ğŸ”„ Refresh</button>
                    </div>
                    <div class="filters">
                        <select id="filterByStatus" onchange="loadByStatus()">
                            <option value="">ğŸ“‹ Workflow Status...</option>
                            <option value="Nominated (Pending Mission Review)">ğŸŸ£ Nominated (Pending Mission Review)</option>
                            <option value="Mission Approved (Request Not Sent)">ğŸ”µ Mission Approved (Request Not Sent)</option>
                            <option value="Permission Requested (Pending Org Response)">ğŸŸ¡ Permission Requested (Pending Org Response)</option>
                            <option value="Permission Granted (Not Live)">ğŸŸ¢ Permission Granted (Not Live)</option>
                            <option value="Rejected by Mission">ğŸ”´ Rejected by Mission</option>
                            <option value="Rejected by Org">â›” Rejected by Org</option>
                            <option value="Live (Scraping Active)">âœ… Live (Scraping Active)</option>
                            <option value="duplicates">ğŸ” Duplicates Only</option>
                        </select>
                        <select id="filterByRestrictions" onchange="loadByRestrictions()">
                            <option value="">ğŸŸ  Orgs with Restrictions...</option>
                            <option value="restricted-nominated">ğŸŸ  Nominated - Restricted!</option>
                            <option value="restricted-approved">ğŸŸ  Mission Approved - Restricted!</option>
                            <option value="restricted-requested">ğŸŸ  Permission Requested - Restricted!</option>
                            <option value="restricted-granted">ğŸŸ  Permission Granted - Restricted!</option>
                            <option value="restricted-rejected-mission">ğŸŸ  Rejected by Mission - Restricted!</option>
                            <option value="restricted-rejected-org">ğŸŸ  Rejected by Org - Restricted!</option>
                        </select>
                    </div>
                    <div id="byStatusMessage" class="message info hidden"></div>
                    <div id="byStatusList"><div class="loading">Loading organizations...</div></div>
                </div>

                <!-- Organizations Tab -->
                <div id="organizations" class="tab-content">
                    <div class="section-header">
                        <h2>ğŸ›ï¸ All Organizations</h2>
                        <button class="btn" onclick="addNewOrganization()">â• Add Organization</button>
                    </div>
                    <div class="filters">
                        <input type="text" id="orgSearchBox" placeholder="ğŸ” Quick search by name..." style="min-width: 200px;" oninput="filterOrgsByName()">
                        <select id="orgJumpToName" onchange="jumpToOrgByName()">
                            <option value="">ğŸ“ Jump to Organization...</option>
                        </select>
                        <select id="orgFilterByStatus" onchange="filterOrgsByStatus()">
                            <option value="">ğŸ“Š Filter by Status...</option>
                            <option value="Nominated (Pending Mission Review)">ğŸŸ£ Nominated</option>
                            <option value="Mission Approved (Request Not Sent)">ğŸ”µ Mission Approved</option>
                            <option value="Permission Requested (Pending Org Response)">ğŸŸ¡ Permission Requested</option>
                            <option value="Permission Granted (Not Live)">ğŸŸ¢ Permission Granted</option>
                            <option value="Rejected by Mission">ğŸ”´ Rejected by Mission</option>
                            <option value="Rejected by Org">â›” Rejected by Org</option>
                            <option value="Live (Scraping Active)">âœ… Live</option>
                        </select>
                        <select id="orgFilterByContacts" onchange="filterOrgsByContacts()">
                            <option value="">ğŸ‘¤ Filter by Contacts...</option>
                            <option value="none">âŒ No Contacts</option>
                            <option value="has">âœ… Has Contacts</option>
                        </select>
                    </div>
                    <div id="organizationsMessage" class="message info hidden"></div>
                    <div id="organizationsList"><div class="loading">Loading organizations...</div></div>
                </div>

                <!-- Contacts Tab -->
                <div id="contacts" class="tab-content">
                    <div class="section-header">
                        <h2>ğŸ‘¤ Contacts</h2>
                        <button class="btn" onclick="openAddContactModal()">â• Add Contact</button>
                    </div>
                    <div class="filters">
                        <select id="filterContactOrg" onchange="loadContacts()">
                            <option value="">ğŸ¢ All Organizations</option>
                            <option value="none">âŒ No Org</option>
                        </select>
                    </div>
                    <div id="contactsList"><div class="loading">Loading contacts...</div></div>
                </div>

                <!-- Events Tab -->
                <div id="events" class="tab-content">
                    <div class="section-header"><h2>ğŸ“… Events</h2></div>
                    <div class="filters">
                        <select id="filterEventStatus" onchange="loadEvents()">
                            <option value="">All Statuses</option>
                            <option value="nominated">ğŸ“‹ Nominated (Needs Review)</option>
                            <option value="approved">âœ… Approved</option>
                            <option value="rejected">âŒ Rejected</option>
                        </select>
                        <select id="filterEventOrg" onchange="loadEvents()">
                            <option value="">All Organizations</option>
                        </select>
                        <select id="sortEvents" onchange="loadEvents()">
                            <option value="-start_date">ğŸ“… Date (Newest First)</option>
                            <option value="start_date">ğŸ“… Date (Oldest First)</option>
                            <option value="org-asc">ğŸ¢ Organization (A-Z)</option>
                            <option value="org-desc">ğŸ¢ Organization (Z-A)</option>
                            <option value="-created">ğŸ• Recently Added</option>
                        </select>
                    </div>
                    <div id="eventsList"><div class="loading">Loading events...</div></div>
                </div>

                <!-- Icons Tab -->
                <div id="icons" class="tab-content">
                    <div class="section-header">
                        <h2>ğŸ–¼ï¸ Topic Icons</h2>
                        <button class="btn btn-small btn-secondary" onclick="loadIcons()">ğŸ”„ Refresh</button>
                    </div>
                    <div class="icon-stats" id="iconStats"></div>
                    <div class="filters">
                        <select id="filterIconStatus" onchange="loadIcons()">
                            <option value="all">ğŸ“‹ All Icons</option>
                            <option value="has-icon">âœ… Has Icon</option>
                            <option value="no-icon">âŒ Missing Icon</option>
                        </select>
                    </div>
                    <div id="iconsList"><div class="loading">Loading icons...</div></div>
                </div>
            </div>

            <!-- Organization Profile Page -->
            <div id="orgProfilePage" class="tab-content hidden" style="display: none;">
                <div class="profile-header">
                    <div>
                        <h2 id="profileOrgName">Organization Name</h2>
                        <p class="org-status" id="profileOrgStatus">Status</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info" onclick="openScanOrgModal()" id="scanOrgBtn">ğŸ” Scan Org</button>
                        <button class="btn btn-secondary" onclick="closeOrgProfile()">â† Back to List</button>
                        <button class="btn btn-danger" onclick="deleteOrganization()" id="deleteOrgBtn">ğŸ—‘ï¸ Delete Org</button>
                    </div>
                </div>

                <div class="profile-tabs">
                    <button class="profile-tab active" onclick="switchProfileTab('overview')">ğŸ“‹ Overview</button>
                    <button class="profile-tab" onclick="switchProfileTab('profileContacts')">ğŸ‘¤ Contacts</button>
                    <button class="profile-tab" onclick="switchProfileTab('statusHistory')">ğŸ“œ Status & History</button>
                    <button class="profile-tab" onclick="switchProfileTab('profileEvents')">ğŸ“… Events</button>
                </div>

                <div id="profileMessage" class="message info hidden"></div>

                <!-- Overview Tab -->
                <div id="overview" class="profile-tab-content active">
                    <form id="profileOverviewForm">
                        <input type="hidden" id="profileOrgId">
                        <div id="profileAlerts"></div>

                        <div class="section-box">
                            <h4>ğŸ“‹ Basic Information</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Organization Name *</label><input type="text" id="profileName" required></div>
                                <div class="form-group"><label>Type</label><input type="text" id="profileType" placeholder="e.g., Government, Nonprofit, Think Tank"></div>
                            </div>
                            <div class="form-group"><label>Description</label><textarea id="profileDescription"></textarea></div>
                        </div>

                        <div class="section-box">
                            <h4>ğŸŒ Web Information</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Website</label><input type="url" id="profileWebsite"></div>
                                <div class="form-group"><label>Source ID (Domain)</label><input type="text" id="profileSourceId" placeholder="e.g., csis.org"></div>
                            </div>
                            <div class="form-group"><label>Events URL</label><input type="url" id="profileEventsUrl"></div>
                        </div>

                        <div class="section-box">
                            <h4>ğŸ“Š Status</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Current Status *</label>
                                    <select id="profileStatus" required>
                                        <option value="Nominated (Pending Mission Review)">ğŸŸ£ Nominated (Pending Mission Review)</option>
                                        <option value="Mission Approved (Request Not Sent)">ğŸ”µ Mission Approved (Request Not Sent)</option>
                                        <option value="Permission Requested (Pending Org Response)">ğŸŸ¡ Permission Requested (Pending Org Response)</option>
                                        <option value="Permission Granted (Not Live)">ğŸŸ¢ Permission Granted (Not Live)</option>
                                        <option value="Rejected by Mission">ğŸ”´ Rejected by Mission</option>
                                        <option value="Rejected by Org">â›” Rejected by Org</option>
                                        <option value="Live (Scraping Active)">âœ… Live (Scraping Active)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Permission Type</label>
                                    <select id="profilePermissionType">
                                        <option value="">-- Not Set --</option>
                                        <option value="Explicit">âœ… Explicit (Org Approved)</option>
                                        <option value="Implied (No Response)">â±ï¸ Implied (No Response)</option>
                                        <option value="Waiver">ğŸ”“ Waiver (Flags exist, but approved)</option>
                                        <option value="Denied">ğŸš« Denied (Org explicitly declined)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Event Policy</label>
                                    <select id="profileEventPolicy">
                                        <option value="">-- Not Set --</option>
                                        <option value="accept_all">ğŸ”“ Accept All (scrape all events)</option>
                                        <option value="propose_events">ğŸ“‹ Propose Events (review before adding)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <!-- Placeholder for alignment -->
                                </div>
                            </div>
                        </div>

                        <div class="card-actions">
                            <button type="submit" class="btn btn-success">ğŸ’¾ Save Overview</button>
                        </div>
                    </form>
                </div>

                <!-- Contacts Tab -->
                <div id="profileContacts" class="profile-tab-content">
                    <div class="section-box">
                        <h4>ğŸ›ï¸ Organization Info</h4>
                        <div id="profileContactsOrgInfo"></div>
                    </div>
                    <div class="section-header">
                        <h4>ğŸ‘¤ Contacts</h4>
                        <div>
                            <select id="profileContactsSort" onchange="loadProfileContacts()" style="padding: 8px; border-radius: 6px; margin-right: 10px;">
                                <option value="lastName">Sort by Last Name</option>
                                <option value="firstName">Sort by First Name</option>
                            </select>
                            <button class="btn btn-small" onclick="addContactForCurrentOrg()">â• Add Contact</button>
                        </div>
                    </div>
                    <div id="profileContactsList"><div class="loading">Loading contacts...</div></div>
                </div>

                <!-- Status & History Tab (v25 - Streamlined for Partner Engagement Specialists) -->
                <div id="statusHistory" class="profile-tab-content">
                    <div id="statusAlerts"></div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- SECTION 1: STATUS + RELEVANT CONTACTS (Two Column)                      -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div class="status-contacts-grid">
                        <!-- Left Column: Status & Flags -->
                        <div class="section-box">
                            <h4>ğŸ“‹ Status</h4>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="statusDropdown" class="inline-status-select" style="width: 100%;" onchange="changeOrgStatus()">
                                    <option value="Nominated (Pending Mission Review)">ğŸŸ£ Nominated (Pending Mission Review)</option>
                                    <option value="Mission Approved (Request Not Sent)">ğŸ”µ Mission Approved (Request Not Sent)</option>
                                    <option value="Permission Requested (Pending Org Response)">ğŸŸ¡ Permission Requested (Pending Org Response)</option>
                                    <option value="Permission Granted (Not Live)">ğŸŸ¢ Permission Granted (Not Live)</option>
                                    <option value="Rejected by Mission">ğŸ”´ Rejected by Mission</option>
                                    <option value="Rejected by Org">â›” Rejected by Org</option>
                                    <option value="Live (Scraping Active)">âœ… Live (Scraping Active)</option>
                                </select>
                            </div>
                            
                            <!-- Read-only Flags (derived from scans) -->
                            <div class="flags-readonly">
                                <div id="flagTouRow" class="flag-row">
                                    <input type="checkbox" id="flagTouDisplay" disabled>
                                    <span>âš ï¸ TOU Restriction</span>
                                </div>
                                <div id="flagJsRow" class="flag-row">
                                    <input type="checkbox" id="flagJsDisplay" disabled>
                                    <span>âš™ï¸ Tech-Rendered Site</span>
                                </div>
                                <div id="flagBlockRow" class="flag-row">
                                    <input type="checkbox" id="flagBlockDisplay" disabled>
                                    <span>â›” Technical Block (403)</span>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: #999; margin-top: 10px;">
                                ğŸ’¡ Flags are set automatically by the scanner and cannot be edited here.
                            </p>
                        </div>
                        
                        <!-- Right Column: Relevant Contacts -->
                        <div class="section-box">
                            <h4>ğŸ“‡ Relevant Contacts</h4>
                            <div id="relevantContactsList">
                                <div class="no-contacts-message">Loading contacts...</div>
                            </div>
                            <p style="font-size: 11px; color: #999; margin-top: 10px;">
                                ğŸ’¡ Showing Legal/Permissions, Events, and Main Contact types only.
                            </p>
                        </div>
                    </div>

                    <!-- Duplicate Info Box (read-only, set by quality-audit.js) -->
                    <div id="duplicateInfoBox" class="section-box hidden" style="background: #f3e8ff; border: 2px solid #6f42c1;">
                        <h4>ğŸ” Duplicate Organization</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">This organization was flagged as a duplicate by the quality audit script.</p>
                        <p><strong>Duplicate of:</strong> <a href="#" id="duplicateOfLink" onclick="openOrgProfile(currentOrg.duplicate_of); return false;"><span id="duplicateOfName">-</span></a></p>
                        <p style="margin-top: 10px; font-size: 12px; color: #856404;">ğŸ’¡ Consider merging data into the primary org and then deleting this record.</p>
                    </div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- SECTION 2: CORRESPONDENCE LOG                                           -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div class="section-box" id="correspondenceLogSection">
                        <div class="section-header-row">
                            <h4>ğŸ“¬ Correspondence Log</h4>
                            <button type="button" class="btn btn-small btn-info" onclick="toggleAddCorrespondence()">â• Add Correspondence</button>
                        </div>
                        
                        <!-- Add Correspondence Accordion -->
                        <div id="addCorrespondenceSection" class="corr-accordion hidden">
                            <div class="corr-accordion-header">
                                <button type="button" class="corr-type-btn" data-type="phone" onclick="selectCorrType('phone')">
                                    ğŸ“ Phone Call
                                </button>
                                <button type="button" class="corr-type-btn" data-type="email-out" onclick="selectCorrType('email-out')">
                                    ğŸ“¤ Email Outreach
                                </button>
                                <button type="button" class="corr-type-btn" data-type="email-in" onclick="selectCorrType('email-in')">
                                    ğŸ“¥ Email Response
                                </button>
                            </div>
                            
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <!-- PHONE CALL PANEL                                                -->
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <div id="corrPanelPhone" class="corr-panel">
                                <h5>ğŸ“ Log Phone Call</h5>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Date of Call</label>
                                        <input type="date" id="phoneCallDate">
                                    </div>
                                    <div class="form-group">
                                        <label>Follow-up Needed By (optional)</label>
                                        <input type="date" id="phoneFollowupDate">
                                    </div>
                                </div>
                                
                                <div class="recommended-contact">
                                    <label>ğŸ“‡ Recommended Contact</label>
                                    <div id="phoneRecommendedContact" class="contact-info">Loading...</div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Actual Contact Called</label>
                                        <select id="phoneContactSelect" class="inline-status-select" style="width: 100%;">
                                            <option value="">-- Select contact --</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Or Enter Other</label>
                                        <input type="text" id="phoneContactOther" placeholder="Name if not in list...">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Recommended Phone Number</label>
                                    <input type="text" id="phoneRecommendedNumber" readonly style="background: #f0f0f0;">
                                </div>
                                
                                <div class="draft-generator-box">
                                    <h6>ğŸ“ Call Notes Generator</h6>
                                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Generate talking points based on this org's restrictions.</p>
                                    <button type="button" class="btn btn-small btn-info" onclick="generateCallNotes()">ğŸ“ Generate Talking Points</button>
                                    <div class="form-group" style="margin-top: 10px;">
                                        <textarea id="phoneCallNotesDraft" class="draft-textarea" style="min-height: 120px;" placeholder="Click 'Generate Talking Points' or type your own notes..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Call Notes (what was discussed)</label>
                                    <textarea id="phoneCallNotes" placeholder="Summarize the call - who answered, what was discussed, outcome, next steps..." style="min-height: 120px;"></textarea>
                                </div>
                                
                                <div class="card-actions">
                                    <button type="button" class="btn btn-small btn-success" onclick="saveCorrespondence('phone')">ğŸ’¾ Save Phone Call</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="cancelAddCorrespondence()">Cancel</button>
                                </div>
                            </div>
                            
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <!-- EMAIL OUTREACH PANEL                                            -->
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <div id="corrPanelEmailOut" class="corr-panel">
                                <h5>ğŸ“¤ Log Email Outreach</h5>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Date of Email</label>
                                        <input type="date" id="emailOutDate">
                                    </div>
                                    <div class="form-group">
                                        <label>Follow-up Needed By (optional)</label>
                                        <input type="date" id="emailOutFollowupDate">
                                    </div>
                                </div>
                                
                                <div class="recipient-section">
                                    <label>ğŸ“‡ Select Recipients <span style="font-weight: normal; color: #666;">(check all that apply)</span></label>
                                    <div id="emailOutContactCheckboxes" class="contact-checkboxes" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin: 8px 0; max-height: 200px; overflow-y: auto;">
                                        Loading contacts...
                                    </div>
                                    
                                    <div class="form-group" style="margin-top: 10px;">
                                        <label>â• Add Other Recipients <span style="font-weight: normal; color: #666;">(comma-separated)</span></label>
                                        <input type="text" id="emailOutContactOther" placeholder="email1@example.com, email2@example.com">
                                    </div>
                                    
                                    <div class="form-group" style="margin-top: 10px;">
                                        <label>ğŸ“¬ To: <span style="font-weight: normal; color: #666;">(auto-populated from selections above)</span></label>
                                        <input type="text" id="emailOutToField" readonly style="background: #e9ecef; font-family: monospace; font-size: 13px;" placeholder="Select recipients above...">
                                        <button type="button" class="btn btn-small btn-secondary" onclick="copyToField()" style="margin-top: 5px;">ğŸ“‹ Copy To: Field</button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Subject Line</label>
                                    <input type="text" id="emailOutSubject" placeholder="Email subject...">
                                </div>
                                
                                <div class="draft-generator-box">
                                    <h6>ğŸ“ Email Draft Generator</h6>
                                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Auto-generates TOU-aware email based on org restrictions.</p>
                                    <button type="button" class="btn btn-small btn-info" onclick="generateEmailDraft()">ğŸ“ Generate Draft</button>
                                    <button type="button" class="btn btn-small btn-copy" onclick="copyDraft('emailOutDraft')" style="margin-left: 5px;">ğŸ“‹ Copy</button>
                                    <div class="form-group" style="margin-top: 10px;">
                                        <textarea id="emailOutDraft" class="draft-textarea" placeholder="Click 'Generate Draft' to create email..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Final Text Sent <span style="font-weight: normal; color: #666;">(the actual email you sent)</span></label>
                                    <textarea id="emailOutFinal" class="draft-textarea" placeholder="Paste or type the final email text you actually sent..."></textarea>
                                </div>
                                
                                <div class="card-actions">
                                    <button type="button" class="btn btn-small btn-success" onclick="saveCorrespondence('email-out')">ğŸ’¾ Save Email Outreach</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="cancelAddCorrespondence()">Cancel</button>
                                </div>
                            </div>
                            
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <!-- EMAIL RESPONSE PANEL                                            -->
                            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                            <div id="corrPanelEmailIn" class="corr-panel">
                                <h5>ğŸ“¥ Log Email Response</h5>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Date of Response</label>
                                        <input type="date" id="emailInDate">
                                    </div>
                                    <div class="form-group">
                                        <label>Follow-up Needed By (optional)</label>
                                        <input type="date" id="emailInFollowupDate">
                                    </div>
                                </div>
                                
                                <div class="recommended-contact">
                                    <label>ğŸ“‡ Known Contacts at This Org</label>
                                    <div id="emailInKnownContacts" class="contact-info">Loading...</div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Who Responded?</label>
                                        <select id="emailInContactSelect" class="inline-status-select" style="width: 100%;">
                                            <option value="">-- Select known contact --</option>
                                            <option value="__other__">â• Other (enter below)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Or Enter New Contact</label>
                                        <input type="text" id="emailInContactOther" placeholder="Name / email of responder...">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Subject Line</label>
                                    <input type="text" id="emailInSubject" placeholder="RE: Permission Request...">
                                </div>
                                
                                <div class="form-group">
                                    <label>Response Text <span style="font-weight: normal; color: #666;">(paste the email they sent)</span></label>
                                    <textarea id="emailInText" class="draft-textarea" placeholder="Paste the full response email here..."></textarea>
                                </div>
                                
                                <div class="card-actions">
                                    <button type="button" class="btn btn-small btn-success" onclick="saveCorrespondence('email-in')">ğŸ’¾ Save Response</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="cancelAddCorrespondence()">Cancel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Correspondence Timeline -->
                        <div id="correspondenceTimeline">
                            <p style="color: #999; text-align: center; padding: 20px;">No correspondence logged yet.</p>
                        </div>
                    </div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- SECTION 3: SCANNING AND SCRAPING HISTORY                               -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div class="scan-history-section">
                        <h4>ğŸ” Scanning and Scraping History</h4>
                        <div id="scanHistoryAlerts">
                            <!-- Alert cards populated by JS based on current flags -->
                        </div>
                        <div id="scanHistoryList">
                            <div class="scan-history-empty">
                                <p>ğŸ“‹ No scan history available yet.</p>
                                <p style="font-size: 12px; margin-top: 5px;">Scan logs will appear here after running the scanner.</p>
                            </div>
                        </div>
                    </div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- SECTION 4: NOTES                                                        -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div class="section-box">
                        <h4>ğŸ“ Notes</h4>
                        <form id="notesForm">
                            <div class="form-group">
                                <textarea id="orgNotes" placeholder="Notes about this organization (contact follow-ups, special instructions, observations, etc.)..." style="min-height: 120px;"></textarea>
                            </div>
                            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                                ğŸ’¡ Use this field for any human commentary. Technical scan results are tracked in the Scan History above.
                            </p>
                            <button type="submit" class="btn btn-small btn-success">ğŸ’¾ Save Notes</button>
                        </form>
                    </div>
                </div>


                <!-- Events Tab -->
                <div id="profileEvents" class="profile-tab-content">
                    <div class="section-box">
                        <h4>ğŸ›ï¸ Organization Info</h4>
                        <div id="profileEventsOrgInfo"></div>
                    </div>
                    <div class="section-header">
                        <h4>ğŸ“… Events</h4>
                        <span id="profileEventCount" class="badge badge-live">0 events</span>
                    </div>
                    <div id="profileEventsList"><div class="loading">Loading events...</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Contact</h2>
                <button class="modal-close" onclick="closeModal('addContactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addContactForm">
                    <div class="form-group"><label>Organization *</label><select id="contactOrg" required><option value="">-- Select --</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Name *</label><input type="text" id="contactName" required></div>
                        <div class="form-group"><label>Title/Role</label><input type="text" id="contactTitle"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="contactEmail" oninput="autoSuggestOrgFromEmail(this.value)">
                            <small id="emailOrgSuggestion" style="color: #28a745; display: none;"></small>
                        </div>
                        <div class="form-group"><label>Phone</label><input type="text" id="contactPhone"></div>
                    </div>
                    <div class="form-group">
                        <label>Contact Type</label>
                        <select id="contactType">
                            <option value="">-- Select Type --</option>
                            <option value="Main Contact">Main Contact</option>
                            <option value="Leadership">Leadership</option>
                            <option value="Events">Events</option>
                            <option value="Legal/Permissions">Legal/Permissions</option>
                            <option value="Media/PR">Media/PR</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Notes</label><textarea id="contactNotes"></textarea></div>
                    <div class="card-actions">
                        <button type="submit" class="btn btn-success">ğŸ’¾ Add Contact</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="editContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Contact</h2>
                <button class="modal-close" onclick="closeModal('editContactModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" id="editContactId">
                    <div class="form-group"><label>Organization</label><input type="text" id="editContactOrgName" readonly style="background: #f0f0f0;"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Name *</label><input type="text" id="editContactName" required></div>
                        <div class="form-group"><label>Title/Role</label><input type="text" id="editContactTitle"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Email</label><input type="email" id="editContactEmail"></div>
                        <div class="form-group"><label>Phone</label><input type="text" id="editContactPhone"></div>
                    </div>
                    <div class="form-group">
                        <label>Contact Type</label>
                        <select id="editContactType">
                            <option value="">-- Select Type --</option>
                            <option value="Main Contact">Main Contact</option>
                            <option value="Leadership">Leadership</option>
                            <option value="Events">Events</option>
                            <option value="Legal/Permissions">Legal/Permissions</option>
                            <option value="Media/PR">Media/PR</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Notes</label><textarea id="editContactNotes"></textarea></div>
                    <div class="card-actions">
                        <button type="submit" class="btn btn-success">ğŸ’¾ Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editContactModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preview Draft Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“§ Permission Request Preview</h2>
                <button class="modal-close" onclick="closeModal('previewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="previewContent" style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;"></pre>
            </div>
        </div>
    </div>

    <!-- Scan Org Modal -->
    <div id="scanOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ” Scan Organization</h2>
                <button class="modal-close" onclick="closeModal('scanOrgModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-box">
                    <p><strong>ğŸ“‹ What this does:</strong></p>
                    <p>â€¢ Scans TOU/Privacy pages for scraping restrictions</p>
                    <p>â€¢ Checks for technical blocks (403/401 errors)</p>
                    <p>â€¢ Detects JavaScript-rendered sites</p>
                    <p>â€¢ Discovers events page URL</p>
                    <p>â€¢ Gathers POC contact information (up to 5 categories)</p>
                    <p>â€¢ Updates organization record with findings</p>
                </div>

                <div class="section-box" style="margin-top: 20px;">
                    <h4>ğŸ–¥ï¸ Run in PowerShell</h4>
                    <p style="margin-bottom: 15px; color: #666;">Copy this command and paste it in your PowerShell terminal:</p>
                    
                    <div style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; position: relative;">
                        <code id="scanCommandText">node scrapers/adhoc-scanner.js --org "Organization Name"</code>
                        <button onclick="copyScanCommand()" style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px;">ğŸ“‹ Copy</button>
                    </div>
                    <p id="scanCommandCopied" style="color: #28a745; margin-top: 10px; display: none;">âœ… Command copied to clipboard!</p>
                </div>

                <div class="section-box" style="margin-top: 20px;">
                    <h4>âš™ï¸ Scan Options</h4>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" id="scanForceContacts" onchange="updateScanCommand()">
                            <strong>Force Contact Gathering</strong> - Search all 5 contact categories even if org already has contacts
                        </label>
                    </div>
                    <div class="info-box success" style="margin-top: 15px;">
                        <p><strong>ğŸ”’ Safety Guarantee:</strong></p>
                        <p>â€¢ Contact gathering ALWAYS uses Google Search only</p>
                        <p>â€¢ We NEVER scrape org websites for contacts</p>
                        <p>â€¢ TOU/tech scans only check their policy pages (not content)</p>
                    </div>
                </div>

                <div class="info-box warning" style="margin-top: 20px;">
                    <p><strong>âš ï¸ Google API Quota:</strong> Contact gathering uses up to 5 Google queries per scan. Daily free limit is 100 queries.</p>
                </div>

                <div class="card-actions" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="copyScanCommand()">ğŸ“‹ Copy Command</button>
                    <button class="btn btn-secondary" onclick="closeModal('scanOrgModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const POCKETBASE_URL = 'https://event-discovery-backend-production.up.railway.app';
        let authToken = null;
        let allOrganizations = [];
        let allContacts = [];
        let currentOrgId = null;
        let currentOrg = null;
        let previousTab = 'byStatus';
        let isNewOrg = false;

        const STATUS_CONFIG = {
            'Nominated (Pending Mission Review)': { icon: 'ğŸŸ£', badge: 'badge-nominated', cardClass: 'status-nominated' },
            'Mission Approved (Request Not Sent)': { icon: 'ğŸ”µ', badge: 'badge-approved', cardClass: 'status-approved' },
            'Permission Requested (Pending Org Response)': { icon: 'ğŸŸ¡', badge: 'badge-requested', cardClass: 'status-requested' },
            'Permission Granted (Not Live)': { icon: 'ğŸŸ¢', badge: 'badge-granted', cardClass: 'status-granted' },
            'Rejected by Mission': { icon: 'ğŸ”´', badge: 'badge-rejected', cardClass: 'status-rejected' },
            'Rejected by Org': { icon: 'â›”', badge: 'badge-rejected', cardClass: 'status-rejected' },
            'Live (Scraping Active)': { icon: 'âœ…', badge: 'badge-live', cardClass: 'status-live' }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTHENTICATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/admins/auth-with-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identity: email, password: password })
                });
                if (!response.ok) throw new Error('Invalid credentials');
                const data = await response.json();
                authToken = data.token;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadDashboard();
            } catch (error) {
                messageDiv.textContent = 'âŒ ' + error.message;
                messageDiv.className = 'message error';
                messageDiv.classList.remove('hidden');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TAB NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tabName) {
            document.getElementById('orgProfilePage').classList.add('hidden');
            document.getElementById('orgProfilePage').style.display = 'none';
            document.getElementById('mainTabs').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');

            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#mainContent > .tab-content').forEach(content => content.classList.remove('active'));
            
            const tabButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (tabButton) tabButton.classList.add('active');
            
            const tabContent = document.getElementById(tabName);
            if (tabContent) tabContent.classList.add('active');

            previousTab = tabName;

            switch(tabName) {
                case 'dashboard': loadDashboard(); break;
                case 'byStatus': loadByStatus(); break;
                case 'organizations': loadOrganizations(); break;
                case 'contacts': loadContacts(); break;
                case 'events': loadEvents(); break;
                case 'icons': loadIcons(); break;
            }
        }

        function switchProfileTab(tabName) {
            document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.profile-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchProfileTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'profileContacts') loadProfileContacts();
            if (tabName === 'profileEvents') loadProfileEvents();
            if (tabName === 'statusHistory') loadStatusHistory();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ORGANIZATION PROFILE PAGE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function openOrgProfile(orgId, targetTab = 'overview') {
            currentOrgId = orgId;
            isNewOrg = false;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, { headers: { 'Authorization': authToken } });
                currentOrg = await response.json();

                document.getElementById('mainTabs').classList.add('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('orgProfilePage').classList.remove('hidden');
                document.getElementById('orgProfilePage').style.display = 'block';

                document.getElementById('profileOrgName').textContent = currentOrg.name;
                const config = STATUS_CONFIG[currentOrg.status] || { icon: 'â“' };
                document.getElementById('profileOrgStatus').innerHTML = `${config.icon} ${currentOrg.status || 'Unknown'}`;
                
                // Show delete button for existing orgs
                document.getElementById('deleteOrgBtn').style.display = 'inline-block';
                // Show scan button for existing orgs
                document.getElementById('scanOrgBtn').style.display = 'inline-block';

                populateOverviewTab(currentOrg);
                switchProfileTab(targetTab);

            } catch (error) {
                alert('Error loading organization: ' + error.message);
            }
        }

        function addNewOrganization() {
            isNewOrg = true;
            currentOrgId = null;
            currentOrg = {
                name: '',
                org_type: '',
                description: '',
                website: '',
                source_id: '',
                events_url: '',
                status: 'Nominated (Pending Mission Review)',
                permission_type: '',
                tou_flag: false,
                tech_block_flag: false,
                tech_rendering_flag: false,
                duplicate_flag: false,
                duplicate_of: '',
                tou_notes: '',
                scrape_notes: '',
                ai_reasoning: '',
                permission_requested_date: '',
                permission_response_date: '',
                permission_request_draft: '',
                permission_correspondence: '',
                scraping_enabled: false,
                notes: ''
            };

            document.getElementById('mainTabs').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('orgProfilePage').classList.remove('hidden');
            document.getElementById('orgProfilePage').style.display = 'block';

            document.getElementById('profileOrgName').textContent = 'New Organization';
            document.getElementById('profileOrgStatus').innerHTML = 'ğŸŸ£ Nominated (Pending Mission Review)';
            
            // Hide delete button for new orgs
            document.getElementById('deleteOrgBtn').style.display = 'none';
            // Hide scan button for new orgs (no website to scan yet)
            document.getElementById('scanOrgBtn').style.display = 'none';

            populateOverviewTab(currentOrg);
            switchProfileTab('overview');
        }

        function closeOrgProfile() {
            document.getElementById('orgProfilePage').classList.add('hidden');
            document.getElementById('orgProfilePage').style.display = 'none';
            document.getElementById('mainTabs').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            currentOrgId = null;
            currentOrg = null;
            isNewOrg = false;
            switchTab(previousTab);
        }

        /**
         * Delete an organization after confirmation
         * Warns about associated events and contacts
         */
        async function deleteOrganization() {
            if (!currentOrg || !currentOrgId) {
                alert('âŒ No organization selected');
                return;
            }

            const orgName = currentOrg.name;

            // First, check for associated events and contacts
            let eventCount = 0;
            let contactCount = 0;

            try {
                // Count events
                const eventsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records?filter=(organization='${currentOrgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (eventsRes.ok) {
                    const eventsData = await eventsRes.json();
                    eventCount = eventsData.totalItems || 0;
                }

                // Count contacts
                const contactsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${currentOrgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (contactsRes.ok) {
                    const contactsData = await contactsRes.json();
                    contactCount = contactsData.totalItems || 0;
                }
            } catch (error) {
                console.error('Error checking related records:', error);
            }

            // Build confirmation message
            let confirmMsg = `ğŸ—‘ï¸ DELETE ORGANIZATION\n\n`;
            confirmMsg += `Are you sure you want to delete "${orgName}"?\n\n`;

            if (eventCount > 0 || contactCount > 0) {
                confirmMsg += `âš ï¸ WARNING: This org has associated records:\n`;
                if (eventCount > 0) confirmMsg += `   â€¢ ${eventCount} event(s)\n`;
                if (contactCount > 0) confirmMsg += `   â€¢ ${contactCount} contact(s)\n`;
                confirmMsg += `\nThese will become orphaned (not deleted).\n`;
            }

            confirmMsg += `\nThis action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Second confirmation for safety
            const typeToConfirm = prompt(`Type the organization name to confirm deletion:\n\n"${orgName}"`);
            if (typeToConfirm !== orgName) {
                alert('âŒ Deletion cancelled - name did not match');
                return;
            }

            // Perform deletion
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': authToken }
                    }
                );

                if (response.ok) {
                    alert(`âœ… Organization "${orgName}" deleted successfully`);
                    closeOrgProfile();
                } else {
                    const error = await response.json();
                    alert(`âŒ Delete failed: ${JSON.stringify(error)}`);
                }
            } catch (error) {
                alert(`âŒ Error deleting organization: ${error.message}`);
            }
        }

        function goHome() {
            // If on profile page, close it first
            if (document.getElementById('orgProfilePage').style.display === 'block') {
                document.getElementById('orgProfilePage').classList.add('hidden');
                document.getElementById('orgProfilePage').style.display = 'none';
            }
            currentOrgId = null;
            currentOrg = null;
            isNewOrg = false;
            switchTab('dashboard');
        }

        function populateOverviewTab(org) {
            document.getElementById('profileOrgId').value = org.id || '';
            document.getElementById('profileName').value = org.name || '';
            document.getElementById('profileType').value = org.org_type || '';
            document.getElementById('profileDescription').value = org.description || '';
            document.getElementById('profileWebsite').value = org.website || '';
            document.getElementById('profileSourceId').value = org.source_id || '';
            document.getElementById('profileEventsUrl').value = org.events_url || '';
            document.getElementById('profileStatus').value = org.status || 'Nominated (Pending Mission Review)';
            document.getElementById('profilePermissionType').value = org.permission_type || '';
            document.getElementById('profileEventPolicy').value = org.event_policy || '';

            const alertsDiv = document.getElementById('profileAlerts');
            let alertsHtml = '';
            if (org.tech_block_flag) {
                alertsHtml += `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests (403 Forbidden).</p></div>`;
            }
            if (org.tou_flag && !org.tech_block_flag) {
                alertsHtml += `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(org.tou_notes) || 'May prohibit scraping'}</p></div>`;
            }
            if (org.tech_rendering_flag) {
                alertsHtml += `<div class="info-box" style="background: #e9ecef; border-color: #6c757d;"><p>âš™ï¸ <strong>Tech-Rendered Site:</strong> Events page requires headless browser (Puppeteer) to scrape.</p></div>`;
            }
            if (org.duplicate_flag) {
                alertsHtml += `<div class="info-box" style="background: #f3e8ff; border-color: #6f42c1;"><p>ğŸ” <strong>Duplicate:</strong> This organization is flagged as a duplicate. See Status & History tab for details.</p></div>`;
            }
            alertsDiv.innerHTML = alertsHtml;
        }

        document.getElementById('profileOverviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('profileName').value,
                org_type: document.getElementById('profileType').value,
                description: document.getElementById('profileDescription').value,
                website: document.getElementById('profileWebsite').value,
                source_id: document.getElementById('profileSourceId').value,
                events_url: document.getElementById('profileEventsUrl').value,
                status: document.getElementById('profileStatus').value,
                permission_type: document.getElementById('profilePermissionType').value || null,
                event_policy: document.getElementById('profileEventPolicy').value || null
            };

            try {
                let response;
                if (isNewOrg) {
                    response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                        body: JSON.stringify(data)
                    });
                    const newOrg = await response.json();
                    currentOrgId = newOrg.id;
                    currentOrg = newOrg;
                    isNewOrg = false;
                    document.getElementById('profileOrgId').value = newOrg.id;
                } else {
                    response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                        body: JSON.stringify(data)
                    });
                    currentOrg = { ...currentOrg, ...data };
                }
                
                document.getElementById('profileOrgName').textContent = data.name;
                const config = STATUS_CONFIG[data.status] || { icon: 'â“' };
                document.getElementById('profileOrgStatus').innerHTML = `${config.icon} ${data.status}`;
                
                showMessage('profileMessage', isNewOrg ? 'âœ… Organization created!' : 'âœ… Overview saved!', 'success');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROFILE - CONTACTS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadProfileContacts() {
            const container = document.getElementById('profileContactsList');
            const orgInfoDiv = document.getElementById('profileContactsOrgInfo');
            container.innerHTML = '<div class="loading">Loading contacts...</div>';

            // Org info section
            const config = STATUS_CONFIG[currentOrg.status] || { icon: 'â“', badge: '' };
            let alertsHtml = '';
            if (currentOrg.tech_block_flag) {
                alertsHtml = `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests.</p></div>`;
            } else if (currentOrg.tou_flag) {
                alertsHtml = `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(currentOrg.tou_notes) || 'May prohibit scraping'}</p></div>`;
            }
            if (currentOrg.tech_rendering_flag) {
                alertsHtml += `<div class="info-box" style="background: #e9ecef; border-color: #6c757d;"><p>âš™ï¸ <strong>Tech-Rendered Site:</strong> Requires Puppeteer to scrape.</p></div>`;
            }
            orgInfoDiv.innerHTML = `
                ${alertsHtml}
                <p><strong>Organization:</strong> ${escapeHtml(currentOrg.name)}</p>
                <p><strong>Status:</strong> <span class="badge ${config.badge}">${config.icon} ${currentOrg.status}</span></p>
            `;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${currentOrgId}')`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                let contacts = data.items || [];

                // Sort contacts
                const sortBy = document.getElementById('profileContactsSort').value;
                contacts.sort((a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    if (sortBy === 'lastName') {
                        const lastA = nameA.split(' ').pop().toLowerCase();
                        const lastB = nameB.split(' ').pop().toLowerCase();
                        return lastA.localeCompare(lastB);
                    } else {
                        return nameA.toLowerCase().localeCompare(nameB.toLowerCase());
                    }
                });

                if (contacts.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ‘¤</div><h3>No Contacts Yet</h3></div>`;
                    return;
                }

                container.innerHTML = contacts.map(c => `
                    <div class="contact-card">
                        <h5>${escapeHtml(c.name)} ${c.contact_type ? `<span class="badge">${escapeHtml(c.contact_type)}</span>` : ''}</h5>
                        ${c.title ? `<p><strong>Role/Position:</strong> ${escapeHtml(c.title)}</p>` : ''}
                        ${c.email ? `<p><strong>Email:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></p>` : '<p><strong>Email:</strong> <span style="color: #dc3545;">Not set</span></p>'}
                        ${c.phone ? `<p><strong>Phone:</strong> ${escapeHtml(c.phone)}</p>` : ''}
                        ${c.notes ? `<p><strong>Notes:</strong> ${escapeHtml(c.notes)}</p>` : ''}
                        <div class="contact-actions">
                            <button class="btn btn-small" onclick="editContact('${c.id}')">âœï¸ Edit Contact</button>
                            <button class="btn btn-small btn-danger" onclick="deleteContact('${c.id}', true)">ğŸ—‘ï¸ Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        function addContactForCurrentOrg() {
            document.getElementById('contactOrg').innerHTML = `<option value="${currentOrgId}" selected>${escapeHtml(currentOrg.name)}</option>`;
            document.getElementById('addContactForm').reset();
            document.getElementById('contactOrg').value = currentOrgId;
            openModal('addContactModal');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROFILE - STATUS & HISTORY TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadStatusHistory() {
            if (!currentOrg) return;

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // v25: STATUS DROPDOWN
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            document.getElementById('statusDropdown').value = currentOrg.status || 'Nominated (Pending Mission Review)';

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // v25: READ-ONLY FLAGS DISPLAY
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const flagTouRow = document.getElementById('flagTouRow');
            const flagJsRow = document.getElementById('flagJsRow');
            const flagBlockRow = document.getElementById('flagBlockRow');
            
            document.getElementById('flagTouDisplay').checked = currentOrg.tou_flag || false;
            document.getElementById('flagJsDisplay').checked = currentOrg.tech_rendering_flag || false;
            document.getElementById('flagBlockDisplay').checked = currentOrg.tech_block_flag || false;
            
            // Apply active styling
            flagTouRow.className = currentOrg.tou_flag ? 'flag-row flag-active tou' : 'flag-row';
            flagJsRow.className = currentOrg.tech_rendering_flag ? 'flag-row flag-active js-render' : 'flag-row';
            flagBlockRow.className = currentOrg.tech_block_flag ? 'flag-row flag-active tech-block' : 'flag-row';

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // v25: NOTES SECTION
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            document.getElementById('orgNotes').value = currentOrg.notes || '';

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // v25: DUPLICATE INFO BOX
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const duplicateInfoBox = document.getElementById('duplicateInfoBox');
            if (currentOrg.duplicate_flag && currentOrg.duplicate_of) {
                duplicateInfoBox.classList.remove('hidden');
                fetchDuplicateOfName(currentOrg.duplicate_of);
            } else {
                duplicateInfoBox.classList.add('hidden');
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // v25: LOAD CORRESPONDENCE, RELEVANT CONTACTS & SCAN HISTORY
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            loadCorrespondenceContacts();
            loadRelevantContacts();
            loadCorrespondenceTimeline();
            loadScanHistoryWithAlerts();
        }

        /**
         * v25: Load and display relevant contacts (filtered to priority types)
         */
        async function loadRelevantContacts() {
            const container = document.getElementById('relevantContactsList');
            if (!container) return;
            
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${currentOrgId}')`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                const allContacts = data.items || [];
                
                // Filter to priority types only: Legal/Permissions, Events, Main Contact
                const priorityTypes = ['Legal/Permissions', 'Events', 'Main Contact'];
                const filteredContacts = allContacts.filter(c => priorityTypes.includes(c.contact_type));
                
                // Type icons
                const typeIcon = {
                    'Legal/Permissions': 'âš–ï¸',
                    'Events': 'ğŸ“…',
                    'Main Contact': 'ğŸ‘¤'
                };
                
                if (filteredContacts.length === 0) {
                    container.innerHTML = '<div class="no-contacts-message">No Legal/Permissions, Events, or Main Contact found.<br>Add contacts in the Contacts tab.</div>';
                    return;
                }
                
                container.innerHTML = filteredContacts.map(c => {
                    const icon = typeIcon[c.contact_type] || 'ğŸ“§';
                    return `
                        <div class="relevant-contact-item">
                            <div class="relevant-contact-type">${icon} ${c.contact_type}</div>
                            ${c.email ? `<div><strong>Email:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></div>` : ''}
                            ${c.name ? `<div style="font-size: 12px; color: #666;">${escapeHtml(c.name)}${c.title ? ' - ' + escapeHtml(c.title) : ''}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading relevant contacts:', error);
                container.innerHTML = '<div class="no-contacts-message">Error loading contacts.</div>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v25: TOU RESTRICTION PARSER & DISPLAY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Parse the raw restriction_context into structured data
         */
        function parseTouRestriction(org) {
            const result = {
                scanDate: org.tou_scanned_date ? new Date(org.tou_scanned_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Unknown',
                pages: [],
                keywords: [],
                keyQuote: '',
                sourceUrl: '',
                sourcePage: ''
            };
            
            const context = org.restriction_context || org.tou_notes || '';
            const sourceUrls = org.restriction_source_urls || '';
            
            // Extract source URL
            if (sourceUrls) {
                result.sourceUrl = sourceUrls.split('\n')[0].trim();
            }
            
            // Try to parse pages scanned
            // Format: "âœ… Privacy Policy: Clear" or "âš ï¸ Terms of Use: RESTRICTIONS (4 terms)"
            const pageMatches = context.matchAll(/([âœ…âš ï¸âŒ])\s*([^:]+):\s*(Clear|RESTRICTIONS[^âœ…âš ï¸âŒ]*)/g);
            const seenPages = new Set();
            for (const match of pageMatches) {
                const pageName = match[2].trim();
                // Deduplicate pages
                if (!seenPages.has(pageName)) {
                    seenPages.add(pageName);
                    result.pages.push({
                        icon: match[1],
                        name: pageName,
                        status: match[3].trim().startsWith('RESTRICTIONS') ? 'restriction' : 'clear',
                        detail: match[3].trim()
                    });
                }
            }
            
            // Extract keywords
            const keywordsMatch = context.match(/Keywords found:\s*([^\n]+)/i);
            if (keywordsMatch) {
                result.keywords = keywordsMatch[1].split(',').map(k => k.trim()).filter(k => k);
            }
            
            // Extract a clean quote from context
            // Look for [CONTEXT_CONFIRMED] patterns and extract the actual quote
            const contextMatches = context.matchAll(/\[([^\]]+)\]\s*\[CONTEXT_CONFIRMED\][^:]*:\s*\.\.\.([^\.]{20,150})\.\.\./g);
            for (const match of contextMatches) {
                if (!result.keyQuote) {
                    result.sourcePage = match[1];
                    // Clean up the quote - remove HTML entities and extra whitespace
                    let quote = match[2]
                        .replace(/&#\d+;/g, '') // Remove HTML entities like &#8220;
                        .replace(/&[a-z]+;/gi, '') // Remove named entities
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim();
                    result.keyQuote = quote;
                }
                break; // Just take the first good quote
            }
            
            // If no structured quote found, try to extract something readable
            if (!result.keyQuote && context) {
                // Look for quoted text or meaningful snippets
                const quoteMatch = context.match(/"([^"]{30,200})"/);
                if (quoteMatch) {
                    result.keyQuote = quoteMatch[1];
                }
            }
            
            return result;
        }
        
        /**
         * Build the clean TOU alert card HTML
         */
        function buildTouAlertCard(parsed, org) {
            // Build pages list HTML
            let pagesHtml = '';
            if (parsed.pages.length > 0) {
                pagesHtml = parsed.pages.map(p => {
                    if (p.status === 'restriction') {
                        return `<div class="tou-page-item restriction">âš ï¸ ${escapeHtml(p.name)} - Restrictions found</div>`;
                    } else {
                        return `<div class="tou-page-item clear">âœ… ${escapeHtml(p.name)} - Clear</div>`;
                    }
                }).join('');
            }
            
            // Build keywords/prohibitions list
            let prohibitionsHtml = '';
            if (parsed.keywords.length > 0) {
                const prohibitionDescriptions = {
                    'robots': 'Automated bots/robots',
                    'spiders': 'Web crawlers/spiders', 
                    'scraping': 'Data scraping',
                    'harvest': 'Data harvesting',
                    'automated': 'Automated access',
                    'data mining': 'Data mining',
                    'crawl': 'Web crawling',
                    'copy': 'Copying content',
                    'reproduce': 'Content reproduction',
                    'systematic': 'Systematic collection'
                };
                
                const prohibitions = parsed.keywords.map(k => {
                    const desc = prohibitionDescriptions[k.toLowerCase()] || k;
                    return `<li>${escapeHtml(desc)}</li>`;
                }).join('');
                prohibitionsHtml = `<ul class="tou-prohibitions">${prohibitions}</ul>`;
            }
            
            // Build key quote HTML
            let quoteHtml = '';
            if (parsed.keyQuote) {
                quoteHtml = `
                    <div class="tou-quote-section">
                        <div class="tou-section-label">ğŸ“œ KEY QUOTE</div>
                        <blockquote class="tou-quote">"${escapeHtml(parsed.keyQuote)}..."</blockquote>
                        ${parsed.sourcePage ? `<div class="tou-quote-source">â€” ${escapeHtml(parsed.sourcePage)}</div>` : ''}
                    </div>`;
            }
            
            // Build source link
            let sourceHtml = '';
            if (parsed.sourceUrl) {
                sourceHtml = `<div class="tou-source-link"><a href="${escapeHtml(parsed.sourceUrl)}" target="_blank">ğŸ”— View Source</a></div>`;
            }
            
            return `
                <div class="scan-alert alert-tou tou-detailed">
                    <div class="tou-header">
                        <div class="tou-title">âš ï¸ TOU Restriction Found</div>
                        <div class="tou-date">${escapeHtml(parsed.scanDate)}</div>
                    </div>
                    
                    ${pagesHtml ? `
                    <div class="tou-pages-section">
                        <div class="tou-section-label">ğŸ“„ PAGES SCANNED</div>
                        ${pagesHtml}
                    </div>` : ''}
                    
                    ${prohibitionsHtml ? `
                    <div class="tou-prohibitions-section">
                        <div class="tou-section-label">ğŸš« WHAT'S PROHIBITED</div>
                        ${prohibitionsHtml}
                    </div>` : ''}
                    
                    ${quoteHtml}
                    
                    ${sourceHtml}
                </div>`;
        }

        /**
         * v25: Populate scan history with alert cards at top
         */
        async function loadScanHistoryWithAlerts() {
            const alertContainer = document.getElementById('scanHistoryAlerts');
            const historyContainer = document.getElementById('scanHistoryList');
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CURRENT FLAG ALERTS (shown at top of history section)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (alertContainer) {
                let alertsHtml = '';
                
                // TOU Restriction - BRIGHT YELLOW with parsed details
                if (currentOrg.tou_flag) {
                    const parsed = parseTouRestriction(currentOrg);
                    alertsHtml += buildTouAlertCard(parsed, currentOrg);
                }
                
                // JS Rendering - BLUE
                if (currentOrg.tech_rendering_flag) {
                    alertsHtml += `
                        <div class="scan-alert alert-js">
                            <div class="scan-alert-icon">âš™ï¸</div>
                            <div class="scan-alert-content">
                                <div class="scan-alert-title">JavaScript Rendering Required</div>
                                <div class="scan-alert-detail">Events page requires a headless browser (Puppeteer) to scrape.</div>
                            </div>
                        </div>`;
                }
                
                // Tech Block - RED
                if (currentOrg.tech_block_flag) {
                    alertsHtml += `
                        <div class="scan-alert alert-block">
                            <div class="scan-alert-icon">â›”</div>
                            <div class="scan-alert-content">
                                <div class="scan-alert-title">Technical Block (403)</div>
                                <div class="scan-alert-detail">This organization actively blocks automated requests.</div>
                            </div>
                        </div>`;
                }
                
                alertContainer.innerHTML = alertsHtml;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SCAN HISTORY LOGS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (!historyContainer) return;
            
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/scan_logs/records?filter=(organization='${currentOrgId}')&sort=-scan_date&perPage=20`,
                    { headers: { 'Authorization': authToken } }
                );
                
                if (!response.ok) {
                    historyContainer.innerHTML = `
                        <div class="scan-history-empty">
                            <p>ğŸ“‹ No scan history available yet.</p>
                            <p style="font-size: 12px; margin-top: 5px;">Scan logs will appear here after running the scanner.</p>
                        </div>`;
                    return;
                }
                
                const data = await response.json();
                const logs = data.items || [];
                
                if (logs.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="scan-history-empty">
                            <p>ğŸ“‹ No scan history available yet.</p>
                            <p style="font-size: 12px; margin-top: 5px;">Scan logs will appear here after running the scanner.</p>
                        </div>`;
                    return;
                }
                
                historyContainer.innerHTML = logs.map(log => {
                    // Format date
                    const dateObj = new Date(log.scan_date);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { 
                        day: 'numeric', month: 'long', year: 'numeric'
                    });
                    const formattedTime = dateObj.toLocaleTimeString('en-US', {
                        hour: 'numeric', minute: '2-digit'
                    });
                    
                    // Get flags
                    const hasTou = log.tou_flag || log.restrictions_found;
                    const hasBlock = log.tech_block_flag || log.tech_block;
                    const hasJs = log.tech_rendering_flag || log.js_rendering;
                    
                    // Build pages scanned from legal_pages_results (new format)
                    // or fall back to parsing restriction_context (old format)
                    let pagesHtml = '';
                    let touQuoteHtml = '';
                    
                    if (log.legal_pages_results && Array.isArray(log.legal_pages_results) && log.legal_pages_results.length > 0) {
                        // NEW FORMAT: Structured per-page data
                        const pages = log.legal_pages_results;
                        
                        // Find pages with restrictions for quote display
                        const restrictedPages = pages.filter(p => p.result === 'restrictions');
                        if (restrictedPages.length > 0 && hasTou) {
                            touQuoteHtml = restrictedPages.map(p => `
                                <div class="scan-quote-box">
                                    <div class="quote-text">"${escapeHtml(p.quote || 'Restriction language detected')}"</div>
                                    <div class="quote-source">
                                        <strong>${escapeHtml(p.type)}</strong> - 
                                        <a href="${escapeHtml(p.url)}" target="_blank">${escapeHtml(p.url)} â†—</a>
                                    </div>
                                </div>
                            `).join('');
                        }
                        
                        // Build pages list
                        pagesHtml = pages.map(p => {
                            let itemClass = 'page-clear';
                            let icon = 'âœ…';
                            let label = 'Clear';
                            
                            if (p.result === 'restrictions') {
                                itemClass = 'page-restrictions';
                                icon = 'âš ï¸';
                                label = 'Restrictions found';
                            } else if (p.result === 'blocked') {
                                itemClass = 'page-blocked';
                                icon = 'â›”';
                                label = 'Blocked';
                            } else if (p.result === 'error') {
                                itemClass = 'page-error';
                                icon = 'âŒ';
                                label = 'Error';
                            }
                            
                            return `<div class="scan-page-item ${itemClass}">${icon} ${escapeHtml(p.type)} - ${label}</div>`;
                        }).join('');
                        
                    } else if (log.restriction_context && hasTou) {
                        // OLD FORMAT: Parse restriction_context string
                        // Format: "PageType | URL | Quote" per line
                        const lines = log.restriction_context.split('\n').filter(l => l.trim());
                        touQuoteHtml = lines.map(line => {
                            const parts = line.split(' | ');
                            if (parts.length >= 3) {
                                const [pageType, url, quote] = parts;
                                return `
                                    <div class="scan-quote-box">
                                        <div class="quote-text">"${escapeHtml(quote)}"</div>
                                        <div class="quote-source">
                                            <strong>${escapeHtml(pageType)}</strong> - 
                                            <a href="${escapeHtml(url)}" target="_blank">${escapeHtml(url)} â†—</a>
                                        </div>
                                    </div>
                                `;
                            }
                            return `<div class="scan-quote-box"><div class="quote-text">"${escapeHtml(line)}"</div></div>`;
                        }).join('');
                    }
                    
                    // Build TOU section
                    let touSectionHtml = `
                        <div class="scan-flag-section ${hasTou ? 'has-restriction' : ''}">
                            <div class="scan-flag-header flag-tou">
                                <input type="checkbox" ${hasTou ? 'checked' : ''} disabled>
                                <label>âš ï¸ TOU Restriction</label>
                            </div>
                            ${touQuoteHtml}
                            ${pagesHtml ? `<div class="scan-pages-list">${pagesHtml}</div>` : ''}
                        </div>
                    `;
                    
                    // Build Tech Block section
                    let blockSectionHtml = `
                        <div class="scan-flag-section ${hasBlock ? 'has-restriction' : ''}">
                            <div class="scan-flag-header flag-block">
                                <input type="checkbox" ${hasBlock ? 'checked' : ''} disabled>
                                <label>â›” Technical Block (403)</label>
                            </div>
                        </div>
                    `;
                    
                    // Build JS Rendering section
                    let jsSectionHtml = `
                        <div class="scan-flag-section ${hasJs ? 'has-restriction' : ''}">
                            <div class="scan-flag-header flag-js">
                                <input type="checkbox" ${hasJs ? 'checked' : ''} disabled>
                                <label>âš™ï¸ Tech-Rendered Site</label>
                            </div>
                            ${hasJs ? `
                                <div class="scan-js-alert">
                                    <div class="scan-js-alert-title">JavaScript Rendering Required</div>
                                    <div class="scan-js-alert-detail">Events page requires a headless browser (Puppeteer) to scrape.</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    return `
                        <div class="scan-log-entry">
                            <div class="scan-entry-header">
                                <strong>Date:</strong> ${formattedDate} ${formattedTime}<br>
                                <strong>Scan Type:</strong> ${escapeHtml(log.scan_type || 'Manual')}
                            </div>
                            ${touSectionHtml}
                            ${blockSectionHtml}
                            ${jsSectionHtml}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading scan history:', error);
                historyContainer.innerHTML = `
                    <div class="scan-history-empty">
                        <p>ğŸ“‹ No scan history available yet.</p>
                        <p style="font-size: 12px; margin-top: 5px;">Scan logs will appear here after running the scanner.</p>
                    </div>`;
            }
        }

        /**
         * Display restriction context if org has TOU restrictions
         * (Legacy function - now handled by loadScanHistoryWithAlerts)
         */
        function loadRestrictionContext() {
            loadScanHistoryWithAlerts();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // v23: CORRESPONDENCE ACCORDION FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let currentCorrType = null;
        let orgContacts = []; // Cache contacts for this org
        
        /**
         * Toggle the Add Correspondence accordion section
         */
        function toggleAddCorrespondence() {
            const section = document.getElementById('addCorrespondenceSection');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                // Reset - no type selected
                currentCorrType = null;
                document.querySelectorAll('.corr-type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.corr-panel').forEach(panel => panel.classList.remove('active'));
                // Set default dates to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('phoneCallDate').value = today;
                document.getElementById('emailOutDate').value = today;
                document.getElementById('emailInDate').value = today;
            } else {
                section.classList.add('hidden');
            }
        }
        
        /**
         * Select a correspondence type and show its panel
         */
        function selectCorrType(type) {
            currentCorrType = type;
            
            // Update button states
            document.querySelectorAll('.corr-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show appropriate panel
            document.getElementById('corrPanelPhone').classList.toggle('active', type === 'phone');
            document.getElementById('corrPanelEmailOut').classList.toggle('active', type === 'email-out');
            document.getElementById('corrPanelEmailIn').classList.toggle('active', type === 'email-in');
            
            // Load contacts into the appropriate selects
            loadCorrespondenceContacts();
        }
        
        /**
         * Cancel adding correspondence - hide the accordion
         */
        function cancelAddCorrespondence() {
            document.getElementById('addCorrespondenceSection').classList.add('hidden');
            currentCorrType = null;
        }
        
        /**
         * Load contacts for all correspondence panels
         */
        async function loadCorrespondenceContacts() {
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${currentOrgId}')`,
                    { headers: { 'Authorization': authToken } }
                );
                const data = await response.json();
                orgContacts = data.items || [];
                
                // Priority order for contact types
                const priority = {
                    'Legal/Permissions': 1,
                    'Events': 2,
                    'Main Contact': 3,
                    'Media/PR': 4,
                    'Other': 5,
                    'Leadership': 6
                };
                
                // Sort by priority, then by name
                orgContacts.sort((a, b) => {
                    const priorityA = priority[a.contact_type] || 99;
                    const priorityB = priority[b.contact_type] || 99;
                    if (priorityA !== priorityB) return priorityA - priorityB;
                    return (a.name || '').localeCompare(b.name || '');
                });
                
                // Type icons
                const typeIcon = {
                    'Legal/Permissions': 'âš–ï¸',
                    'Events': 'ğŸ“…',
                    'Main Contact': 'ğŸ‘¤',
                    'Media/PR': 'ğŸ“°',
                    'Leadership': 'ğŸ‘”',
                    'Other': 'ğŸ“§'
                };
                
                // Build options HTML for dropdowns (phone and email-in)
                let optionsHtml = '<option value="">-- Select contact --</option>';
                orgContacts.forEach(c => {
                    const icon = typeIcon[c.contact_type] || 'ğŸ“§';
                    const emailDisplay = c.email || 'no email';
                    const label = `${icon} ${c.name || 'Unknown'} (${c.contact_type}) - ${emailDisplay}`;
                    optionsHtml += `<option value="${c.id}" data-name="${escapeHtml(c.name || '')}" data-email="${escapeHtml(c.email || '')}" data-phone="${escapeHtml(c.phone || '')}" data-type="${escapeHtml(c.contact_type || '')}">${escapeHtml(label)}</option>`;
                });
                
                // Options with "Other" for email response
                let optionsWithOther = optionsHtml + '<option value="__other__">â• Other (enter below)</option>';
                
                // Populate select elements (phone and email-in still use dropdowns)
                document.getElementById('phoneContactSelect').innerHTML = optionsHtml;
                document.getElementById('emailInContactSelect').innerHTML = optionsWithOther;
                
                // Build checkboxes HTML for email-out (multi-select)
                const checkboxContainer = document.getElementById('emailOutContactCheckboxes');
                const contactsWithEmail = orgContacts.filter(c => c.email);
                
                if (contactsWithEmail.length > 0) {
                    checkboxContainer.innerHTML = contactsWithEmail.map(c => {
                        const icon = typeIcon[c.contact_type] || 'ğŸ“§';
                        return `
                            <label class="contact-checkbox-item" data-email="${escapeHtml(c.email || '')}" data-name="${escapeHtml(c.name || '')}" data-id="${c.id}">
                                <input type="checkbox" name="emailRecipients" value="${c.id}" data-email="${escapeHtml(c.email || '')}" data-name="${escapeHtml(c.name || '')}">
                                <span class="contact-info-text">
                                    ${icon} <strong>${escapeHtml(c.name || 'Unknown')}</strong> â€” ${escapeHtml(c.email)}
                                </span>
                                <span class="contact-type-badge">${escapeHtml(c.contact_type)}</span>
                            </label>
                        `;
                    }).join('');
                    
                    // Add event listeners to checkboxes
                    checkboxContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', updateToField);
                    });
                    
                    // Also listen to the "Other" field
                    document.getElementById('emailOutContactOther').addEventListener('input', updateToField);
                } else {
                    checkboxContainer.innerHTML = '<span style="color: #999; padding: 10px;">No contacts with email addresses found. Add contacts first or use "Other Recipients" below.</span>';
                }
                
                // Update recommended contact displays (for phone and email-in)
                updateRecommendedContacts();
                
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }
        
        /**
         * Update the recommended contact displays in each panel
         */
        function updateRecommendedContacts() {
            const typeIcon = {
                'Legal/Permissions': 'âš–ï¸',
                'Events': 'ğŸ“…',
                'Main Contact': 'ğŸ‘¤',
                'Media/PR': 'ğŸ“°',
                'Leadership': 'ğŸ‘”',
                'Other': 'ğŸ“§'
            };
            
            // Phone: Show first contact with phone number
            const phoneContactDiv = document.getElementById('phoneRecommendedContact');
            const phoneNumberInput = document.getElementById('phoneRecommendedNumber');
            const contactWithPhone = orgContacts.find(c => c.phone);
            if (contactWithPhone) {
                phoneContactDiv.innerHTML = `${typeIcon[contactWithPhone.contact_type] || 'ğŸ“§'} <strong>${escapeHtml(contactWithPhone.name)}</strong> (${contactWithPhone.contact_type})`;
                phoneNumberInput.value = contactWithPhone.phone || '';
            } else {
                phoneContactDiv.innerHTML = '<span style="color: #999;">No contacts with phone numbers found</span>';
                phoneNumberInput.value = '';
            }
            
            // Email In: Show all known contacts
            const emailInDiv = document.getElementById('emailInKnownContacts');
            if (orgContacts.length > 0) {
                emailInDiv.innerHTML = orgContacts.map(c => 
                    `<div style="margin: 4px 0;">${typeIcon[c.contact_type] || 'ğŸ“§'} <strong>${escapeHtml(c.name)}</strong> ${c.email ? '- ' + escapeHtml(c.email) : ''}</div>`
                ).join('');
            } else {
                emailInDiv.innerHTML = '<span style="color: #999;">No contacts on file for this organization</span>';
            }
        }
        
        /**
         * Update the To: field based on selected checkboxes and other emails
         */
        function updateToField() {
            const selectedEmails = [];
            
            // Get emails from checked checkboxes
            document.querySelectorAll('#emailOutContactCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                const email = cb.dataset.email;
                if (email) selectedEmails.push(email);
            });
            
            // Get emails from "Other" field (comma-separated)
            const otherField = document.getElementById('emailOutContactOther').value.trim();
            if (otherField) {
                const otherEmails = otherField.split(',').map(e => e.trim()).filter(e => e.includes('@'));
                selectedEmails.push(...otherEmails);
            }
            
            // Update the To: field
            const toField = document.getElementById('emailOutToField');
            if (selectedEmails.length > 0) {
                toField.value = selectedEmails.join('; ');
            } else {
                toField.value = '';
            }
            
            // Update checkbox item styling
            document.querySelectorAll('#emailOutContactCheckboxes .contact-checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                item.classList.toggle('selected', checkbox.checked);
            });
        }
        
        /**
         * Copy the To: field to clipboard
         */
        function copyToField() {
            const toField = document.getElementById('emailOutToField');
            if (!toField.value) {
                showMessage('profileMessage', 'âš ï¸ No recipients selected', 'warning');
                return;
            }
            navigator.clipboard.writeText(toField.value).then(() => {
                showMessage('profileMessage', 'âœ… To: field copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showMessage('profileMessage', 'âŒ Copy failed', 'error');
            });
        }
        
        /**
         * Get all selected recipients (for saving correspondence)
         */
        function getSelectedRecipients() {
            const recipients = [];
            
            // Get contacts from checked checkboxes
            document.querySelectorAll('#emailOutContactCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                recipients.push({
                    id: cb.value,
                    name: cb.dataset.name || '',
                    email: cb.dataset.email || ''
                });
            });
            
            // Get emails from "Other" field
            const otherField = document.getElementById('emailOutContactOther').value.trim();
            if (otherField) {
                const otherEmails = otherField.split(',').map(e => e.trim()).filter(e => e.includes('@'));
                otherEmails.forEach(email => {
                    recipients.push({
                        id: null,
                        name: '',
                        email: email
                    });
                });
            }
            
            return recipients;
        }
        
        /**
         * Update phone number when a contact is selected
         */
        document.addEventListener('change', function(e) {
            if (e.target.id === 'phoneContactSelect') {
                const selected = e.target.options[e.target.selectedIndex];
                const phone = selected?.dataset?.phone || '';
                document.getElementById('phoneRecommendedNumber').value = phone;
            }
        });
        
        /**
         * Populate the flag dashboard with visual indicators
         */
        function populateFlagDashboard() {
            const dashboard = document.getElementById('flagDashboard');
            if (!dashboard) return;
            
            const flags = [
                { id: 'tou', label: 'TOU Restriction', icon: 'âš ï¸', value: currentOrg.tou_flag, class: 'flag-on-tou' },
                { id: 'block', label: 'Tech Block (403)', icon: 'â›”', value: currentOrg.tech_block_flag, class: 'flag-on-block' },
                { id: 'js', label: 'JS Rendering', icon: 'âš™ï¸', value: currentOrg.tech_rendering_flag, class: 'flag-on-js' },
                { id: 'denied', label: 'Permission Denied', icon: 'ğŸš«', value: currentOrg.permission_type === 'Denied', class: 'flag-on-denied' }
            ];
            
            dashboard.innerHTML = flags.map(flag => {
                const isOn = flag.value === true;
                return `<div class="flag-item ${isOn ? flag.class : 'flag-off'}">
                    ${flag.icon} ${flag.label}: <strong>${isOn ? 'YES' : 'No'}</strong>
                </div>`;
            }).join('');
        }
        
        /**
         * Load and display restriction details if TOU flag is set
         */
        function loadRestrictionDetails() {
            const detailsBox = document.getElementById('restrictionDetailsBox');
            const detailsList = document.getElementById('restrictionDetailsList');
            
            if (!detailsBox || !detailsList) return;
            
            if (currentOrg.tou_flag && (currentOrg.restriction_source_urls || currentOrg.restriction_context)) {
                const sourceLines = (currentOrg.restriction_source_urls || '').split('\n').filter(line => line.trim());
                const contextLines = (currentOrg.restriction_context || '').split('\n').filter(line => line.trim());
                
                let detailsHtml = '';
                sourceLines.forEach((url, index) => {
                    const context = contextLines[index] || contextLines[0] || 'Restriction found';
                    // Detect source type from URL
                    let sourceType = 'Legal Page';
                    const urlLower = url.toLowerCase();
                    if (urlLower.includes('privacy')) sourceType = 'Privacy Policy';
                    else if (urlLower.includes('terms') || urlLower.includes('tos')) sourceType = 'Terms of Use';
                    else if (urlLower.includes('copyright')) sourceType = 'Copyright Page';
                    
                    detailsHtml += `<div class="restriction-item">
                        <p><strong>${sourceType}:</strong> <a href="${escapeHtml(url)}" target="_blank">${escapeHtml(url)}</a></p>
                        <p style="color: #666; font-style: italic; margin-top: 5px;">"${escapeHtml(context)}"</p>
                    </div>`;
                });
                
                if (detailsHtml) {
                    detailsList.innerHTML = detailsHtml;
                    detailsBox.classList.remove('hidden');
                } else {
                    detailsBox.classList.add('hidden');
                }
            } else {
                detailsBox.classList.add('hidden');
            }
        }
        
        /**
         * Generate call notes/talking points for phone outreach
         */
        function generateCallNotes() {
            const orgName = currentOrg.name;
            const hasTouRestriction = currentOrg.tou_flag;
            const hasTechBlock = currentOrg.tech_block_flag;
            
            let notes = `CALL NOTES - ${orgName}\n`;
            notes += `${'â•'.repeat(40)}\n\n`;
            
            notes += `INTRODUCTION:\n`;
            notes += `â€¢ "Hi, my name is [YOUR NAME] from BalanceFWD."\n`;
            notes += `â€¢ "We're building a service to help people find events related to national security and defense."\n`;
            notes += `â€¢ "I'm reaching out about including ${orgName}'s public events in our directory."\n\n`;
            
            if (hasTouRestriction || hasTechBlock) {
                notes += `REASON FOR CALL:\n`;
                if (hasTouRestriction) {
                    notes += `â€¢ "We noticed your website terms mention restrictions on automated access."\n`;
                    notes += `â€¢ "We wanted to request permission directly rather than assume it's okay."\n`;
                }
                if (hasTechBlock) {
                    notes += `â€¢ "We encountered technical blocks when trying to access your events page."\n`;
                    notes += `â€¢ "We're hoping to find a way to work together."\n`;
                }
                notes += `\n`;
            }
            
            notes += `OUR COMMITMENT:\n`;
            notes += `â€¢ All event listings will link directly to your pages\n`;
            notes += `â€¢ ${orgName} will be clearly credited as the source\n`;
            notes += `â€¢ We'll respect your servers (rate-limited, off-peak access)\n`;
            notes += `â€¢ We'll stop immediately if you ever request it\n\n`;
            
            notes += `ASK:\n`;
            notes += `â€¢ "Would you be able to grant us permission to include your events?"\n`;
            notes += `â€¢ "Is there someone specific I should follow up with?"\n`;
            notes += `â€¢ "Would you prefer I send this request via email?"\n\n`;
            
            notes += `FOLLOW-UP:\n`;
            notes += `â€¢ Get contact name and email for follow-up\n`;
            notes += `â€¢ Offer to send written confirmation of our commitments\n`;
            
            document.getElementById('phoneCallNotesDraft').value = notes;
            showMessage('profileMessage', 'ğŸ“ Call talking points generated!', 'success');
        }
        
        /**
         * Generate email draft (moved from old generatePermissionDraft)
         * Updated: Now includes To: field with all selected recipients
         */
        function generateEmailDraft() {
            const orgName = currentOrg.name;
            const hasTouRestriction = currentOrg.tou_flag && currentOrg.restriction_context;
            const hasTechBlock = currentOrg.tech_block_flag;
            const hasTechRendering = currentOrg.tech_rendering_flag;
            const hasAnyRestriction = currentOrg.tou_flag || hasTechBlock || hasTechRendering;
            
            const restrictionContext = currentOrg.restriction_context || '';
            
            // Get selected recipients from To: field
            const toField = document.getElementById('emailOutToField').value.trim();
            const toLine = toField ? `To: ${toField}` : 'To: [Select recipients above]';
            
            // Calculate proceed date (1 week from now)
            const proceedDate = new Date();
            proceedDate.setDate(proceedDate.getDate() + 7);
            const proceedDateStr = proceedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let draft;
            let subject;
            
            if (hasAnyRestriction) {
                // Build restriction bullets from structured data
                // NEW FORMAT (2026-01-26): "PageType | URL | Quote" per line
                let restrictionBullets = '';
                
                // Handle TOU restriction
                if (currentOrg.tou_flag) {
                    if (restrictionContext) {
                        const contextLines = restrictionContext.split('\n').filter(line => line.trim());
                        
                        contextLines.forEach(line => {
                            const parts = line.split(' | ');
                            if (parts.length >= 3) {
                                // New format: PageType | URL | Quote
                                const [pageType, url, quote] = parts;
                                restrictionBullets += `â€¢ Your ${pageType} states: "${quote.trim()}"\n  ${url.trim()}\n\n`;
                            } else if (parts.length === 1 && line.trim()) {
                                // Old format: just the context text
                                restrictionBullets += `â€¢ Your website states: "${line.trim()}"\n\n`;
                            }
                        });
                    }
                    
                    // Fallback if tou_flag is set but no valid restriction bullets were generated
                    if (!restrictionBullets) {
                        restrictionBullets += `â€¢ Your website's terms restrict automated gathering of information.\n\n`;
                    }
                }
                
                if (hasTechBlock) {
                    restrictionBullets += `â€¢ Your website blocks automated access (returns 403 Forbidden).\n`;
                }
                
                if (hasTechRendering) {
                    restrictionBullets += `â€¢ Your events page requires JavaScript to display content.\n`;
                }
                
                subject = `Permission Request: Event Listing from ${orgName}`;
                draft = `${toLine}
Subject: ${subject}

Hello,

We are developing a site to help users quickly find events related to national security, defense, and intelligence. We would like to request permission to include ${orgName}'s publicly-listed events in this service.

Looking at your website, we noticed the following:

${restrictionBullets.trim()}

Given these factors, we wanted to reach out directly to request permission rather than proceed without authorization.

If granted permission, we will ensure that:
â€¢ All event listings link directly to your original event pages
â€¢ ${orgName} is clearly credited as the source
â€¢ Our access respects your server (rate-limited, off-peak hours)
â€¢ We immediately stop if you request it at any time

Would you please reply with a quick note giving us permission to proceed?

Thank you for your time and consideration.

Regards,`;
            } else {
                subject = `Notice: Automated Event Collection from ${orgName}`;
                draft = `${toLine}
Subject: ${subject}

Hello,

We are developing a site to help users quickly find events related to national security, defense, and intelligence. We would like to include ${orgName}'s publicly-listed events in this service.

${orgName}'s website terms did not appear to restrict gathering this information. We believe this work will drive additional visitors to your site and events. Additionally, we will ensure that:
â€¢ All listings will link directly to your original event pages
â€¢ ${orgName} is clearly credited as the source
â€¢ Our access respects your server (rate-limited, off-peak hours)
â€¢ We immediately stop if you request it at any time

We wanted to notify you before we begin, so you have the opportunity to decline or set specific terms. We plan to proceed on ${proceedDateStr} unless we hear otherwise. A quick "okay" or "no thanks" would be appreciated, but no response is needed if you are fine with this.

Thank you for your time.

Regards,`;
            }
            
            document.getElementById('emailOutDraft').value = draft;
            document.getElementById('emailOutSubject').value = subject;
            
            // Show message
            let detectedFlags = [];
            if (currentOrg.tou_flag) detectedFlags.push('TOU');
            if (hasTechBlock) detectedFlags.push('Tech Block');
            if (hasTechRendering) detectedFlags.push('JS Rendering');
            
            const recipientCount = toField ? toField.split(';').length : 0;
            const recipientText = recipientCount > 0 ? ` (${recipientCount} recipient${recipientCount > 1 ? 's' : ''})` : '';
            
            const draftType = hasAnyRestriction 
                ? `âš ï¸ Restriction-aware draft (${detectedFlags.join(', ')})${recipientText}` 
                : `ğŸ“ Standard notice draft${recipientText}`;
            showMessage('profileMessage', `${draftType} generated!`, 'success');
        }
        
        /**
         * Save correspondence entry based on type
         */
        async function saveCorrespondence(type) {
            let entry = {
                id: Date.now(),
                type: type,
                addedAt: new Date().toISOString()
            };
            
            // Gather data based on type
            if (type === 'phone') {
                const date = document.getElementById('phoneCallDate').value;
                const followup = document.getElementById('phoneFollowupDate').value;
                const contactSelect = document.getElementById('phoneContactSelect');
                const contactOther = document.getElementById('phoneContactOther').value;
                const draftNotes = document.getElementById('phoneCallNotesDraft').value;
                const callNotes = document.getElementById('phoneCallNotes').value;
                
                if (!date || !callNotes) {
                    showMessage('profileMessage', 'âš ï¸ Please enter the date and call notes.', 'warning');
                    return;
                }
                
                const selectedOption = contactSelect.options[contactSelect.selectedIndex];
                entry.date = date;
                entry.followupDate = followup || null;
                entry.contactId = contactSelect.value || null;
                entry.contactName = selectedOption?.dataset?.name || contactOther || 'Unknown';
                entry.contactEmail = selectedOption?.dataset?.email || '';
                entry.subject = 'Phone Call';
                entry.draftNotes = draftNotes;
                entry.text = callNotes;
                
            } else if (type === 'email-out') {
                const date = document.getElementById('emailOutDate').value;
                const followup = document.getElementById('emailOutFollowupDate').value;
                const toField = document.getElementById('emailOutToField').value;
                const subject = document.getElementById('emailOutSubject').value;
                const draft = document.getElementById('emailOutDraft').value;
                const finalText = document.getElementById('emailOutFinal').value;
                
                if (!date || !finalText) {
                    showMessage('profileMessage', 'âš ï¸ Please enter the date and final email text.', 'warning');
                    return;
                }
                
                // Get all selected recipients
                const recipients = getSelectedRecipients();
                const recipientEmails = recipients.map(r => r.email).filter(e => e);
                const recipientNames = recipients.map(r => r.name || r.email).filter(n => n);
                
                entry.date = date;
                entry.followupDate = followup || null;
                // Store all recipient info
                entry.recipients = recipients; // Full recipient objects array
                entry.recipientCount = recipients.length;
                entry.contactId = recipients.length === 1 ? recipients[0].id : null; // Legacy support
                entry.contactName = recipientNames.join('; ') || 'Unknown';
                entry.contactEmail = recipientEmails.join('; ') || toField || '';
                entry.subject = subject || 'Email Outreach';
                entry.draftText = draft;
                entry.text = finalText;
                
            } else if (type === 'email-in') {
                const date = document.getElementById('emailInDate').value;
                const followup = document.getElementById('emailInFollowupDate').value;
                const contactSelect = document.getElementById('emailInContactSelect');
                const contactOther = document.getElementById('emailInContactOther').value;
                const subject = document.getElementById('emailInSubject').value;
                const responseText = document.getElementById('emailInText').value;
                
                if (!date || !responseText) {
                    showMessage('profileMessage', 'âš ï¸ Please enter the date and response text.', 'warning');
                    return;
                }
                
                const selectedOption = contactSelect.options[contactSelect.selectedIndex];
                const isOther = contactSelect.value === '__other__';
                entry.date = date;
                entry.followupDate = followup || null;
                entry.contactId = isOther ? null : (contactSelect.value || null);
                entry.contactName = isOther ? contactOther : (selectedOption?.dataset?.name || contactOther || 'Unknown');
                entry.contactEmail = isOther ? '' : (selectedOption?.dataset?.email || '');
                entry.subject = subject || 'Email Response';
                entry.text = responseText;
            }
            
            // Load existing log
            let log = [];
            try {
                if (currentOrg.correspondence_log) {
                    log = JSON.parse(currentOrg.correspondence_log);
                }
            } catch (e) {
                log = [];
            }
            
            // Add new entry at beginning
            log.unshift(entry);
            
            // Save to PocketBase
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        },
                        body: JSON.stringify({ correspondence_log: JSON.stringify(log) })
                    }
                );
                
                if (response.ok) {
                    currentOrg.correspondence_log = JSON.stringify(log);
                    
                    // Clear form and hide accordion
                    cancelAddCorrespondence();
                    
                    // Reload timeline
                    loadCorrespondenceTimeline();
                    
                    const typeLabels = { 'phone': 'Phone Call', 'email-out': 'Email Outreach', 'email-in': 'Email Response' };
                    showMessage('profileMessage', `âœ… ${typeLabels[type]} logged successfully!`, 'success');
                } else {
                    const err = await response.json();
                    showMessage('profileMessage', `âŒ Error saving: ${JSON.stringify(err)}`, 'error');
                }
            } catch (error) {
                showMessage('profileMessage', `âŒ Error: ${error.message}`, 'error');
            }
        }

        /**
         * Load and display the correspondence timeline (v23 - updated for new entry types)
         */
        function loadCorrespondenceTimeline() {
            const container = document.getElementById('correspondenceTimeline');
            
            let log = [];
            try {
                if (currentOrg.correspondence_log) {
                    log = JSON.parse(currentOrg.correspondence_log);
                }
            } catch (e) {
                log = [];
            }
            
            if (log.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No correspondence logged yet.</p>';
                return;
            }
            
            // Sort by date (newest first)
            log.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Type configurations
            const typeConfig = {
                'phone': { icon: 'ğŸ“', label: 'Phone Call', class: 'type-phone' },
                'email-out': { icon: 'ğŸ“¤', label: 'Email Outreach', class: 'type-email-out' },
                'email-in': { icon: 'ğŸ“¥', label: 'Email Response', class: 'type-email-in' },
                // Legacy support
                'sent': { icon: 'ğŸ“¤', label: 'Email Sent', class: 'type-email-out' },
                'received': { icon: 'ğŸ“¥', label: 'Email Received', class: 'type-email-in' },
                'note': { icon: 'ğŸ“', label: 'Note', class: 'type-phone' }
            };
            
            container.innerHTML = log.map(entry => {
                const entryType = entry.type || entry.direction || 'note';
                const config = typeConfig[entryType] || typeConfig['note'];
                const dateStr = new Date(entry.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                
                // Check for follow-up date
                let followupBadge = '';
                if (entry.followupDate) {
                    const followupDate = new Date(entry.followupDate);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const isOverdue = followupDate < today;
                    followupBadge = `<span class="corr-followup-badge" style="${isOverdue ? 'background: #f8d7da; color: #721c24;' : ''}">
                        ${isOverdue ? 'âš ï¸ Overdue' : 'ğŸ”” Follow-up'}: ${followupDate.toLocaleDateString()}
                    </span>`;
                }
                
                // Show recipient count for multi-recipient emails
                let recipientDisplay = '';
                if (entry.contactName) {
                    const recipientCount = entry.recipientCount || 1;
                    const countBadge = recipientCount > 1 ? ` <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px;">${recipientCount} recipients</span>` : '';
                    recipientDisplay = `<p class="corr-entry-contact">ğŸ‘¤ ${escapeHtml(entry.contactName)}${countBadge}</p>`;
                }
                
                return `
                <div class="corr-entry ${config.class}">
                    <div class="corr-entry-header">
                        <div>
                            <span class="corr-entry-type">${config.icon} ${config.label}</span>
                            ${followupBadge}
                        </div>
                        <span class="corr-entry-date">${dateStr}</span>
                    </div>
                    <div class="corr-entry-actions">
                        <button class="btn btn-small btn-danger" onclick="deleteCorrespondenceEntry(${entry.id})" style="padding: 4px 8px; font-size: 11px;">ğŸ—‘ï¸</button>
                    </div>
                    ${recipientDisplay}
                    ${entry.subject ? `<p class="corr-entry-subject">${escapeHtml(entry.subject)}</p>` : ''}
                    <div class="corr-entry-text">${escapeHtml(entry.text)}</div>
                </div>`;
            }).join('');
        }

        /**
         * Delete a correspondence entry
         */
        async function deleteCorrespondenceEntry(entryId) {
            if (!confirm('Delete this correspondence entry?')) return;
            
            let log = [];
            try {
                if (currentOrg.correspondence_log) {
                    log = JSON.parse(currentOrg.correspondence_log);
                }
            } catch (e) {
                log = [];
            }
            
            // Remove entry
            log = log.filter(e => e.id !== entryId);
            
            // Save to PocketBase
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        },
                        body: JSON.stringify({ correspondence_log: JSON.stringify(log) })
                    }
                );
                
                if (response.ok) {
                    currentOrg.correspondence_log = JSON.stringify(log);
                    loadCorrespondenceTimeline();
                    showMessage('profileMessage', 'âœ… Entry deleted.', 'success');
                }
            } catch (error) {
                showMessage('profileMessage', `âŒ Error: ${error.message}`, 'error');
            }
        }

        /**
         * Fetch the name of the primary org for duplicate display
         */
        async function fetchDuplicateOfName(orgId) {
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    headers: { 'Authorization': authToken }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('duplicateOfName').textContent = data.name || 'Unknown';
                    document.getElementById('duplicateOfLink').onclick = function() {
                        openOrgProfile(orgId);
                        return false;
                    };
                } else {
                    document.getElementById('duplicateOfName').textContent = 'Unable to load';
                }
            } catch (error) {
                document.getElementById('duplicateOfName').textContent = 'Error loading';
            }
        }

        async function changeOrgStatus() {
            const newStatus = document.getElementById('statusDropdown').value;
            
            // Safety check: warn if trying to go Live with restriction flags
            if (newStatus === 'Live (Scraping Active)') {
                const hasRestrictions = currentOrg.tou_flag || currentOrg.tech_block_flag || currentOrg.tech_rendering_flag || currentOrg.permission_type === 'Denied';
                if (hasRestrictions) {
                    const flags = [];
                    if (currentOrg.tou_flag) flags.push('TOU Restriction');
                    if (currentOrg.tech_block_flag) flags.push('Tech Block');
                    if (currentOrg.tech_rendering_flag) flags.push('JS Rendering Required');
                    if (currentOrg.permission_type === 'Denied') flags.push('Permission Denied');
                    
                    const proceed = confirm(
                        `âš ï¸ WARNING: This organization has active restriction flags:\n\n` +
                        `â€¢ ${flags.join('\nâ€¢ ')}\n\n` +
                        `Setting to Live with these flags may cause issues.\n\n` +
                        `Do you want to proceed anyway?`
                    );
                    if (!proceed) return;
                }
            }
            
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ status: newStatus })
                });
                currentOrg.status = newStatus;
                const config = STATUS_CONFIG[newStatus] || { icon: 'â“' };
                document.getElementById('profileOrgStatus').innerHTML = `${config.icon} ${newStatus}`;
                document.getElementById('statusCurrentStatus').innerHTML = `<span class="badge ${config.badge}">${config.icon} ${newStatus}</span>`;
                showMessage('profileMessage', 'âœ… Status changed!', 'success');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function changeEventPolicy() {
            const policyEl = document.getElementById('statusEventPolicy');
            if (!policyEl) return; // Element may not exist in streamlined v25 layout
            const newPolicy = policyEl.value;
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ event_policy: newPolicy || null })
                });
                currentOrg.event_policy = newPolicy;
                // Also update the Overview tab dropdown
                document.getElementById('profileEventPolicy').value = newPolicy;
                showMessage('profileMessage', 'âœ… Event policy updated!', 'success');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // NOTE: Legacy touForm event listener removed - flags are now read-only (set by scanner)

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOU FLAG & TECHNICAL BLOCK AUTOMATION (LEGACY - kept for reference)
        // NOTE: These functions are no longer called from UI since flags are read-only
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Handle TOU Flag checkbox change
         * When checked: auto-set date, uncheck scraping, set status to Rejected
         */
        function handleTouFlagChange() {
            console.log('TOU Flag changed');
            const touFlag = document.getElementById('touFlag').checked;
            
            if (touFlag) {
                // Auto-set TOU Scanned Date to today if not already set
                const touDateField = document.getElementById('touScannedDate');
                if (!touDateField.value) {
                    const today = new Date().toISOString().split('T')[0];
                    touDateField.value = today;
                    console.log('Set TOU Scanned Date to:', today);
                }
                
                // Uncheck Scraping Enabled
                document.getElementById('scrapingEnabled').checked = false;
                console.log('Unchecked Scraping Enabled');
                
                // Change status to Rejected by Org
                document.getElementById('statusDropdown').value = 'Rejected by Org';
                console.log('Set status to Rejected by Org');
                
                // Auto-save changes
                saveTouBlockChanges('tou');
            }
        }
        
        /**
         * Handle Technical Block checkbox change
         * When checked: auto-set date, uncheck scraping, set status to Rejected, set TOU flag
         */
        function handleTechBlockChange() {
            console.log('Tech Block changed');
            const techBlockFlag = document.getElementById('techBlockFlag').checked;
            
            if (techBlockFlag) {
                // Auto-set TOU Scanned Date to today if not already set
                const touDateField = document.getElementById('touScannedDate');
                const today = new Date().toISOString().split('T')[0];
                if (!touDateField.value) {
                    touDateField.value = today;
                    console.log('Set TOU Scanned Date to:', today);
                }
                
                // Also check TOU Flag (technical block implies TOU issue)
                document.getElementById('touFlag').checked = true;
                console.log('Checked TOU Flag');
                
                // Uncheck Scraping Enabled
                document.getElementById('scrapingEnabled').checked = false;
                console.log('Unchecked Scraping Enabled');
                
                // Change status to Rejected by Org
                document.getElementById('statusDropdown').value = 'Rejected by Org';
                console.log('Set status to Rejected by Org');
                
                // Auto-populate TOU Notes if empty
                const touNotes = document.getElementById('touNotes');
                if (!touNotes.value && currentOrg) {
                    touNotes.value = `âŒ ${currentOrg.name} is actively blocking automated requests (403 Forbidden).`;
                    console.log('Set TOU Notes');
                }
                
                // Auto-save changes
                saveTouBlockChanges('tech');
            }
        }
        
        /**
         * Handle Permission Denied checkbox change
         * When checked: auto-set date, uncheck scraping, set status to Rejected
         */
        // NOTE: Permission Denied is now handled via permission_type field in Edit Org tab
        // The handlePermissionDeniedChange and savePermissionDeniedChanges functions have been removed
        
        /**
         * Handle Tech Rendering Flag checkbox change
         * When checked: uncheck scraping, set status to Rejected
         */
        function handleTechRenderingChange() {
            console.log('Tech Rendering Flag changed');
            const techRenderingFlag = document.getElementById('techRenderingFlag').checked;
            
            if (techRenderingFlag) {
                // Uncheck Scraping Enabled
                document.getElementById('scrapingEnabled').checked = false;
                console.log('Unchecked Scraping Enabled');
                
                // Change status to Rejected by Org
                document.getElementById('statusDropdown').value = 'Rejected by Org';
                console.log('Set status to Rejected by Org');
                
                // Auto-save changes
                saveAllFlags();
            }
        }
        
        /**
         * Save all rejection flags to PocketBase
         */
        async function saveAllFlags() {
            if (!currentOrg || !currentOrg.id) {
                alert('Error: No organization selected');
                return;
            }
            
            const touFlag = document.getElementById('touFlag').checked;
            const techBlockFlag = document.getElementById('techBlockFlag').checked;
            const techRenderingFlag = document.getElementById('techRenderingFlag').checked;
            
            // Note: Flags no longer auto-change status (v24 workflow)
            // Status changes are manual PES decisions
            
            const updates = {
                tou_flag: touFlag,
                tech_block_flag: techBlockFlag,
                tech_rendering_flag: techRenderingFlag,
                scraping_enabled: document.getElementById('scrapingEnabled').checked
            };
            
            // Set TOU scanned date if TOU or tech block flag is checked
            if (touFlag || techBlockFlag) {
                const today = new Date().toISOString().split('T')[0];
                const touDateField = document.getElementById('touScannedDate');
                if (!touDateField.value) {
                    touDateField.value = today;
                }
                updates.tou_scanned_date = touDateField.value;
            }
            
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${currentOrg.id}`,
                    {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                        body: JSON.stringify(updates)
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    currentOrg.tou_flag = data.tou_flag;
                    currentOrg.tech_block_flag = data.tech_block_flag;
                    currentOrg.tech_rendering_flag = data.tech_rendering_flag;
                    currentOrg.scraping_enabled = data.scraping_enabled;
                    console.log('âœ… All flags saved');
                    loadStatusHistory(); // Refresh alerts
                    alert('âœ… Flags saved successfully');
                } else {
                    alert('âŒ Error saving flags');
                }
            } catch (error) {
                console.error('Error saving flags:', error);
                alert('âŒ Error saving flags: ' + error.message);
            }
        }
        
        /**
         * Save TOU/Tech Block changes to PocketBase
         */
        function saveTouBlockChanges(blockType) {
            if (!currentOrgId) {
                console.error('No currentOrgId - cannot save');
                alert('Error: No organization selected');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const touScannedDate = document.getElementById('touScannedDate').value || today;
            
            const data = {
                tou_flag: document.getElementById('touFlag').checked,
                tech_block_flag: document.getElementById('techBlockFlag').checked,
                tou_notes: document.getElementById('touNotes').value,
                tou_scanned_date: touScannedDate,
                status: 'Rejected by Org',
                scraping_enabled: false,
                permission_response_date: today
            };
            
            // If tech block, also update permission correspondence
            if (blockType === 'tech') {
                data.permission_correspondence = document.getElementById('touNotes').value;
            }
            
            console.log('Saving data:', data);
            
            fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Save failed: ' + response.status);
                }
                return response.json();
            })
            .then(result => {
                console.log('Save successful:', result);
                
                // Update local state
                if (currentOrg) {
                    Object.assign(currentOrg, data);
                }
                
                // Update UI
                const config = STATUS_CONFIG['Rejected by Org'];
                document.getElementById('profileOrgStatus').innerHTML = `${config.icon} Rejected by Org`;
                document.getElementById('statusCurrentStatus').innerHTML = `<span class="badge ${config.badge}">${config.icon} Rejected by Org</span>`;
                document.getElementById('permissionResponseDate').value = today;
                
                // Update alerts
                const alertsDiv = document.getElementById('statusAlerts');
                if (document.getElementById('techBlockFlag').checked) {
                    alertsDiv.innerHTML = `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests (403 Forbidden).</p></div>`;
                } else {
                    alertsDiv.innerHTML = `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(data.tou_notes) || 'May prohibit scraping'}</p></div>`;
                }
                
                const blockTypeLabel = blockType === 'tech' ? 'Technical Block' : 'TOU Flag';
                showMessage('profileMessage', `âš ï¸ ${blockTypeLabel} set - Status changed to Rejected by Org, Scraping disabled`, 'warning');
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('Error saving changes: ' + error.message);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MARK AS TECHNICALLY BLOCKED
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function markAsTechBlocked() {
            if (!currentOrg || !currentOrgId) {
                alert('No organization selected');
                return;
            }

            const orgName = currentOrg.name;
            const blockMessage = `âŒ ${orgName} is actively blocking automated requests (403 Forbidden).`;
            const today = new Date().toISOString().split('T')[0];

            if (!confirm(`Mark "${orgName}" as technically blocked?\n\nThis will:\nâ€¢ Set status to "Rejected by Org"\nâ€¢ Set Technical Block flag to true\nâ€¢ Set TOU flag to true\nâ€¢ Update TOU Notes and Permission Response\nâ€¢ Set Permission Response Date to today`)) {
                return;
            }

            const data = {
                status: 'Rejected by Org',
                tech_block_flag: true,
                tou_flag: true,
                tou_notes: blockMessage,
                permission_correspondence: blockMessage,
                permission_response_date: today,
                scraping_enabled: false
            };

            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(data)
                });

                // Update local state
                Object.assign(currentOrg, data);

                // Update UI
                document.getElementById('touFlag').checked = true;
                document.getElementById('techBlockFlag').checked = true;
                document.getElementById('touNotes').value = blockMessage;
                document.getElementById('permissionCorrespondence').value = blockMessage;
                document.getElementById('permissionResponseDate').value = today;
                document.getElementById('scrapingEnabled').checked = false;
                document.getElementById('statusDropdown').value = 'Rejected by Org';

                const config = STATUS_CONFIG['Rejected by Org'];
                document.getElementById('profileOrgStatus').innerHTML = `${config.icon} Rejected by Org`;
                document.getElementById('statusCurrentStatus').innerHTML = `<span class="badge ${config.badge}">${config.icon} Rejected by Org</span>`;

                // Update alerts
                const alertsDiv = document.getElementById('statusAlerts');
                alertsDiv.innerHTML = `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests (403 Forbidden).</p></div>`;

                showMessage('profileMessage', 'â›” Organization marked as technically blocked!', 'warning');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Legacy permission form handler (only attach if element exists)
        const permissionForm = document.getElementById('permissionForm');
        if (permissionForm) {
            permissionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    permission_requested_date: document.getElementById('permissionRequestedDate').value || null,
                    permission_response_date: document.getElementById('permissionResponseDate').value || null,
                    permission_request_draft: document.getElementById('permissionDraft').value,
                    permission_request_final: document.getElementById('permissionFinal').value,
                    permission_correspondence: document.getElementById('permissionCorrespondence').value
                };
                try {
                    await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify(data)
                    });
                    Object.assign(currentOrg, data);
                    showMessage('profileMessage', 'âœ… Permission info saved!', 'success');
                } catch (error) { alert('Error: ' + error.message); }
            });
        }

        // Legacy notes form handler (only attach if element exists)
        const notesForm = document.getElementById('notesForm');
        if (notesForm) {
            notesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = { 
                    notes: document.getElementById('orgNotes').value 
                };
                try {
                    await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${currentOrgId}`, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': authToken }, body: JSON.stringify(data)
                    });
                    Object.assign(currentOrg, data);
                    showMessage('profileMessage', 'âœ… Notes saved!', 'success');
                } catch (error) { alert('Error: ' + error.message); }
            });
        }

        function copyDraft(fieldId) {
            const text = document.getElementById(fieldId).value;
            if (!text) {
                showMessage('profileMessage', 'âš ï¸ Nothing to copy - field is empty.', 'warning');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const label = fieldId === 'permissionDraft' ? 'Draft' : 'Final text';
                showMessage('profileMessage', `ğŸ“‹ ${label} copied to clipboard!`, 'success');
            }).catch(() => alert('Failed to copy.'));
        }

        function previewDraft(fieldId) {
            const text = document.getElementById(fieldId).value;
            const label = fieldId === 'permissionDraft' ? 'Draft' : 'Final Text';
            document.getElementById('previewContent').textContent = text || `No ${label.toLowerCase()} to preview.`;
            openModal('previewModal');
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROFILE - EVENTS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadProfileEvents() {
            const container = document.getElementById('profileEventsList');
            const orgInfoDiv = document.getElementById('profileEventsOrgInfo');
            container.innerHTML = '<div class="loading">Loading events...</div>';

            const config = STATUS_CONFIG[currentOrg.status] || { icon: 'â“', badge: '' };
            let alertsHtml = '';
            if (currentOrg.tech_block_flag) {
                alertsHtml = `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests.</p></div>`;
            } else if (currentOrg.tou_flag) {
                alertsHtml = `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(currentOrg.tou_notes) || 'May prohibit scraping'}</p></div>`;
            }
            orgInfoDiv.innerHTML = `
                ${alertsHtml}
                <p><strong>Organization:</strong> ${escapeHtml(currentOrg.name)}</p>
                <p><strong>Status:</strong> <span class="badge ${config.badge}">${config.icon} ${currentOrg.status}</span></p>
                <p><strong>Website:</strong> <a href="${escapeHtml(currentOrg.website)}" target="_blank">${escapeHtml(currentOrg.website) || 'N/A'}</a></p>
                ${currentOrg.ai_reasoning ? `<p><strong>AI Reasoning:</strong> ${escapeHtml(currentOrg.ai_reasoning)}</p>` : ''}
            `;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/events/records?filter=(organization='${currentOrgId}')&sort=-start_date&perPage=100`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                const events = data.items || [];

                // Count by status
                const nominatedCount = events.filter(e => e.event_status === 'nominated' || !e.event_status).length;
                const approvedCount = events.filter(e => e.event_status === 'approved').length;
                const rejectedCount = events.filter(e => e.event_status === 'rejected').length;

                document.getElementById('profileEventCount').textContent = `${events.length} events`;

                if (events.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“…</div><h3>No Events Yet</h3></div>`;
                    return;
                }

                // Add status summary
                let summaryHtml = `<div class="event-status-summary" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <strong>Event Status:</strong> 
                    <span style="margin-left: 10px;">ğŸ“‹ Nominated: ${nominatedCount}</span>
                    <span style="margin-left: 10px;">âœ… Approved: ${approvedCount}</span>
                    <span style="margin-left: 10px;">âŒ Rejected: ${rejectedCount}</span>
                </div>`;

                container.innerHTML = summaryHtml + events.map(e => {
                    const startDate = e.start_date ? new Date(e.start_date).toLocaleDateString() : 'TBD';
                    
                    // Event status badge
                    const eventStatus = e.event_status || 'nominated';
                    const statusBadge = eventStatus === 'approved' 
                        ? '<span class="badge badge-live">âœ… Approved</span>'
                        : eventStatus === 'rejected'
                        ? '<span class="badge badge-danger">âŒ Rejected</span>'
                        : '<span class="badge badge-warning">ğŸ“‹ Nominated</span>';
                    
                    // Action buttons
                    const actionButtons = eventStatus === 'nominated' || !eventStatus
                        ? `<div class="event-actions">
                               <button class="btn btn-small btn-success" onclick="updateEventStatusFromProfile('${e.id}', 'approved')">âœ… Accept</button>
                               <button class="btn btn-small btn-danger" onclick="updateEventStatusFromProfile('${e.id}', 'rejected')">âŒ Reject</button>
                           </div>`
                        : eventStatus === 'approved'
                        ? `<div class="event-actions">
                               <button class="btn btn-small btn-danger" onclick="updateEventStatusFromProfile('${e.id}', 'rejected')">âŒ Reject</button>
                               <button class="btn btn-small btn-secondary" onclick="updateEventStatusFromProfile('${e.id}', 'nominated')">â†©ï¸ Back to Review</button>
                           </div>`
                        : `<div class="event-actions">
                               <button class="btn btn-small btn-success" onclick="updateEventStatusFromProfile('${e.id}', 'approved')">âœ… Accept</button>
                               <button class="btn btn-small btn-secondary" onclick="updateEventStatusFromProfile('${e.id}', 'nominated')">â†©ï¸ Back to Review</button>
                           </div>`;
                    
                    return `
                        <div class="event-card" id="profile-event-${e.id}">
                            <h5>${escapeHtml(e.title)} ${statusBadge}</h5>
                            <p><strong>Date:</strong> ${startDate}</p>
                            ${e.location ? `<p><strong>Location:</strong> ${escapeHtml(e.location)}</p>` : ''}
                            ${e.event_type ? `<p><strong>Type:</strong> ${escapeHtml(e.event_type)}</p>` : ''}
                            ${e.url ? `<p><a href="${escapeHtml(e.url)}" target="_blank">View Event â†’</a></p>` : ''}
                            ${actionButtons}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }
        
        /**
         * Update event status from org profile page
         */
        async function updateEventStatusFromProfile(eventId, newStatus) {
            // Safety gate: If approving, verify org status first
            // Since we're in the org profile, we can use currentOrg
            if (newStatus === 'approved') {
                const allowedStatuses = ['Permission Granted (Not Live)', 'Live (Scraping Active)'];
                
                if (!allowedStatuses.includes(currentOrg.status)) {
                    alert(
                        `â›” Cannot approve this event!\n\n` +
                        `Organization: ${currentOrg.name}\n` +
                        `Current Org Status: ${currentOrg.status || 'Unknown'}\n\n` +
                        `Events can only be approved when the organization status is:\n` +
                        `â€¢ Permission Granted (Not Live)\n` +
                        `â€¢ Live (Scraping Active)\n\n` +
                        `Please update the organization status first.`
                    );
                    return;
                }
            }
            
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records/${eventId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        },
                        body: JSON.stringify({ event_status: newStatus })
                    }
                );
                
                if (response.ok) {
                    console.log(`âœ… Event ${eventId} updated to ${newStatus}`);
                    // Reload profile events to reflect change
                    loadProfileEvents();
                } else {
                    const err = await response.json();
                    alert(`âŒ Error updating event: ${JSON.stringify(err)}`);
                }
            } catch (error) {
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DASHBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadDashboard() {
            try {
                const [orgsRes, eventsRes] = await Promise.all([
                    fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/events/records?perPage=1`, { headers: { 'Authorization': authToken } })
                ]);
                const orgsData = await orgsRes.json();
                const eventsData = await eventsRes.json();
                const orgs = orgsData.items || [];

                // Calculate contact stats
                const orgsWithContacts = new Set(allContacts.map(c => c.organization));
                const orgsNoContacts = orgs.filter(o => !orgsWithContacts.has(o.id)).length;

                document.getElementById('statOrgs').textContent = orgsData.totalItems || 0;
                document.getElementById('statEvents').textContent = eventsData.totalItems || 0;
                document.getElementById('statContacts').textContent = allContacts.length || 0;
                document.getElementById('statNoContacts').textContent = orgsNoContacts;
                document.getElementById('statPending').textContent = orgs.filter(o => o.status === 'Nominated (Pending Mission Review)').length;
                document.getElementById('statRestrictions').textContent = orgs.filter(o => o.tou_flag === true || o.tech_block_flag === true).length;
                document.getElementById('statLive').textContent = orgs.filter(o => o.status === 'Live (Scraping Active)').length;
                document.getElementById('statTechBlocked').textContent = orgs.filter(o => o.tech_block_flag === true).length;
                document.getElementById('statPermissionDenied').textContent = orgs.filter(o => o.permission_type === 'Denied').length;
                document.getElementById('statDuplicates').textContent = orgs.filter(o => o.duplicate_flag === true).length;

                const statusCounts = {};
                orgs.forEach(org => { statusCounts[org.status] = (statusCounts[org.status] || 0) + 1; });

                let summaryHtml = '<h3 style="margin-bottom: 15px;">ğŸ“Š Status Overview</h3>';
                for (const [status, count] of Object.entries(statusCounts)) {
                    const config = STATUS_CONFIG[status] || { icon: 'â“' };
                    summaryHtml += `<p>${config.icon} <strong>${status}:</strong> ${count}</p>`;
                }
                
                // Add tech blocked count
                const techBlockedCount = orgs.filter(o => o.tech_block_flag === true).length;
                if (techBlockedCount > 0) {
                    summaryHtml += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #dee2e6;">`;
                    summaryHtml += `<p>â›” <strong>Technically Blocked:</strong> ${techBlockedCount}</p>`;
                }
                
                // Add permission denied count
                const permissionDeniedCount = orgs.filter(o => o.permission_type === 'Denied').length;
                if (permissionDeniedCount > 0) {
                    if (techBlockedCount === 0) {
                        summaryHtml += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #dee2e6;">`;
                    }
                    summaryHtml += `<p>ğŸš« <strong>Permission Denied:</strong> ${permissionDeniedCount}</p>`;
                }
                
                // Add JS rendered count
                const techRenderingCount = orgs.filter(o => o.tech_rendering_flag === true).length;
                if (techRenderingCount > 0) {
                    if (techBlockedCount === 0 && permissionDeniedCount === 0) {
                        summaryHtml += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #dee2e6;">`;
                    }
                    summaryHtml += `<p>âš™ï¸ <strong>Tech-Rendered Sites:</strong> ${techRenderingCount}</p>`;
                }
                
                // Add duplicates count
                const duplicateCount = orgs.filter(o => o.duplicate_flag === true).length;
                if (duplicateCount > 0) {
                    if (techBlockedCount === 0 && permissionDeniedCount === 0 && techRenderingCount === 0) {
                        summaryHtml += `<hr style="margin: 10px 0; border: none; border-top: 1px solid #dee2e6;">`;
                    }
                    summaryHtml += `<p>ğŸ” <strong>Duplicates:</strong> ${duplicateCount}</p>`;
                }
                
                document.getElementById('dashboardContent').innerHTML = `<div class="card">${summaryHtml}</div>`;
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ORGANIZATION BY STATUS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadByStatus() {
            const container = document.getElementById('byStatusList');
            const statusDropdown = document.getElementById('filterByStatus');
            const restrictionsDropdown = document.getElementById('filterByRestrictions');
            const statusFilter = statusDropdown.value;
            
            // Reset the other dropdown
            restrictionsDropdown.value = '';
            
            // No filter selected - show prompt
            if (!statusFilter) {
                container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ‘†</div><h3>Select a Filter</h3><p>Use <strong>Workflow Status</strong> to filter by status, or <strong>Orgs with Restrictions</strong> to see flagged organizations.</p></div>`;
                return;
            }

            try {
                container.innerHTML = '<div class="loading">Loading organizations...</div>';

                let filterValue = '';
                if (statusFilter === 'duplicates') {
                    filterValue = `duplicate_flag=true`;
                } else {
                    filterValue = `status='${statusFilter}'`;
                }
                const filterParam = `&filter=${encodeURIComponent(filterValue)}`;
                
                console.log('Status filter:', filterValue);

                const [orgsRes, contactsRes, eventsRes] = await Promise.all([
                    fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500${filterParam}`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/contacts/records?perPage=500`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/events/records?perPage=500`, { headers: { 'Authorization': authToken } })
                ]);

                const orgsData = await orgsRes.json();
                console.log('Orgs response:', orgsData);
                const contactsData = await contactsRes.json();
                const eventsData = await eventsRes.json();

                const orgs = orgsData.items || [];
                const contacts = contactsData.items || [];
                const events = eventsData.items || [];

                // Build lookups
                const contactsByOrg = {};
                contacts.forEach(c => {
                    if (!contactsByOrg[c.organization]) contactsByOrg[c.organization] = [];
                    contactsByOrg[c.organization].push(c);
                });

                const eventCountByOrg = {};
                events.forEach(e => { eventCountByOrg[e.organization] = (eventCountByOrg[e.organization] || 0) + 1; });

                if (orgs.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‹</div><h3>No Organizations Found</h3><p>No organizations match "${statusFilter}".</p></div>`;
                    return;
                }

                orgs.sort((a, b) => {
                    const nameA = a.name.replace(/^The\s+/i, '').toLowerCase();
                    const nameB = b.name.replace(/^The\s+/i, '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                container.innerHTML = orgs.map(org => renderByStatusCard(org, contactsByOrg[org.id] || [], eventCountByOrg[org.id] || 0, statusFilter)).join('');

            } catch (error) {
                console.error('loadByStatus error:', error);
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }
        
        async function loadByRestrictions() {
            const container = document.getElementById('byStatusList');
            const statusDropdown = document.getElementById('filterByStatus');
            const restrictionsDropdown = document.getElementById('filterByRestrictions');
            const restrictionFilter = restrictionsDropdown.value;
            
            // Reset the other dropdown
            statusDropdown.value = '';
            
            // No filter selected - show prompt
            if (!restrictionFilter) {
                container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ‘†</div><h3>Select a Filter</h3><p>Use <strong>Workflow Status</strong> to filter by status, or <strong>Orgs with Restrictions</strong> to see flagged organizations.</p></div>`;
                return;
            }

            try {
                container.innerHTML = '<div class="loading">Loading organizations...</div>';

                const statusMap = {
                    'restricted-nominated': 'Nominated (Pending Mission Review)',
                    'restricted-approved': 'Mission Approved (Request Not Sent)',
                    'restricted-requested': 'Permission Requested (Pending Org Response)',
                    'restricted-granted': 'Permission Granted (Not Live)',
                    'restricted-rejected-mission': 'Rejected by Mission',
                    'restricted-rejected-org': 'Rejected by Org'
                };
                const mappedStatus = statusMap[restrictionFilter];
                
                // Build filter with proper encoding
                const filterValue = `(status='${mappedStatus}' && (tou_flag=true || tech_block_flag=true))`;
                const filterParam = `&filter=${encodeURIComponent(filterValue)}`;
                
                console.log('Restrictions filter:', filterValue);
                console.log('Encoded URL:', `${POCKETBASE_URL}/api/collections/organizations/records?perPage=500${filterParam}`);

                const [orgsRes, contactsRes, eventsRes] = await Promise.all([
                    fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500${filterParam}`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/contacts/records?perPage=500`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/events/records?perPage=500`, { headers: { 'Authorization': authToken } })
                ]);

                const orgsData = await orgsRes.json();
                console.log('Restrictions orgs response:', orgsData);
                const contactsData = await contactsRes.json();
                const eventsData = await eventsRes.json();

                const orgs = orgsData.items || [];
                const contacts = contactsData.items || [];
                const events = eventsData.items || [];

                // Build lookups
                const contactsByOrg = {};
                contacts.forEach(c => {
                    if (!contactsByOrg[c.organization]) contactsByOrg[c.organization] = [];
                    contactsByOrg[c.organization].push(c);
                });

                const eventCountByOrg = {};
                events.forEach(e => { eventCountByOrg[e.organization] = (eventCountByOrg[e.organization] || 0) + 1; });

                if (orgs.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‹</div><h3>No Organizations Found</h3><p>No restricted organizations in "${mappedStatus}".</p></div>`;
                    return;
                }

                orgs.sort((a, b) => {
                    const nameA = a.name.replace(/^The\s+/i, '').toLowerCase();
                    const nameB = b.name.replace(/^The\s+/i, '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                container.innerHTML = orgs.map(org => renderByStatusCard(org, contactsByOrg[org.id] || [], eventCountByOrg[org.id] || 0, restrictionFilter)).join('');

            } catch (error) {
                console.error('loadByRestrictions error:', error);
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        function renderByStatusCard(org, contacts, eventCount, filterType) {
            const config = STATUS_CONFIG[org.status] || { icon: 'â“', badge: '', cardClass: '' };
            const touBadge = org.tou_flag && !org.tech_block_flag ? '<span class="badge badge-tou-flag">âš ï¸ TOU</span>' : '';
            const techBlockBadge = org.tech_block_flag ? '<span class="badge badge-tech-block">â›” BLOCKED</span>' : '';
            const techRenderingBadge = org.tech_rendering_flag ? '<span class="badge badge-js-render">âš™ï¸ JS-RENDER</span>' : '';
            const permissionDeniedBadge = org.permission_type === 'Denied' ? '<span class="badge badge-permission-denied">ğŸš« DECLINED</span>' : '';
            const duplicateBadge = org.duplicate_flag ? '<span class="badge badge-duplicate">ğŸ” DUPLICATE</span>' : '';
            
            // Status helper variables
            const isNominated = org.status === 'Nominated (Pending Mission Review)';
            const isMissionApproved = org.status === 'Mission Approved (Request Not Sent)';
            const isRequested = org.status === 'Permission Requested (Pending Org Response)';
            const hasRestrictions = org.tou_flag || org.tech_block_flag || org.tech_rendering_flag;
            
            // Add tech-blocked card class if applicable
            const cardClass = org.tech_block_flag ? 'status-tech-blocked' : config.cardClass;
            
            let html = `<div class="card ${cardClass}">`;
            
            // Show tech block alert first (takes precedence)
            if (org.tech_block_flag) {
                html += `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests (403 Forbidden).</p></div>`;
            } else if (org.tou_flag) {
                html += `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(org.tou_notes) || 'May prohibit scraping'}</p></div>`;
            }
            
            // Permission denied alert
            if (org.permission_type === 'Denied') {
                html += `<div class="info-box danger"><p>ğŸš« <strong>Permission Denied:</strong> Organization explicitly declined permission to scrape.</p></div>`;
            }
            
            // Tech rendering alert (can appear alongside other warnings)
            if (org.tech_rendering_flag) {
                html += `<div class="info-box" style="background: #e9ecef; border-color: #6c757d;"><p>âš™ï¸ <strong>Tech-Rendered Site:</strong> Requires headless browser (Puppeteer) for scraping.</p></div>`;
            }
            
            // Duplicate alert
            if (org.duplicate_flag) {
                html += `<div class="info-box" style="background: #f3e8ff; border-color: #6f42c1;"><p>ğŸ” <strong>Duplicate:</strong> This org is flagged as a duplicate. Check duplicate_of field for the primary org.</p></div>`;
            }

            html += `<h3><a href="#" onclick="openOrgProfile('${org.id}'); return false;">${escapeHtml(org.name)}</a> ${techBlockBadge} ${touBadge} ${permissionDeniedBadge} ${techRenderingBadge} ${duplicateBadge}</h3>`;
            html += `<p><strong>Status:</strong> <span class="badge ${config.badge}">${config.icon} ${org.status}</span></p>`;
            
            if (org.description) {
                html += `<p><strong>Description:</strong> ${escapeHtml(org.description).substring(0, 150)}${org.description.length > 150 ? '...' : ''}</p>`;
            }
            
            if (org.website) {
                html += `<p><strong>Website:</strong> <a href="${escapeHtml(org.website)}" target="_blank">${escapeHtml(org.website)}</a></p>`;
            }

            // Status-specific content
            if (isNominated && org.ai_reasoning) {
                html += `<div class="info-box"><p>ğŸ¤– <strong>AI Reasoning:</strong> ${escapeHtml(org.ai_reasoning).substring(0, 200)}${org.ai_reasoning.length > 200 ? '...' : ''}</p></div>`;
            }

            if ((isMissionApproved || isRequested) && org.permission_requested_date) {
                const sentDate = new Date(org.permission_requested_date);
                html += `<p><strong>Request Sent:</strong> ${sentDate.toLocaleDateString()}</p>`;
            }

            // Go-Live Date display - only for orgs WITHOUT restrictions
            if (isRequested && org.permission_requested_date) {
                if (hasRestrictions) {
                    // Has restrictions - no auto go-live
                    let restrictionTypes = [];
                    if (org.tou_flag) restrictionTypes.push('TOU');
                    if (org.tech_block_flag) restrictionTypes.push('Tech Block');
                    if (org.tech_rendering_flag) restrictionTypes.push('JS Rendering');
                    html += `<div class="info-box warning"><p>âš ï¸ <strong>Explicit Permission Required</strong> - No auto go-live date (${restrictionTypes.join(', ')})</p></div>`;
                } else {
                    // No restrictions - show calculated go-live date
                    const sentDate = new Date(org.permission_requested_date);
                    const goLiveDate = new Date(sentDate);
                    goLiveDate.setDate(goLiveDate.getDate() + 7);
                    html += `<div class="info-box"><p>ğŸ“… <strong>Go Live Date:</strong> ${goLiveDate.toLocaleDateString()} (implied permission if no response)</p></div>`;
                }
            }

            if (filterType === 'Permission Granted (Not Live)') {
                const permBadge = org.permission_type === 'Explicit' ? '<span class="badge badge-explicit">âœ… Explicit</span>' : '<span class="badge badge-implied">â±ï¸ Implied</span>';
                html += `<p><strong>Permission Type:</strong> ${permBadge}</p>`;
            }

            if (filterType === 'Rejected by Mission' || filterType === 'Rejected by Org') {
                if (contacts.length > 0) {
                    html += '<p><strong>POCs:</strong></p><ul style="margin-left: 20px; font-size: 13px;">';
                    contacts.forEach(c => {
                        html += `<li>${escapeHtml(c.name)}${c.title ? ` (${escapeHtml(c.title)})` : ''}: ${c.email || 'No email'}${c.phone ? `, ${escapeHtml(c.phone)}` : ''}</li>`;
                    });
                    html += '</ul>';
                }
            }

            if (filterType === 'Live (Scraping Active)') {
                html += `<div class="info-box success"><p>ğŸ“Š <strong>Events:</strong> ${eventCount} | ğŸ• <strong>Last:</strong> ${org.last_scraped ? new Date(org.last_scraped).toLocaleString() : 'Never'}</p></div>`;
            }

            // Status dropdown
            html += `<div style="margin: 15px 0; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                <div><label style="font-weight: 500; margin-right: 10px;">Change Status:</label>
                <select class="inline-status-select" onchange="quickStatusChange('${org.id}', this.value)">
                    ${Object.keys(STATUS_CONFIG).map(s => `<option value="${s}" ${org.status === s ? 'selected' : ''}>${STATUS_CONFIG[s].icon} ${s}</option>`).join('')}
                </select></div>
                <div><label style="font-weight: 500; margin-right: 10px;">Event Policy:</label>
                <select class="inline-status-select" onchange="quickEventPolicyChange('${org.id}', this.value)">
                    <option value="" ${!org.event_policy ? 'selected' : ''}>-- Not Set --</option>
                    <option value="accept_all" ${org.event_policy === 'accept_all' ? 'selected' : ''}>ğŸ”“ Accept All</option>
                    <option value="propose_events" ${org.event_policy === 'propose_events' ? 'selected' : ''}>ğŸ“‹ Propose Events</option>
                </select></div>
            </div>`;

            // Action buttons
            html += `<div class="card-actions">
                <button class="btn btn-small" onclick="openOrgProfile('${org.id}', 'overview')">âœï¸ Edit Org</button>
                <button class="btn btn-small btn-secondary" onclick="openOrgProfile('${org.id}', 'profileContacts')">ğŸ‘¤ Edit Contacts</button>
                <button class="btn btn-small btn-info" onclick="openOrgProfile('${org.id}', 'statusHistory')">ğŸ“œ Edit Status</button>
                <button class="btn btn-small" onclick="openOrgProfile('${org.id}', 'profileEvents')">ğŸ“… Events (${eventCount})</button>
                <button class="btn btn-small btn-warning" onclick="openScanModalForOrg('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">ğŸ” Scan</button>`;

            // Show Approve Mission button for nominated orgs
            if (isNominated) {
                html += `<button class="btn btn-small btn-success" onclick="quickApprove('${org.id}')">âœ… Approve Mission</button>`;
            }
            // Show Generate Request button for mission approved orgs
            if (isMissionApproved) {
                html += `<button class="btn btn-small btn-action" onclick="openOrgProfile('${org.id}', 'statusHistory')">ğŸ“§ Generate Request</button>`;
            }

            // Delete button always last (far right)
            html += `<button class="btn btn-small btn-danger" onclick="deleteOrgFromByStatus('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">ğŸ—‘ï¸ Delete</button>`;

            html += '</div></div>';
            return html;
        }

        async function quickStatusChange(orgId, newStatus) {
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ status: newStatus })
                });
                showMessage('byStatusMessage', `âœ… Status changed to "${newStatus}"`, 'success');
                loadByStatus();
            } catch (error) { alert('Error: ' + error.message); }
        }

        async function quickEventPolicyChange(orgId, newPolicy) {
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ event_policy: newPolicy || null })
                });
                const policyLabel = newPolicy === 'accept_all' ? 'ğŸ”“ Accept All' : newPolicy === 'propose_events' ? 'ğŸ“‹ Propose Events' : 'Not Set';
                showMessage('byStatusMessage', `âœ… Event policy set to "${policyLabel}"`, 'success');
            } catch (error) { alert('Error: ' + error.message); }
        }

        async function quickApprove(orgId) {
            if (!confirm('Approve this organization for mission?')) return;
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ status: 'Mission Approved (Request Not Sent)' })
                });
                showMessage('byStatusMessage', 'âœ… Mission approved!', 'success');
                loadByStatus();
            } catch (error) { alert('Error: ' + error.message); }
        }

        /**
         * Delete organization from the byStatus view
         */
        async function deleteOrgFromByStatus(orgId, orgName) {
            // Check for associated events and contacts
            let eventCount = 0;
            let contactCount = 0;

            try {
                const eventsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records?filter=(organization='${orgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (eventsRes.ok) {
                    const eventsData = await eventsRes.json();
                    eventCount = eventsData.totalItems || 0;
                }

                const contactsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${orgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (contactsRes.ok) {
                    const contactsData = await contactsRes.json();
                    contactCount = contactsData.totalItems || 0;
                }
            } catch (error) {
                console.error('Error checking related records:', error);
            }

            // Build confirmation message
            let confirmMsg = `ğŸ—‘ï¸ DELETE ORGANIZATION\n\n`;
            confirmMsg += `Are you sure you want to delete "${orgName}"?\n\n`;

            if (eventCount > 0 || contactCount > 0) {
                confirmMsg += `âš ï¸ WARNING: This org has associated records:\n`;
                if (eventCount > 0) confirmMsg += `   â€¢ ${eventCount} event(s)\n`;
                if (contactCount > 0) confirmMsg += `   â€¢ ${contactCount} contact(s)\n`;
                confirmMsg += `\nThese will become orphaned (not deleted).\n`;
            }

            confirmMsg += `\nThis action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Second confirmation
            const typeToConfirm = prompt(`Type the organization name to confirm deletion:\n\n"${orgName}"`);
            if (typeToConfirm !== orgName) {
                alert('âŒ Deletion cancelled - name did not match');
                return;
            }

            // Perform deletion
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': authToken }
                    }
                );

                if (response.ok) {
                    showMessage('byStatusMessage', `âœ… Organization "${orgName}" deleted successfully`, 'success');
                    loadByStatus(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert(`âŒ Delete failed: ${JSON.stringify(error)}`);
                }
            } catch (error) {
                alert(`âŒ Error deleting organization: ${error.message}`);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ORGANIZATIONS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadOrganizations() {
            const container = document.getElementById('organizationsList');

            try {
                const [orgsRes, contactsRes] = await Promise.all([
                    fetch(`${POCKETBASE_URL}/api/collections/organizations/records?perPage=500`, { headers: { 'Authorization': authToken } }),
                    fetch(`${POCKETBASE_URL}/api/collections/contacts/records?perPage=500`, { headers: { 'Authorization': authToken } })
                ]);

                const orgsData = await orgsRes.json();
                const contactsData = await contactsRes.json();

                allOrganizations = orgsData.items || [];
                allContacts = contactsData.items || [];

                // Sort orgs alphabetically (ignoring "The")
                allOrganizations.sort((a, b) => {
                    const nameA = a.name.replace(/^The\s+/i, '').toLowerCase();
                    const nameB = b.name.replace(/^The\s+/i, '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                // Populate Jump To dropdown
                const jumpToSelect = document.getElementById('orgJumpToName');
                jumpToSelect.innerHTML = '<option value="">ğŸ“ Jump to Organization...</option>' +
                    allOrganizations.map(o => `<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');

                renderOrganizationsList(allOrganizations);

            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        function renderOrganizationsList(orgs) {
            const container = document.getElementById('organizationsList');

            if (orgs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ›ï¸</div><h3>No Organizations Found</h3></div>`;
                return;
            }

            // Build contact lookup for phone numbers
            const contactsByOrg = {};
            allContacts.forEach(c => {
                if (!contactsByOrg[c.organization]) contactsByOrg[c.organization] = [];
                contactsByOrg[c.organization].push(c);
            });

            container.innerHTML = orgs.map(org => {
                const config = STATUS_CONFIG[org.status] || { icon: 'â“', badge: '', cardClass: '' };
                const touBadge = org.tou_flag && !org.tech_block_flag ? '<span class="badge badge-tou-flag">âš ï¸ TOU</span>' : '';
                const techBlockBadge = org.tech_block_flag ? '<span class="badge badge-tech-block">â›” BLOCKED</span>' : '';
                const techRenderingBadge = org.tech_rendering_flag ? '<span class="badge badge-js-render">âš™ï¸ JS-RENDER</span>' : '';
                const permissionDeniedBadge = org.permission_type === 'Denied' ? '<span class="badge badge-permission-denied">ğŸš« DECLINED</span>' : '';
                const duplicateBadge = org.duplicate_flag ? '<span class="badge badge-duplicate">ğŸ” DUPLICATE</span>' : '';

                // Find phone number
                const orgContacts = contactsByOrg[org.id] || [];
                let phoneNumber = 'No phone';
                const mainContact = orgContacts.find(c => c.contact_type === 'Main Contact' && c.phone);
                if (mainContact) {
                    phoneNumber = mainContact.phone;
                } else {
                    const otherContact = orgContacts.find(c => c.contact_type !== 'Leadership' && c.phone);
                    if (otherContact) phoneNumber = otherContact.phone;
                }

                const cardClass = org.tech_block_flag ? 'status-tech-blocked' : config.cardClass;

                // Contact count for display
                const contactCount = orgContacts.length;
                const contactBadge = contactCount === 0 
                    ? '<span class="badge badge-danger" style="background:#dc3545;color:white;">0 contacts</span>'
                    : `<span class="badge badge-success" style="background:#28a745;color:white;">${contactCount} contact${contactCount !== 1 ? 's' : ''}</span>`;

                let html = `<div class="card ${cardClass}" id="org-${org.id}">`;

                if (org.tech_block_flag) {
                    html += `<div class="info-box danger"><p>â›” <strong>Technical Block:</strong> This organization actively blocks automated requests.</p></div>`;
                } else if (org.tou_flag) {
                    html += `<div class="info-box warning"><p>âš ï¸ <strong>TOU Warning:</strong> ${escapeHtml(org.tou_notes) || 'May prohibit scraping'}</p></div>`;
                }
                if (org.permission_type === 'Denied') {
                    html += `<div class="info-box danger"><p>ğŸš« <strong>Permission Denied:</strong> Organization explicitly declined permission to scrape.</p></div>`;
                }
                if (org.tech_rendering_flag) {
                    html += `<div class="info-box" style="background: #e9ecef; border-color: #6c757d;"><p>âš™ï¸ <strong>Tech-Rendered Site:</strong> Requires headless browser (Puppeteer) to scrape events.</p></div>`;
                }
                if (org.duplicate_flag) {
                    html += `<div class="info-box" style="background: #f3e8ff; border-color: #6f42c1;"><p>ğŸ” <strong>Duplicate:</strong> This org is flagged as a duplicate.</p></div>`;
                }

                html += `
                    <h3><a href="#" onclick="openOrgProfile('${org.id}'); return false;">${escapeHtml(org.name)}</a> ${contactBadge} ${techBlockBadge} ${touBadge} ${permissionDeniedBadge} ${techRenderingBadge} ${duplicateBadge}</h3>
                    <p><strong>Status:</strong> <span class="badge ${config.badge}">${config.icon} ${org.status}</span></p>
                    ${org.description ? `<p><strong>Description:</strong> ${escapeHtml(org.description).substring(0, 150)}${org.description.length > 150 ? '...' : ''}</p>` : ''}
                    ${org.website ? `<p><strong>Website:</strong> <a href="${escapeHtml(org.website)}" target="_blank">${escapeHtml(org.website)}</a></p>` : ''}
                    <p><strong>Phone:</strong> ${escapeHtml(phoneNumber)}</p>
                    <div style="margin: 15px 0; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                        <div><label style="font-weight: 500; margin-right: 10px;">Change Status:</label>
                        <select class="inline-status-select" onchange="quickStatusChangeFromOrgs('${org.id}', this.value)">
                            ${Object.keys(STATUS_CONFIG).map(s => `<option value="${s}" ${org.status === s ? 'selected' : ''}>${STATUS_CONFIG[s].icon} ${s}</option>`).join('')}
                        </select></div>
                        <div><label style="font-weight: 500; margin-right: 10px;">Event Policy:</label>
                        <select class="inline-status-select" onchange="quickEventPolicyChangeFromOrgs('${org.id}', this.value)">
                            <option value="" ${!org.event_policy ? 'selected' : ''}>-- Not Set --</option>
                            <option value="accept_all" ${org.event_policy === 'accept_all' ? 'selected' : ''}>ğŸ”“ Accept All</option>
                            <option value="propose_events" ${org.event_policy === 'propose_events' ? 'selected' : ''}>ğŸ“‹ Propose Events</option>
                        </select></div>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-small" onclick="openOrgProfile('${org.id}', 'overview')">âœï¸ Edit Org</button>
                        <button class="btn btn-small btn-secondary" onclick="openOrgProfile('${org.id}', 'profileContacts')">ğŸ‘¤ Edit Contacts</button>
                        <button class="btn btn-small btn-info" onclick="openOrgProfile('${org.id}', 'statusHistory')">ğŸ“œ Edit Status</button>
                        <button class="btn btn-small" onclick="openOrgProfile('${org.id}', 'profileEvents')">ğŸ“… See Events</button>
                        <button class="btn btn-small btn-warning" onclick="openScanModalForOrg('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">ğŸ” Scan</button>
                        <button class="btn btn-small btn-danger" onclick="deleteOrgFromList('${org.id}', '${escapeHtml(org.name).replace(/'/g, "\\'")}')">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>`;
                return html;
            }).join('');
        }

        async function quickStatusChangeFromOrgs(orgId, newStatus) {
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ status: newStatus })
                });
                showMessage('organizationsMessage', `âœ… Status changed to "${newStatus}"`, 'success');
                loadOrganizations();
            } catch (error) { alert('Error: ' + error.message); }
        }

        async function quickEventPolicyChangeFromOrgs(orgId, newPolicy) {
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify({ event_policy: newPolicy || null })
                });
                const policyLabel = newPolicy === 'accept_all' ? 'ğŸ”“ Accept All' : newPolicy === 'propose_events' ? 'ğŸ“‹ Propose Events' : 'Not Set';
                showMessage('organizationsMessage', `âœ… Event policy set to "${policyLabel}"`, 'success');
            } catch (error) { alert('Error: ' + error.message); }
        }

        /**
         * Delete organization from the list view
         */
        async function deleteOrgFromList(orgId, orgName) {
            // Check for associated events and contacts
            let eventCount = 0;
            let contactCount = 0;

            try {
                const eventsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records?filter=(organization='${orgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (eventsRes.ok) {
                    const eventsData = await eventsRes.json();
                    eventCount = eventsData.totalItems || 0;
                }

                const contactsRes = await fetch(
                    `${POCKETBASE_URL}/api/collections/contacts/records?filter=(organization='${orgId}')&perPage=1`,
                    { headers: { 'Authorization': authToken } }
                );
                if (contactsRes.ok) {
                    const contactsData = await contactsRes.json();
                    contactCount = contactsData.totalItems || 0;
                }
            } catch (error) {
                console.error('Error checking related records:', error);
            }

            // Build confirmation message
            let confirmMsg = `ğŸ—‘ï¸ DELETE ORGANIZATION\n\n`;
            confirmMsg += `Are you sure you want to delete "${orgName}"?\n\n`;

            if (eventCount > 0 || contactCount > 0) {
                confirmMsg += `âš ï¸ WARNING: This org has associated records:\n`;
                if (eventCount > 0) confirmMsg += `   â€¢ ${eventCount} event(s)\n`;
                if (contactCount > 0) confirmMsg += `   â€¢ ${contactCount} contact(s)\n`;
                confirmMsg += `\nThese will become orphaned (not deleted).\n`;
            }

            confirmMsg += `\nThis action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Second confirmation
            const typeToConfirm = prompt(`Type the organization name to confirm deletion:\n\n"${orgName}"`);
            if (typeToConfirm !== orgName) {
                alert('âŒ Deletion cancelled - name did not match');
                return;
            }

            // Perform deletion
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/organizations/records/${orgId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Authorization': authToken }
                    }
                );

                if (response.ok) {
                    showMessage('organizationsMessage', `âœ… Organization "${orgName}" deleted successfully`, 'success');
                    loadOrganizations(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert(`âŒ Delete failed: ${JSON.stringify(error)}`);
                }
            } catch (error) {
                alert(`âŒ Error deleting organization: ${error.message}`);
            }
        }

        function filterOrgsByName() {
            const searchTerm = document.getElementById('orgSearchBox').value.toLowerCase();
            const filtered = allOrganizations.filter(org => 
                org.name.toLowerCase().includes(searchTerm)
            );
            renderOrganizationsList(filtered);
        }

        function jumpToOrgByName() {
            const orgId = document.getElementById('orgJumpToName').value;
            if (orgId) {
                openOrgProfile(orgId);
                document.getElementById('orgJumpToName').value = '';
            }
        }

        function filterOrgsByStatus() {
            const status = document.getElementById('orgFilterByStatus').value;
            if (status) {
                document.getElementById('orgFilterByStatus').value = '';
                document.getElementById('filterByStatus').value = status;
                switchTab('byStatus');
            }
        }

        async function filterOrgsByContacts() {
            const filter = document.getElementById('orgFilterByContacts').value;
            if (!filter) {
                renderOrganizationsList(allOrganizations);
                return;
            }

            // Refresh contacts data to ensure we have latest
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/contacts/records?perPage=500`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                allContacts = data.items || [];
            } catch (error) {
                console.error('Failed to refresh contacts:', error);
            }

            // Build contact lookup
            const orgsWithContacts = new Set(allContacts.map(c => c.organization));
            
            let filtered;
            if (filter === 'none') {
                filtered = allOrganizations.filter(o => !orgsWithContacts.has(o.id));
            } else if (filter === 'has') {
                filtered = allOrganizations.filter(o => orgsWithContacts.has(o.id));
            }
            
            renderOrganizationsList(filtered);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTACTS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadContacts() {
            const container = document.getElementById('contactsList');
            const filterSelect = document.getElementById('filterContactOrg');
            const selectedOrg = filterSelect.value;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/contacts/records?expand=organization&perPage=500&sort=organization,name`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                let contacts = data.items || [];

                // Populate org filter dropdown (only on first load or if empty)
                if (filterSelect.options.length <= 2) {
                    const orgsInContacts = new Map();
                    contacts.forEach(c => {
                        if (c.organization && c.expand?.organization) {
                            orgsInContacts.set(c.organization, c.expand.organization.name);
                        }
                    });
                    
                    // Sort orgs alphabetically
                    const sortedOrgs = [...orgsInContacts.entries()].sort((a, b) => a[1].localeCompare(b[1]));
                    
                    // Add org options
                    sortedOrgs.forEach(([orgId, orgName]) => {
                        const option = document.createElement('option');
                        option.value = orgId;
                        option.textContent = `ğŸ¢ ${orgName}`;
                        filterSelect.appendChild(option);
                    });
                }

                // Apply filter
                if (selectedOrg === 'none') {
                    contacts = contacts.filter(c => !c.organization);
                } else if (selectedOrg) {
                    contacts = contacts.filter(c => c.organization === selectedOrg);
                }

                if (contacts.length === 0) {
                    const message = selectedOrg === 'none' ? 'No contacts without an organization' : 
                                   selectedOrg ? 'No contacts for this organization' : 'No Contacts Yet';
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ‘¤</div><h3>${message}</h3></div>`;
                    return;
                }

                container.innerHTML = contacts.map(c => {
                    const orgName = c.expand?.organization?.name || '<span style="color:#dc3545;">No Org</span>';
                    return `
                        <div class="contact-card">
                            <h5>${escapeHtml(c.name || '(No Name)')} ${c.contact_type ? `<span class="badge">${escapeHtml(c.contact_type)}</span>` : ''}</h5>
                            <p><strong>Organization:</strong> ${c.expand?.organization ? escapeHtml(orgName) : orgName}</p>
                            ${c.title ? `<p><strong>Title:</strong> ${escapeHtml(c.title)}</p>` : ''}
                            ${c.email ? `<p><strong>Email:</strong> <a href="mailto:${escapeHtml(c.email)}">${escapeHtml(c.email)}</a></p>` : ''}
                            ${c.phone ? `<p><strong>Phone:</strong> ${escapeHtml(c.phone)}</p>` : ''}
                            ${c.data_completeness ? `<p><strong>Completeness:</strong> <span class="badge">${escapeHtml(c.data_completeness)}</span></p>` : ''}
                            <div class="contact-actions">
                                <button class="btn btn-small" onclick="editContact('${c.id}')">âœï¸ Edit</button>
                                <button class="btn btn-small btn-danger" onclick="deleteContact('${c.id}', false)">ğŸ—‘ï¸ Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        // Store orgs for email domain matching
        let contactModalOrgs = [];

        async function openAddContactModal() {
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records?sort=name&perPage=500`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                contactModalOrgs = data.items || [];
                
                document.getElementById('contactOrg').innerHTML = '<option value="">-- Select Organization --</option>' +
                    contactModalOrgs.map(o => `<option value="${o.id}" data-website="${escapeHtml(o.website || '')}">${escapeHtml(o.name)}</option>`).join('');
                
                document.getElementById('addContactForm').reset();
                document.getElementById('emailOrgSuggestion').style.display = 'none';
                openModal('addContactModal');
            } catch (error) {
                alert('Error loading organizations: ' + error.message);
            }
        }

        /**
         * Auto-suggest organization based on email domain
         */
        function autoSuggestOrgFromEmail(email) {
            const suggestionEl = document.getElementById('emailOrgSuggestion');
            const orgSelect = document.getElementById('contactOrg');
            
            // Only suggest if no org is currently selected
            if (orgSelect.value) {
                suggestionEl.style.display = 'none';
                return;
            }
            
            if (!email || !email.includes('@')) {
                suggestionEl.style.display = 'none';
                return;
            }
            
            // Extract domain from email
            const emailDomain = email.split('@')[1]?.toLowerCase().trim();
            if (!emailDomain) {
                suggestionEl.style.display = 'none';
                return;
            }
            
            // Extract core domain (remove TLD)
            const emailCore = emailDomain.split('.').slice(0, -1).join('.') || emailDomain.split('.')[0];
            
            // Try to match to an organization
            let matchedOrg = null;
            let matchType = '';
            
            for (const org of contactModalOrgs) {
                if (!org.website) continue;
                
                // Extract domain from org website
                let orgDomain = org.website.toLowerCase()
                    .replace(/^https?:\/\//, '')
                    .replace(/^www\./, '')
                    .split('/')[0];
                
                // Exact match
                if (orgDomain === emailDomain) {
                    matchedOrg = org;
                    matchType = 'exact';
                    break;
                }
                
                // Core match
                const orgCore = orgDomain.split('.').slice(0, -1).join('.') || orgDomain.split('.')[0];
                if (orgCore && emailCore && orgCore === emailCore) {
                    matchedOrg = org;
                    matchType = 'core';
                    break;
                }
            }
            
            if (matchedOrg) {
                suggestionEl.innerHTML = `âœ¨ Auto-matched to: <strong>${escapeHtml(matchedOrg.name)}</strong> <button type="button" class="btn btn-small btn-success" style="padding: 2px 8px; font-size: 11px;" onclick="selectSuggestedOrg('${matchedOrg.id}')">Select</button>`;
                suggestionEl.style.display = 'block';
            } else {
                suggestionEl.style.display = 'none';
            }
        }
        
        function selectSuggestedOrg(orgId) {
            document.getElementById('contactOrg').value = orgId;
            document.getElementById('emailOrgSuggestion').style.display = 'none';
        }

        document.getElementById('addContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                organization: document.getElementById('contactOrg').value,
                name: document.getElementById('contactName').value,
                title: document.getElementById('contactTitle').value,
                email: document.getElementById('contactEmail').value,
                phone: document.getElementById('contactPhone').value,
                contact_type: document.getElementById('contactType').value,
                notes: document.getElementById('contactNotes').value,
                last_verified: new Date().toISOString()
            };
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/contacts/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(data)
                });
                closeModal('addContactModal');
                if (currentOrgId) { loadProfileContacts(); showMessage('profileMessage', 'âœ… Contact added!', 'success'); }
                else { loadContacts(); alert('âœ… Contact added!'); }
            } catch (error) { alert('Error: ' + error.message); }
        });

        async function editContact(id) {
            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/contacts/records/${id}?expand=organization`, { headers: { 'Authorization': authToken } });
                const contact = await response.json();
                document.getElementById('editContactId').value = contact.id;
                document.getElementById('editContactOrgName').value = contact.expand?.organization?.name || 'Unknown';
                document.getElementById('editContactName').value = contact.name || '';
                document.getElementById('editContactTitle').value = contact.title || '';
                document.getElementById('editContactEmail').value = contact.email || '';
                document.getElementById('editContactPhone').value = contact.phone || '';
                document.getElementById('editContactType').value = contact.contact_type || '';
                document.getElementById('editContactNotes').value = contact.notes || '';
                openModal('editContactModal');
            } catch (error) { alert('Error loading contact: ' + error.message); }
        }

        document.getElementById('editContactForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editContactId').value;
            const data = {
                name: document.getElementById('editContactName').value,
                title: document.getElementById('editContactTitle').value,
                email: document.getElementById('editContactEmail').value,
                phone: document.getElementById('editContactPhone').value,
                contact_type: document.getElementById('editContactType').value,
                notes: document.getElementById('editContactNotes').value,
                last_verified: new Date().toISOString()
            };
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/contacts/records/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': authToken },
                    body: JSON.stringify(data)
                });
                closeModal('editContactModal');
                if (currentOrgId) { loadProfileContacts(); showMessage('profileMessage', 'âœ… Contact updated!', 'success'); }
                else { loadContacts(); alert('âœ… Contact updated!'); }
            } catch (error) { alert('Error: ' + error.message); }
        });

        async function deleteContact(id, isFromProfile) {
            if (!confirm('Delete this contact?')) return;
            try {
                await fetch(`${POCKETBASE_URL}/api/collections/contacts/records/${id}`, { method: 'DELETE', headers: { 'Authorization': authToken } });
                if (isFromProfile) { loadProfileContacts(); showMessage('profileMessage', 'ğŸ—‘ï¸ Contact deleted', 'info'); }
                else { loadContacts(); }
            } catch (error) { alert('Error: ' + error.message); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENTS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadEvents() {
            const container = document.getElementById('eventsList');
            const orgFilter = document.getElementById('filterEventOrg').value;
            const statusFilter = document.getElementById('filterEventStatus').value;
            const sortBy = document.getElementById('sortEvents').value || '-start_date';
            
            console.log('ğŸ” loadEvents called');
            console.log('   orgFilter:', orgFilter);
            console.log('   statusFilter:', statusFilter);
            console.log('   sortBy:', sortBy);

            try {
                // Load organization filter dropdown
                if (document.getElementById('filterEventOrg').options.length <= 1) {
                    const orgsRes = await fetch(`${POCKETBASE_URL}/api/collections/organizations/records?sort=name&perPage=500`, { headers: { 'Authorization': authToken } });
                    const orgsData = await orgsRes.json();
                    document.getElementById('filterEventOrg').innerHTML = '<option value="">All Organizations</option>' +
                        (orgsData.items || []).map(o => `<option value="${o.id}">${escapeHtml(o.name)}</option>`).join('');
                }

                // Load all topic_icons for lookup
                const iconsRes = await fetch(`${POCKETBASE_URL}/api/collections/topic_icons/records?perPage=500`, { headers: { 'Authorization': authToken } });
                const iconsData = await iconsRes.json();
                const iconMap = {};
                (iconsData.items || []).forEach(icon => {
                    if (icon.topic_combination && icon.icon_file) {
                        iconMap[icon.topic_combination] = {
                            id: icon.id,
                            file: icon.icon_file
                        };
                    }
                });

                // Build filter
                let filterParts = [];
                if (orgFilter) filterParts.push(`organization='${orgFilter}'`);
                
                // Handle event_status filter - 'nominated' includes null/empty (legacy events)
                if (statusFilter === 'nominated') {
                    // Match 'nominated' OR empty string OR null (events created before event_status field)
                    filterParts.push(`(event_status='nominated' || event_status='' || event_status=null)`);
                } else if (statusFilter) {
                    filterParts.push(`event_status='${statusFilter}'`);
                }
                
                let filter = filterParts.length > 0 ? `&filter=${encodeURIComponent('(' + filterParts.join(' && ') + ')')}` : '';
                
                console.log('   filterParts:', filterParts);
                console.log('   filter:', filter);
                
                // Determine API sort (use -start_date for org sorts, we'll sort client-side)
                const apiSort = sortBy.startsWith('org-') ? '-start_date' : sortBy;
                
                // Load events with topics expanded
                const apiUrl = `${POCKETBASE_URL}/api/collections/events/records?sort=${apiSort}&expand=organization,topics&perPage=100${filter}`;
                console.log('   API URL:', apiUrl);
                
                const response = await fetch(apiUrl, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                let events = data.items || [];
                
                console.log('   Events found:', events.length);
                if (events.length > 0) {
                    console.log('   First event org:', events[0].organization);
                }
                
                // Client-side sort for organization name
                if (sortBy === 'org-asc') {
                    events.sort((a, b) => {
                        const nameA = (a.expand?.organization?.name || '').toLowerCase();
                        const nameB = (b.expand?.organization?.name || '').toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                } else if (sortBy === 'org-desc') {
                    events.sort((a, b) => {
                        const nameA = (a.expand?.organization?.name || '').toLowerCase();
                        const nameB = (b.expand?.organization?.name || '').toLowerCase();
                        return nameB.localeCompare(nameA);
                    });
                }

                if (events.length === 0) {
                    let filterDesc = [];
                    if (statusFilter) filterDesc.push(`status "${statusFilter}"`);
                    if (orgFilter) {
                        const orgName = document.getElementById('filterEventOrg').selectedOptions[0]?.text || 'selected org';
                        filterDesc.push(`org "${orgName}"`);
                    }
                    const filterMsg = filterDesc.length > 0 ? `<p style="color: #666;">No events match: ${filterDesc.join(' + ')}</p><p style="color: #666; font-size: 12px;">Try changing the filters above.</p>` : '';
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“…</div><h3>No Events Found</h3>${filterMsg}</div>`;
                    return;
                }

                container.innerHTML = events.map(e => {
                    const orgName = e.expand?.organization?.name || 'Unknown';
                    const startDate = e.start_date ? new Date(e.start_date).toLocaleDateString() : 'TBD';
                    
                    // Event status badge
                    const eventStatus = e.event_status || 'nominated';
                    const statusBadge = eventStatus === 'approved' 
                        ? '<span class="badge badge-live">âœ… Approved</span>'
                        : eventStatus === 'rejected'
                        ? '<span class="badge badge-danger">âŒ Rejected</span>'
                        : '<span class="badge badge-warning">ğŸ“‹ Nominated</span>';
                    
                    // Action buttons based on status
                    const actionButtons = eventStatus === 'nominated'
                        ? `<div class="event-actions">
                               <button class="btn btn-small btn-success" onclick="updateEventStatus('${e.id}', 'approved')">âœ… Accept</button>
                               <button class="btn btn-small btn-danger" onclick="updateEventStatus('${e.id}', 'rejected')">âŒ Reject</button>
                           </div>`
                        : eventStatus === 'approved'
                        ? `<div class="event-actions">
                               <button class="btn btn-small btn-danger" onclick="updateEventStatus('${e.id}', 'rejected')">âŒ Reject</button>
                               <button class="btn btn-small btn-secondary" onclick="updateEventStatus('${e.id}', 'nominated')">â†©ï¸ Back to Review</button>
                           </div>`
                        : `<div class="event-actions">
                               <button class="btn btn-small btn-success" onclick="updateEventStatus('${e.id}', 'approved')">âœ… Accept</button>
                               <button class="btn btn-small btn-secondary" onclick="updateEventStatus('${e.id}', 'nominated')">â†©ï¸ Back to Review</button>
                           </div>`;
                    
                    // Get topics and create combination key (4-part format)
                    // Format: "Topics|Regions|Countries|TransnationalOrgs"
                    const topicNames = (e.topics || []).slice().sort();
                    const regionNames = (e.regions || []).slice().sort();
                    const countryNames = (e.countries || []).slice().sort();
                    const orgNames = (e.transnational_orgs || []).slice().sort(); // events uses plural
                    const topicCombination = `${topicNames.join(',')}|${regionNames.join(',')}|${countryNames.join(',')}|${orgNames.join(',')}`;
                    
                    // Look up icon
                    const iconInfo = iconMap[topicCombination];
                    const iconHtml = iconInfo 
                        ? `<img src="${POCKETBASE_URL}/api/files/topic_icons/${iconInfo.id}/${iconInfo.file}?thumb=120x194" alt="${escapeHtml(topicCombination)}" loading="lazy">`
                        : `<div class="no-icon">ğŸ“…</div>`;
                    
                    // Icon status indicator
                    const iconStatus = iconInfo 
                        ? `<span class="icon-found">âœ… Icon matched</span>`
                        : `<span class="icon-missing">âŒ No icon found</span>`;
                    
                    // Topic badges
                    const topicBadges = topicNames.length > 0 
                        ? `<div class="event-meta-row"><strong>Topics:</strong> ${topicNames.map(t => `<span class="event-topic-badge">${escapeHtml(t)}</span>`).join('')}</div>`
                        : '';
                    
                    // Region badges
                    const regionBadges = regionNames.length > 0 
                        ? `<div class="event-meta-row"><strong>Regions:</strong> ${regionNames.map(r => `<span class="event-region-badge">${escapeHtml(r)}</span>`).join('')}</div>`
                        : '';
                    
                    // Country badges
                    const countryBadges = countryNames.length > 0 
                        ? `<div class="event-meta-row"><strong>Countries:</strong> ${countryNames.map(c => `<span class="event-country-badge">${escapeHtml(c)}</span>`).join('')}</div>`
                        : '';
                    
                    // Transnational org badges
                    const orgBadges = orgNames.length > 0 
                        ? `<div class="event-meta-row"><strong>Orgs:</strong> ${orgNames.map(o => `<span class="event-org-badge">${escapeHtml(o)}</span>`).join('')}</div>`
                        : '';

                    return `
                        <div class="card" id="event-${e.id}">
                            <div class="event-with-icon">
                                <div class="event-icon">
                                    ${iconHtml}
                                    <div class="icon-status-indicator">${iconStatus}</div>
                                </div>
                                <div class="event-details">
                                    <h3>${escapeHtml(e.title)} ${statusBadge}</h3>
                                    <p><strong>Organization:</strong> ${escapeHtml(orgName)}</p>
                                    <p><strong>Date:</strong> ${startDate}</p>
                                    ${e.location ? `<p><strong>Location:</strong> ${escapeHtml(e.location)}</p>` : ''}
                                    ${e.url ? `<p><a href="${escapeHtml(e.url)}" target="_blank">View Event â†’</a></p>` : ''}
                                    <div class="event-metadata">
                                        ${topicBadges}
                                        ${regionBadges}
                                        ${countryBadges}
                                        ${orgBadges}
                                    </div>
                                    <div class="icon-key-debug" title="Icon lookup key"><small>ğŸ”‘ ${escapeHtml(topicCombination)}</small></div>
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }
        
        /**
         * Update event status (approve/reject/nominate)
         * Safety gate: Cannot approve events unless org is Permission Granted or Live
         */
        async function updateEventStatus(eventId, newStatus) {
            const statusFilter = document.getElementById('filterEventStatus').value;
            
            // Safety gate: If approving, verify org status first
            if (newStatus === 'approved') {
                try {
                    // Fetch event with organization expanded
                    const eventRes = await fetch(
                        `${POCKETBASE_URL}/api/collections/events/records/${eventId}?expand=organization`,
                        { headers: { 'Authorization': authToken } }
                    );
                    const eventData = await eventRes.json();
                    const orgStatus = eventData.expand?.organization?.status;
                    const orgName = eventData.expand?.organization?.name || 'Unknown';
                    
                    // Only allow approval if org is Permission Granted or Live
                    const allowedStatuses = ['Permission Granted (Not Live)', 'Live (Scraping Active)'];
                    
                    if (!allowedStatuses.includes(orgStatus)) {
                        alert(
                            `â›” Cannot approve this event!\n\n` +
                            `Organization: ${orgName}\n` +
                            `Current Org Status: ${orgStatus || 'Unknown'}\n\n` +
                            `Events can only be approved when the organization status is:\n` +
                            `â€¢ Permission Granted (Not Live)\n` +
                            `â€¢ Live (Scraping Active)\n\n` +
                            `Please update the organization status first.`
                        );
                        return;
                    }
                } catch (error) {
                    alert(`âŒ Error checking organization status: ${error.message}`);
                    return;
                }
            }
            
            try {
                const response = await fetch(
                    `${POCKETBASE_URL}/api/collections/events/records/${eventId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken
                        },
                        body: JSON.stringify({ event_status: newStatus })
                    }
                );
                
                if (response.ok) {
                    console.log(`âœ… Event ${eventId} updated to ${newStatus}`);
                    
                    // If we have a filter active and the new status doesn't match,
                    // fade out and remove the card
                    if (statusFilter && statusFilter !== newStatus) {
                        const card = document.getElementById(`event-${eventId}`);
                        if (card) {
                            card.style.transition = 'opacity 0.3s, transform 0.3s';
                            card.style.opacity = '0';
                            card.style.transform = 'translateX(50px)';
                            setTimeout(() => card.remove(), 300);
                        }
                    } else {
                        // No filter or status still matches - reload to update badges
                        loadEvents();
                    }
                } else {
                    const err = await response.json();
                    alert(`âŒ Error updating event: ${JSON.stringify(err)}`);
                }
            } catch (error) {
                alert(`âŒ Error: ${error.message}`);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ICONS TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadIcons() {
            const container = document.getElementById('iconsList');
            const statsContainer = document.getElementById('iconStats');
            const filterStatus = document.getElementById('filterIconStatus').value;

            try {
                const response = await fetch(`${POCKETBASE_URL}/api/collections/topic_icons/records?sort=topic_combination&perPage=200`, { headers: { 'Authorization': authToken } });
                const data = await response.json();
                const icons = data.items || [];

                // Calculate stats
                const withIcon = icons.filter(i => i.icon_file).length;
                const withoutIcon = icons.length - withIcon;

                statsContainer.innerHTML = `
                    <div class="icon-stat"><h4>${icons.length}</h4><p>Total Combinations</p></div>
                    <div class="icon-stat success"><h4>${withIcon}</h4><p>âœ… Has Icon</p></div>
                    <div class="icon-stat warning"><h4>${withoutIcon}</h4><p>âŒ Missing Icon</p></div>
                `;

                // Filter icons
                let filtered = icons;
                if (filterStatus === 'has-icon') {
                    filtered = icons.filter(i => i.icon_file);
                } else if (filterStatus === 'no-icon') {
                    filtered = icons.filter(i => !i.icon_file);
                }

                if (filtered.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ–¼ï¸</div><h3>No Icons Found</h3><p>Try changing the filter above.</p></div>`;
                    return;
                }

                container.innerHTML = `<div class="icon-grid">${filtered.map(icon => {
                    const hasIcon = !!icon.icon_file;
                    const topics = icon.topic_combination || 'Unknown';
                    const imgUrl = hasIcon 
                        ? `${POCKETBASE_URL}/api/files/topic_icons/${icon.id}/${icon.icon_file}?thumb=160x260`
                        : '';
                    
                    return `
                        <div class="icon-card">
                            ${hasIcon 
                                ? `<img src="${imgUrl}" alt="${escapeHtml(topics)}" loading="lazy">`
                                : `<div style="width: 80px; height: 130px; background: #f0f0f0; border-radius: 8px; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px;">â“</div>`
                            }
                            <div class="icon-topics">${escapeHtml(topics)}</div>
                            <div class="icon-status ${hasIcon ? 'has-icon' : 'no-icon'}">${hasIcon ? 'âœ… Has Icon' : 'âŒ Missing'}</div>
                        </div>
                    `;
                }).join('')}</div>`;
            } catch (error) {
                container.innerHTML = `<div class="message error">âŒ Error: ${error.message}</div>`;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SCAN ORG MODAL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Open the Scan Org modal and populate with current org name
         */
        function openScanOrgModal() {
            if (!currentOrg) {
                alert('âŒ No organization selected');
                return;
            }
            
            // Reset checkboxes
            document.getElementById('scanForceContacts').checked = false;
            document.getElementById('scanCommandCopied').style.display = 'none';
            
            // Update command with org name
            updateScanCommand();
            
            // Open modal
            openModal('scanOrgModal');
        }
        
        /**
         * Open the Scan Org modal for a specific org (from org cards in list view)
         */
        function openScanModalForOrg(orgId, orgName) {
            // Set a temporary currentOrg for the modal to use
            currentOrg = { id: orgId, name: orgName };
            
            // Reset checkboxes
            document.getElementById('scanForceContacts').checked = false;
            document.getElementById('scanCommandCopied').style.display = 'none';
            
            // Update command with org name
            updateScanCommand();
            
            // Open modal
            openModal('scanOrgModal');
        }
        
        /**
         * Update the scan command based on selected options
         */
        function updateScanCommand() {
            const orgName = currentOrg ? currentOrg.name : 'Organization Name';
            const forceContacts = document.getElementById('scanForceContacts').checked;
            
            // Build command
            let command = `node scrapers/adhoc-scanner.js --org "${orgName}"`;
            
            if (forceContacts) {
                command += ' --force-contacts';
            }
            
            document.getElementById('scanCommandText').textContent = command;
            document.getElementById('scanCommandCopied').style.display = 'none';
        }
        
        /**
         * Copy the scan command to clipboard
         */
        async function copyScanCommand() {
            const command = document.getElementById('scanCommandText').textContent;
            
            try {
                await navigator.clipboard.writeText(command);
                document.getElementById('scanCommandCopied').style.display = 'block';
                
                // Hide the message after 3 seconds
                setTimeout(() => {
                    document.getElementById('scanCommandCopied').style.display = 'none';
                }, 3000);
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = command;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                document.getElementById('scanCommandCopied').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('scanCommandCopied').style.display = 'none';
                }, 3000);
            }
        }

        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message ${type}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
        });
    </script>
</body>
</html>
