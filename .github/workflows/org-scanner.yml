# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Organization Scanner - Weekly Scheduled Workflow
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# Runs org-scanner.js weekly to re-scan organizations for:
# - TOU restriction changes
# - Technical block changes
# - JavaScript rendering detection
# - Updated POC info
#
# Schedule: Sundays at 4:59 AM UTC (11:59 PM EST Saturday)
#
# Scans all orgs EXCEPT "Rejected by Mission"
# INCLUDES "Rejected by Org" (re-scans in case TOU policies changed)
#
# Cost: FREE (no external APIs, just direct site fetching)
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: Organization Scanner (Weekly)

on:
  # Run every Sunday at 4:59 AM UTC (11:59 PM EST Saturday)
  schedule:
    - cron: '59 4 * * 0'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      status_filter:
        description: 'Status to scan (or "all-active" for default)'
        required: false
        default: 'all-active'
      limit:
        description: 'Max orgs to process (optional, for testing)'
        required: false
        default: ''

jobs:
  scan-organizations:
    runs-on: ubuntu-latest
    
    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Setup
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ฅ Checkout repository
        uses: actions/checkout@v4
      
      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ๐ Install dependencies
        run: npm install
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Create .env file from GitHub Secrets
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ Create .env file
        run: |
          cat << EOF > .env
          POCKETBASE_URL=${{ secrets.POCKETBASE_URL }}
          POCKETBASE_ADMIN_EMAIL=${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          POCKETBASE_ADMIN_PASSWORD=${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Run Organization Scanner
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ Run organization scanner
        run: |
          LIMIT="${{ github.event.inputs.limit }}"
          
          # Run scan-and-scrape with --approved --scan-only flags
          # This scans all orgs except "Rejected by Mission"
          # Includes "Rejected by Org" to check if TOU policies changed
          if [ -n "$LIMIT" ]; then
            node scrapers/scan-and-scrape-all-live-orgs.js --approved --scan-only --limit $LIMIT
          else
            node scrapers/scan-and-scrape-all-live-orgs.js --approved --scan-only
          fi
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Cleanup
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐งน Remove .env file
        if: always()
        run: rm -f .env
