name: Generate Topic Icons Daily
on:
  schedule:
    # Run daily at 12:00 AM EST (05:00 UTC) - 30 min after scrape-events.yml
    - cron: '0 5 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      dalle_style:
        description: 'DALL-E style (vivid=dramatic, natural=realistic)'
        required: false
        default: 'vivid'
        type: choice
        options:
          - vivid
          - natural
      dalle_quality:
        description: 'DALL-E quality (hd costs 2x but more detail)'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - hd
      max_items:
        description: 'Max icons to generate (default: 25)'
        required: false
        default: '25'

jobs:
  generate-icons:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install root dependencies
        run: npm install
      
      - name: Install icon-worker dependencies
        run: cd icon-worker && npm install
      
      - name: Enrich events with AI topics
        env:
          POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
          POCKETBASE_ADMIN_EMAIL: ${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          POCKETBASE_ADMIN_PASSWORD: ${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: node scrapers/enrich-events.js
      
      - name: Create topic_icons records for approved events
        env:
          POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
          POCKETBASE_ADMIN_EMAIL: ${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          POCKETBASE_ADMIN_PASSWORD: ${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_IMAGE_MODEL: dall-e-3
        run: cd icon-worker && node src/create-topic-icon-records.js
      
      - name: Generate icons via DALL-E 3
        env:
          POCKETBASE_URL: ${{ secrets.POCKETBASE_URL }}
          POCKETBASE_ADMIN_EMAIL: ${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          POCKETBASE_ADMIN_PASSWORD: ${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_IMAGE_MODEL: dall-e-3
          # NEW: Style and quality settings for variety
          DALLE_STYLE: ${{ github.event.inputs.dalle_style || 'vivid' }}
          DALLE_QUALITY: ${{ github.event.inputs.dalle_quality || 'standard' }}
          MAX_ITEMS: ${{ github.event.inputs.max_items || '25' }}
          MAX_ATTEMPTS: 6
          ENABLE_DOWNSCALE_AUDIT: true
          DOWNSCALE_MIN_FOREGROUND_RATIO: 0.03
          DOWNSCALE_MIN_STDDEV: 18
        run: cd icon-worker && node src/generate-topic-icons.js
