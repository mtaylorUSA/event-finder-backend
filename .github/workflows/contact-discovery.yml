# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Contact Discovery - Daily Scheduled Workflow
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
#
# Runs contact-discovery.js daily to find contact info for orgs
# Uses Google Search API (100 free queries/day)
# Auto-batches by priority: Clean โ TOU โ Tech Block โ Tech Rendering
#
# Schedule: Daily at 8:00 AM UTC (3:00 AM EST)
# This runs after Google quota resets at midnight Pacific (3:00 AM EST)
#
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: Contact Discovery (Daily)

on:
  # Run daily at 8:00 AM UTC (3:00 AM EST)
  schedule:
    - cron: '0 8 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      batch:
        description: 'Batch number (1-4) or "auto" for automatic'
        required: false
        default: 'auto'
      limit:
        description: 'Max orgs to process (optional)'
        required: false
        default: ''

jobs:
  discover-contacts:
    runs-on: ubuntu-latest
    
    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Setup
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ฅ Checkout repository
        uses: actions/checkout@v4
      
      - name: ๐ฆ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ๐ Install dependencies
        run: npm install
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Create .env file from GitHub Secrets
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ Create .env file
        run: |
          cat << EOF > .env
          POCKETBASE_URL=${{ secrets.POCKETBASE_URL }}
          POCKETBASE_ADMIN_EMAIL=${{ secrets.POCKETBASE_ADMIN_EMAIL }}
          POCKETBASE_ADMIN_PASSWORD=${{ secrets.POCKETBASE_ADMIN_PASSWORD }}
          GOOGLE_SEARCH_API_KEY=${{ secrets.GOOGLE_SEARCH_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID=${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Run Contact Discovery
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐ Check batch status
        run: node scrapers/contact-discovery.js --status
      
      - name: ๐ Run contact discovery
        run: |
          # Determine batch to run
          BATCH="${{ github.event.inputs.batch }}"
          LIMIT="${{ github.event.inputs.limit }}"
          
          if [ -z "$BATCH" ] || [ "$BATCH" = "auto" ]; then
            # Auto mode: run batches in priority order
            # Try batch 1 first, if complete try batch 2, etc.
            for b in 1 2 3 4; do
              echo "๐ Checking batch $b..."
              OUTPUT=$(node scrapers/contact-discovery.js --batch $b 2>&1)
              echo "$OUTPUT"
              
              # If batch has orgs to process, we're done
              if echo "$OUTPUT" | grep -q "Orgs processed:"; then
                break
              fi
              
              # If batch is complete, try next
              if echo "$OUTPUT" | grep -q "No orgs remaining"; then
                echo "โ Batch $b complete, trying next..."
                continue
              fi
            done
          else
            # Manual mode: run specific batch
            if [ -n "$LIMIT" ]; then
              node scrapers/contact-discovery.js --batch $BATCH --limit $LIMIT
            else
              node scrapers/contact-discovery.js --batch $BATCH
            fi
          fi
      
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # Cleanup
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      
      - name: ๐งน Remove .env file
        if: always()
        run: rm -f .env
